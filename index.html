<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starbite Super App</title>
    <style>
        /* === WRAPPER STYLES === */
        :root { --bg: #1a1a1a; --nav: #222; --text: #888; --active: #fff; }
        body.dark-mode { --bg: #000; --nav: #111; --text: #aaa; --active: #ccc; }
        
        body { 
            margin: 0; padding: 0; font-family: sans-serif; 
            background: var(--bg); display: flex; flex-direction: column; 
            height: 100dvh; overflow: hidden; transition: 0.3s;
        }
        
        /* Navigation Bar */
        .app-nav {
            background: var(--nav); border-bottom: 1px solid #333;
            display: flex; justify-content: center; padding: 0; height: 50px;
            flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10; visibility: hidden; 
        }

        .nav-btn {
            background: transparent; border: none; color: var(--text);
            padding: 0 10px; font-size: 13px; font-weight: bold; cursor: pointer;
            border-bottom: 3px solid transparent; transition: 0.3s; flex: 1;
            display: flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap;
        }
        .nav-btn:hover { background: #333; color: #ccc; }
        .nav-btn.active { color: var(--active); background: #333; border-bottom: 3px solid #007bff; }

        /* Iframe Containers */
        .frame-container { flex: 1; position: relative; background: white; width: 100%; overflow: hidden; visibility: hidden; }
        iframe { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; display: none; }
        iframe.active { display: block; }

        /* === LOGIN SCREEN === */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 99999; display: flex;
            flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .login-box { background: #222; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px; }
        .login-input { width: 100%; padding: 15px; margin: 20px 0; font-size: 24px; text-align: center; border-radius: 8px; background: #333; color: white; border: 1px solid #444; letter-spacing: 5px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .login-error { color: #ff4444; margin-top: 10px; display: none; }

        /* === FLOATING CALCULATOR === */
        #calc-icon {
            position: fixed; bottom: 80px; right: 20px; 
            background: #007bff; color: white; width: 50px; height: 50px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 9000;
            display: none; /* Hidden until login */
        }
        #calc-modal {
            display: none; position: fixed; bottom: 140px; right: 20px;
            background: #333; padding: 10px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 9001; width: 200px;
        }
        .c-screen { width: 100%; height: 40px; background: #eee; margin-bottom: 10px; text-align: right; padding: 5px; font-size: 20px; box-sizing: border-box; }
        .c-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .c-btn { padding: 10px; background: #555; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .c-btn.op { background: #ff9800; } .c-btn.eq { background: #28a745; grid-column: span 2; } .c-btn.clr { background: #dc3545; grid-column: span 2; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>üîí UNIFIED ACCESS</h2>
            <p style="color:#888; font-size:12px;">Starbite Super App</p>
            <input type="password" id="pinInput" class="login-input" placeholder="PIN" maxlength="4">
            <button class="login-btn" onclick="checkLogin()">UNLOCK</button>
            <div id="loginError" class="login-error">Incorrect PIN</div>
            <p style="font-size:10px; color:#555; margin-top:15px;"></p>
        </div>
    </div>

    <div class="app-nav" id="mainNav">
        <button class="nav-btn active" onclick="switchTab(1)">‚òÅÔ∏è Shop</button>
        <button class="nav-btn" onclick="switchTab(2)">üìù Recorder</button>
        <button class="nav-btn" onclick="switchTab(3)">‚ö°Ô∏è Charging</button>
        <button class="nav-btn" onclick="switchTab(4)" style="color:#ffc107;">üëë Master</button>
        <button class="nav-btn" onclick="toggleDark()" style="max-width:40px;">üåó</button>
    </div>

    <div class="frame-container" id="mainContainer">
        <iframe id="frame1" class="active" allow="camera; microphone; geolocation"></iframe>
        <iframe id="frame2" allow="camera; microphone"></iframe>
        <iframe id="frame3" allow="camera; microphone"></iframe>
        <iframe id="frame4"></iframe>
    </div>

    <div id="calc-icon" onclick="toggleCalc()">üßÆ</div>
    <div id="calc-modal">
        <input type="text" class="c-screen" id="cScreen" readonly>
        <div class="c-grid">
            <button class="c-btn clr" onclick="cClr()">C</button>
            <button class="c-btn op" onclick="cIn('/')">/</button>
            <button class="c-btn op" onclick="cIn('*')">x</button>
            <button class="c-btn" onclick="cIn('7')">7</button>
            <button class="c-btn" onclick="cIn('8')">8</button>
            <button class="c-btn" onclick="cIn('9')">9</button>
            <button class="c-btn op" onclick="cIn('-')">-</button>
            <button class="c-btn" onclick="cIn('4')">4</button>
            <button class="c-btn" onclick="cIn('5')">5</button>
            <button class="c-btn" onclick="cIn('6')">6</button>
            <button class="c-btn op" onclick="cIn('+')">+</button>
            <button class="c-btn" onclick="cIn('1')">1</button>
            <button class="c-btn" onclick="cIn('2')">2</button>
            <button class="c-btn" onclick="cIn('3')">3</button>
            <button class="c-btn eq" onclick="cCalc()">=</button>
            <button class="c-btn" onclick="cIn('0')">0</button>
            <button class="c-btn" onclick="cIn('.')">.</button>
        </div>
    </div>

    <script>
        // === SINGLE CONFIG FOR ALL APPS ===
        const MAIN_CONFIG = `
            const firebaseConfig = { 
                apiKey: "AIzaSyCqmaIDptWNk8v5E5Sz5XKKSAmk6FNX6Yo", 
                authDomain: "credit-record-24f1e.firebaseapp.com", 
                projectId: "credit-record-24f1e", 
                storageBucket: "credit-record-24f1e.firebasestorage.app", 
                messagingSenderId: "181078991416", 
                appId: "1:181078991416:web:6e562cccc19767561b7ccd", 
                measurementId: "G-25QCCCYT9W" 
            };
        `;

        const USERS = {
            "1111": { name: "Admin", role: "admin" },
            "2222": { name: "Staff", role: "staff" }
        };

        let currentUserRole = 'staff'; // Default safety

        function checkLogin() {
            const pin = document.getElementById('pinInput').value;
            if (USERS[pin]) {
                currentUserRole = USERS[pin].role; // Store Role
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('mainNav').style.visibility = 'visible';
                document.getElementById('mainContainer').style.visibility = 'visible';
                document.getElementById('calc-icon').style.display = 'flex';
                loadApps();
                alert(`Welcome back, ${USERS[pin].name}! (${currentUserRole.toUpperCase()} Mode)`);
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('pinInput').value = '';
            }
        }

        document.getElementById('pinInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkLogin();
        });

        function loadApps() {
            // INJECT CONFIG AND USER ROLE INTO SUB-APPS
            const roleInject = `const USER_ROLE = "${currentUserRole}";`;
            const wrap = (code) => code.replace('// [[INJECT_CONFIG]]', MAIN_CONFIG + "\n" + roleInject);

            const c1 = document.getElementById('code1');
            const c2 = document.getElementById('code2');
            const c3 = document.getElementById('code3');
            const c4 = document.getElementById('code4');

            if(c1) document.getElementById('frame1').srcdoc = wrap(c1.value);
            if(c2) document.getElementById('frame2').srcdoc = wrap(c2.value);
            if(c3) document.getElementById('frame3').srcdoc = wrap(c3.value);
            if(c4) document.getElementById('frame4').srcdoc = wrap(c4.value);
        }

        function switchTab(num) {
            // SECURITY: BLOCK MASTER APP FOR STAFF
            if (num === 4 && currentUserRole === 'staff') {
                alert("‚õî ACCESS DENIED: Admin Only.");
                return;
            }

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('iframe').forEach(fr => fr.classList.remove('active'));
            const btnIndex = num - 1; 
            document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            document.getElementById('frame'+num).classList.add('active');
        }

        function toggleDark() { document.body.classList.toggle('dark-mode'); }
        function toggleCalc() { const m = document.getElementById('calc-modal'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        function cIn(v) { document.getElementById('cScreen').value += v; }
        function cClr() { document.getElementById('cScreen').value = ''; }
        function cCalc() { try { document.getElementById('cScreen').value = eval(document.getElementById('cScreen').value); } catch { document.getElementById('cScreen').value = 'Error'; } }
    </script>

<textarea id="code1" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Shop</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* SECURITY CSS */
        body.is-staff .admin-only { display: none !important; }
        
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f4f6f8; margin: 0; padding: 0; padding-bottom: 80px; user-select: none; }
        .header { background: #0d47a1; color: white; padding: 15px; text-align: center; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; gap:10px;}
        .live-dot { height: 10px; width: 10px; background-color: #00e676; border-radius: 50%; display: inline-block; box-shadow: 0 0 5px #00e676; }
        .container { padding: 15px; max-width: 100%; margin: 0 auto; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dash-card { background: #fff; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid #eee; cursor: pointer; }
        .dash-num { font-size: 20px; font-weight: bold; display: block; margin-bottom: 5px; }
        .dash-label { font-size: 11px; color: #777; text-transform: uppercase; }
        .text-green { color: #28a745; } .text-red { color: #dc3545; } .text-blue { color: #007bff; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        thead { background: #343a40; color: white; }
        th { padding: 12px 8px; text-align: left; font-size: 13px; font-weight: 600; white-space: nowrap; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        .col-desc { min-width: 150px; white-space: normal; } 
        tr:nth-child(even) { background-color: #f8f9fa; }
        .ledger-table { width: 100%; min-width: auto; border: 1px solid #eee; margin-top: 10px; }
        .ledger-table th { background: #f1f3f4; color: #333; font-size: 12px; }
        .ledger-table td { padding: 8px; font-size: 13px; border-bottom: 1px solid #eee; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; background: #fafafa; }
        input:focus { border-color: #0d47a1; outline: none; background: white; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; color: white; margin-bottom: 5px; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-green { background: #2e7d32; } .btn-blue { background: #1565c0; }
        .btn-red { background: #c62828; } .btn-orange { background: #ef6c00; }
        .btn-dark { background: #37474f; }
        .btn-tbl { padding: 6px 10px; font-size: 12px; border-radius: 4px; margin: 2px; width: auto; display: inline-block; }
        .btn-mini { padding: 2px 8px; width: auto; display: inline-block; margin: 0 2px; border-radius: 4px; font-size: 14px; }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; display: inline-block; text-align: center; }
        .bg-full { background: #d4edda; color: #155724; } .bg-part { background: #fff3cd; color: #856404; } .bg-over { background: #f8d7da; color: #721c24; }
        .nav { display: flex; justify-content: space-around; background: #fff; padding: 8px 0; position: fixed; bottom: 0; left: 0; right: 0; border-top: 1px solid #ccc; z-index: 9999; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .nav-btn { background: none; border: none; color: #999; font-size: 10px; display: flex; flex-direction: column; align-items: center; padding: 0; margin: 0; width: auto; }
        .nav-btn span { font-size: 22px; margin-bottom: 2px; }
        .nav-btn.active { color: #0d47a1; }
        .section { display: none; } .active-section { display: block; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius: 15px; width:90%; max-width: 400px; animation: popUp 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes popUp { from {transform: scale(0.9); opacity:0;} to {transform: scale(1); opacity:1;} }
        .list-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .summary-box { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 13px; }
        .summary-item { text-align: center; }
        .summary-val { display: block; font-weight: bold; font-size: 15px; }
        .report-bar { display: flex; gap: 5px; background: #eee; padding: 10px; border-radius: 8px; overflow-x: auto; margin-bottom:10px; }
        .report-btn { background: #333; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; white-space: nowrap; cursor: pointer; flex: 1; }
    </style>
</head>
<body>

    <div class="header">
        <span class="live-dot"></span> Shop Manager
    </div>

    <div class="container">
        
        <div id="sec-dash" class="section active-section">
            <div class="dash-grid">
                <div class="dash-card admin-only">
                    <span class="dash-num text-green" id="d-today">Loading...</span>
                    <span class="dash-label">Today's Cash</span>
                </div>
                <div class="dash-card admin-only">
                    <span class="dash-num text-red" id="d-owed">Loading...</span>
                    <span class="dash-label">Total Debt Owed</span>
                </div>
                <div class="dash-card" onclick="runIf(window.showLowStock)">
                    <span class="dash-num text-blue" id="d-stock">0</span>
                    <span class="dash-label">Low Stock Items (Tap)</span>
                </div>
                <div class="dash-card admin-only" onclick="nav('sec-trash', document.getElementById('btn-trash'))">
                    <span class="dash-num" id="d-trash">0</span>
                    <span class="dash-label">View Trash üóëÔ∏è</span>
                </div>
            </div>
            <div style="text-align:center; margin-top:20px; color:#777; font-size:12px;">Data synced with Google Cloud</div>
        </div>

        <div id="sec-sell" class="section">
            <div class="card">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="search" placeholder="üîç Search product..." onkeyup="runIf(window.renderProducts)">
                    <button style="width:60px; background:#666;" onclick="window.startScan('search')">üì∑</button>
                </div>
                <div id="prodList" style="max-height: 180px; overflow-y: auto;"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="number" id="qty" placeholder="Qty" style="width: 80px;">
                    <button class="btn-green" onclick="runIf(window.addToCart)">Add</button>
                </div>
                <input type="hidden" id="selIndex">
            </div>

            <div class="card">
                <h3>üõí Cart (Total: ‚Ç¶<span id="cartTotal">0</span>)</h3>
                <div id="cartList"></div>
                <div style="background:#37474f; color:white; padding:10px; border-radius:8px; margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span>Cash Given:</span>
                    <input type="number" id="payInput" placeholder="0" style="width:100px; padding:5px; margin:0; text-align:right;" onkeyup="runIf(window.calcChange)">
                </div>
                <div id="changeTxt" style="text-align:right; font-weight:bold; margin-top:5px; color:#2e7d32;">Change: ‚Ç¶0</div>
                
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-blue" onclick="runIf(window.checkout, 'cash')">üíµ Cash Sale</button>
                    <button class="btn-orange" onclick="openCreditModal()">üìí Credit Sale</button>
                </div>
            </div>
        </div>

        <div id="sec-debt" class="section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0;">üìí Debt Records</h3>
                    <button class="btn-dark btn-tbl admin-only" style="font-size:14px; padding:8px;" onclick="openManualDebt()">+ Add Old Debt</button>
                </div>
                <input type="text" id="debtSearch" placeholder="üîç Search name..." onkeyup="runIf(window.renderDebtors)">
                <div class="table-responsive">
                    <table id="debtTable">
                        <thead>
                            <tr>
                                <th class="col-desc">Name & Items</th>
                                <th class="admin-only">Total</th>
                                <th>Paid</th>
                                <th class="admin-only">Balance</th>
                                <th>Status</th>
                                <th style="text-align:center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="debtTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-stock" class="section">
            <div class="card">
                <h3>üì¶ Inventory & Tracking</h3>
                <button class="btn-blue admin-only" onclick="openProdModal()">+ New Product</button>
                <div id="stockList" style="margin-top:10px;"></div>
                <div class="admin-only" style="background:#e8f5e9; color:#2e7d32; padding:10px; margin-top:10px; font-weight:bold; text-align:center; border-radius:8px;">
                    Total Expected Revenue: <span id="grandStockTotal">Loading...</span>
                </div>
            </div>
        </div>

        <div id="sec-hist" class="section">
            <div class="card">
                <h3>üìú Reports & Sales History</h3>
                <div class="report-bar admin-only">
                    <button class="report-btn" onclick="runIf(window.genReport, 'day')">üìÑ Daily PDF</button>
                    <button class="report-btn" onclick="runIf(window.genReport, 'month')">üìÑ Monthly PDF</button>
                    <button class="report-btn" onclick="runIf(window.genReport, 'year')">üìÑ Yearly PDF</button>
                </div>
                <div id="mainHistList" style="margin-top:10px;"></div>
            </div>
        </div>

        <div id="sec-trash" class="section">
            <div class="card">
                <h3>üóëÔ∏è Deleted Items</h3>
                <div id="trashList"></div>
            </div>
        </div>
    </div>

    <div id="mod-credit" class="modal">
        <div class="modal-content">
            <h3>üìù Credit Sale</h3>
            <input type="text" id="c-name" placeholder="Customer Name">
            <input type="tel" id="c-phone" placeholder="Phone Number">
            <button class="btn-green" id="btn-confirm-credit" onclick="runIf(window.checkout, 'credit')">Confirm</button>
            <button class="btn-red" onclick="closeModals()">Cancel</button>
        </div>
    </div>
    <div id="mod-prod" class="modal">
        <div class="modal-content">
            <h3>üì¶ Product Details</h3>
            <input type="hidden" id="p-id">
            <input type="text" id="p-name" placeholder="Name">
            <input type="number" id="p-price" placeholder="Price">
            <label style="font-size:12px; color:#555;">Initial Opening Stock:</label>
            <input type="number" id="p-stock" placeholder="Initial Qty (Fixed)">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="p-barcode" placeholder="Barcode (Optional)" style="margin:0;">
                <button style="width:60px; background:#666; margin:0;" onclick="window.startScan('edit')">üì∑</button>
            </div>
            <button class="btn-green" onclick="runIf(window.saveProduct)">Save to Cloud</button>
            <button class="btn-red" onclick="closeModals()">Cancel</button>
        </div>
    </div>
    <div id="mod-pay" class="modal">
        <div class="modal-content">
            <h3>üí∞ Receive Payment</h3>
            <p id="pay-info" style="color:#666; font-size:14px; text-align:center;"></p>
            <input type="hidden" id="pay-id">
            <label>Payment Method:</label>
            <select id="pay-method" style="margin-bottom:15px;"><option value="Cash">üíµ Cash</option><option value="Transfer">üè¶ Transfer</option></select>
            <label>Amount Paying Now:</label>
            <input type="number" id="pay-amt" placeholder="Enter Amount">
            <button class="btn-green" onclick="runIf(window.processPayment)">Save Payment</button>
            <button class="btn-red" onclick="closeModals()">Cancel</button>
        </div>
    </div>
    <div id="mod-manual" class="modal">
        <div class="modal-content">
            <h3>‚ûï Add/Edit Debt</h3>
            <input type="hidden" id="m-id">
            <input type="text" id="m-name" placeholder="Name">
            <input type="text" id="m-phone" placeholder="Phone">
            <input type="number" id="m-amt" placeholder="Total Amount Owed">
            <input type="text" id="m-desc" placeholder="Note (e.g. Rice)">
            <button class="btn-green" onclick="runIf(window.saveManualDebt)">Save Record</button>
            <button class="btn-red" onclick="closeModals()">Cancel</button>
        </div>
    </div>
    <div id="mod-hist" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">üìú Customer Ledger</h3>
            <h4 id="h-name" style="color:#0d47a1; margin-top:0; border-bottom:1px solid #eee; padding-bottom:5px;"></h4>
            <div class="summary-box">
                <div class="summary-item admin-only"><span>Total Debt</span><span class="summary-val" id="h-total">0</span></div>
                <div class="summary-item"><span>Paid</span><span class="summary-val text-green" id="h-paid">0</span></div>
                <div class="summary-item admin-only"><span>Balance</span><span class="summary-val text-red" id="h-bal">0</span></div>
            </div>
            <p style="font-size:12px; font-weight:bold; margin-bottom:5px;">Payment History:</p>
            <table class="ledger-table"><thead><tr><th>Date</th><th>Method</th><th style="text-align:right;">Amount</th></tr></thead><tbody id="h-list"></tbody></table>
            <br><button class="btn-dark" onclick="closeModals()">Close</button>
        </div>
    </div>
    
    <div id="mod-lowstock" class="modal">
        <div class="modal-content">
            <h3 style="color:#d32f2f;">‚ö†Ô∏è Low Stock Alert</h3>
            <div id="lowStockList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
            <button class="btn-dark" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="mod-scan" class="modal">
        <div class="modal-content">
            <h3>üì∑ Scan Barcode</h3>
            <div id="reader" style="width:100%"></div>
            <button class="btn-red" onclick="window.stopScan()">Close</button>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="nav('sec-dash', this)"><span>üìä</span>Dash</button>
        <button class="nav-btn" onclick="nav('sec-sell', this)"><span>üõí</span>Sell</button>
        <button class="nav-btn" onclick="nav('sec-debt', this)"><span>üìí</span>Debt</button>
        <button class="nav-btn" onclick="nav('sec-stock', this)"><span>üì¶</span>Stock</button>
        <button class="nav-btn" onclick="nav('sec-hist', this)"><span>üìú</span>Hist</button>
    </div>

<script>
    function nav(id, btn) {
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active-section'));
        document.getElementById(id).classList.add('active-section');
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        if(id === 'sec-debt' && window.renderDebtors) window.renderDebtors();
    }
    
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    function openCreditModal() { document.getElementById('mod-credit').style.display='flex'; }
    function openProdModal() { 
        document.getElementById('p-id').value = ''; 
        document.getElementById('p-name').value = ''; 
        document.getElementById('p-price').value = ''; 
        document.getElementById('p-stock').value = ''; 
        document.getElementById('p-barcode').value = ''; 
        document.getElementById('mod-prod').style.display='flex'; 
    }
    function openManualDebt() { 
        document.getElementById('m-id').value = ''; 
        document.getElementById('m-name').value = ''; 
        document.getElementById('m-phone').value = ''; 
        document.getElementById('m-amt').value = ''; 
        document.getElementById('m-desc').value = ''; 
        document.getElementById('mod-manual').style.display='flex'; 
    }
    function runIf(fn, arg) { if(typeof fn === 'function') fn(arg); else alert("Connecting to Cloud... Please wait."); }

    // SCANNER LOGIC
    let html5QrcodeScanner;
    let scanTarget = 'search'; 

    window.startScan = function(target) {
        if(typeof Html5QrcodeScanner === 'undefined') {
            alert("Scanner library not loaded. Check internet connection.");
            return;
        }
        scanTarget = target;
        document.getElementById('mod-scan').style.display = 'flex';
        document.getElementById("reader").innerHTML = "";
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    }
    
    window.stopScan = function() {
        if(html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(() => {
                document.getElementById('mod-scan').style.display = 'none';
            }).catch(error => {
                document.getElementById('mod-scan').style.display = 'none';
            });
        } else {
             document.getElementById('mod-scan').style.display = 'none';
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        if(scanTarget === 'search') {
            document.getElementById('search').value = decodedText;
            window.renderProducts(); 
        } else {
            document.getElementById('p-barcode').value = decodedText;
        }
        window.stopScan();
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, query, orderBy, limit, getDocs } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // [[INJECT_CONFIG]]

    // APPLY SECURITY
    if(typeof USER_ROLE !== 'undefined' && USER_ROLE === 'staff') {
        document.body.classList.add('is-staff');
    }

    try {
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let products = [], sales = [], debtors = [], trash = [], cart = [];
        let allSalesForReports = []; 

        onSnapshot(collection(db, "products"), (snapshot) => { 
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            window.renderProducts(); window.renderStock(); window.renderDash(); 
        });
        
        const salesQ = query(collection(db, "sales"), orderBy("date", "desc"), limit(50));
        onSnapshot(salesQ, (snapshot) => { 
            sales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            window.renderHistory(); window.renderDash(); 
        });

        onSnapshot(collection(db, "sales"), (snapshot) => {
            allSalesForReports = snapshot.docs.map(doc => doc.data());
        });

        const debtorsQ = query(collection(db, "debtors"), orderBy("date", "desc"));
        onSnapshot(debtorsQ, (snapshot) => { debtors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); window.renderDebtors(); window.renderDash(); });
        onSnapshot(collection(db, "trash"), (snapshot) => { trash = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); window.renderTrash(); window.renderDash(); });

        window.renderDash = () => {
            const today = new Date().toISOString().split('T')[0];
            const todayCash = sales.filter(s => s.date.startsWith(today) && (s.type === 'Cash' || s.type === 'Debt Payment')).reduce((a, b) => a + b.total, 0);
            const totalOwed = debtors.reduce((a,b) => {
                const paid = (b.payments || []).reduce((x,y) => x + y.amount, 0);
                return a + (b.totalDebt - paid);
            }, 0);
            document.getElementById('d-today').innerText = "‚Ç¶" + todayCash.toLocaleString();
            document.getElementById('d-owed').innerText = "‚Ç¶" + totalOwed.toLocaleString();
            document.getElementById('d-stock').innerText = products.filter(p => p.stock <= 5).length;
            document.getElementById('d-trash').innerText = trash.length;
        }

        window.showLowStock = () => {
            const low = products.filter(p => p.stock <= 5);
            const div = document.getElementById('lowStockList');
            div.innerHTML = '';
            if(low.length === 0) {
                div.innerHTML = '<p style="text-align:center; padding:20px;">‚úÖ Good news! All stock levels are healthy.</p>';
            } else {
                low.forEach(p => {
                    div.innerHTML += `<div class="list-item" style="background:#fff3cd">
                        <b>${p.name}</b> <span style="color:#c62828; font-weight:bold">${p.stock} left</span>
                    </div>`;
                });
            }
            document.getElementById('mod-lowstock').style.display = 'flex';
        }

        window.renderProducts = () => {
            const q = document.getElementById('search').value.toLowerCase();
            const div = document.getElementById('prodList'); div.innerHTML = '';
            const exactMatchIndex = products.findIndex(p => p.barcode === q);
            products.forEach((p, i) => {
                if(p.name.toLowerCase().includes(q) || (p.barcode && p.barcode === q)) {
                    let color = p.stock < 5 ? '#fff3cd' : 'white';
                    if(p.barcode === q) color = '#d1e7dd'; 
                    div.innerHTML += `<div onclick="window.selProd(${i})" style="padding:10px; border-bottom:1px solid #eee; background:${color}; cursor:pointer;"><b>${p.name}</b> <small>(Stock: ${p.stock})</small><div style="float:right;">‚Ç¶${p.price}</div></div>`;
                }
            });
            if(exactMatchIndex !== -1 && q.length > 3) { window.selProd(exactMatchIndex); }
        };

        window.selProd = (i) => { document.getElementById('selIndex').value = i; document.getElementById('qty').focus(); }

        window.addToCart = () => {
            const idx = document.getElementById('selIndex').value; const qty = parseInt(document.getElementById('qty').value);
            if(idx === '' || !qty) return;
            const p = products[idx];
            if(qty > p.stock) { alert("Not enough stock!"); return; }
            
            const exist = cart.find(c => c.id === p.id);
            if(exist) { exist.qty += qty; exist.sub = exist.price * exist.qty; }
            else { cart.push({ ...p, idx, qty, sub: p.price * qty }); }
            
            window.renderCart(); document.getElementById('search').value = ''; document.getElementById('qty').value = ''; window.renderProducts();
        }

        window.renderCart = () => {
            const div = document.getElementById('cartList'); div.innerHTML = ''; let total = 0;
            cart.forEach((c, i) => { 
                total += c.sub; 
                div.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:5px;">
                    <span>${c.name}</span>
                    <div style="display:flex; align-items:center;">
                        <button class="btn-blue btn-mini" onclick="window.modQty(${i}, -1)">-</button>
                        <span style="font-weight:bold; margin:0 5px;">${c.qty}</span>
                        <button class="btn-blue btn-mini" onclick="window.modQty(${i}, 1)">+</button>
                        <span style="margin-left:5px;">‚Ç¶${c.sub}</span>
                        <button class="btn-red btn-mini" onclick="window.modQty(${i}, -9999)" style="margin-left:10px;">x</button>
                    </div>
                </div>`; 
            });
            document.getElementById('cartTotal').innerText = total.toLocaleString(); window.calcChange();
        }

        window.modQty = (i, delta) => {
            if(delta === -9999) { cart.splice(i, 1); } 
            else {
                cart[i].qty += delta;
                if(cart[i].qty <= 0) { cart.splice(i, 1); }
                else { cart[i].sub = cart[i].price * cart[i].qty; }
            }
            window.renderCart();
        }

        window.calcChange = () => {
            const total = parseInt(document.getElementById('cartTotal').innerText.replace(/,/g,'')); const pay = parseInt(document.getElementById('payInput').value);
            if(pay) document.getElementById('changeTxt').innerText = "Change: ‚Ç¶" + (pay - total).toLocaleString();
        }

        window.checkout = async (type) => {
            if(cart.length === 0) return;
            cart.forEach(async (c) => { const newStock = c.stock - c.qty; const pRef = doc(db, "products", c.id); await updateDoc(pRef, { stock: newStock }); });
            const total = cart.reduce((a,b) => a + b.sub, 0); 
            const itemsArr = cart.map(c => ({ name: c.name, qty: c.qty, price: c.price, sub: c.sub }));
            const desc = cart.map(c => `${c.name}(x${c.qty})`).join(', '); 
            const date = new Date().toISOString();

            if(type === 'cash') {
                await addDoc(collection(db, "sales"), { date, desc, items: itemsArr, total, type: 'Cash' }); alert("Cash Sale Synced!");
            } else {
                const name = document.getElementById('c-name').value;
                if(!name) { alert("Enter Name"); return; }
                await addDoc(collection(db, "debtors"), { name, phone: document.getElementById('c-phone').value, desc, totalDebt: total, payments: [], date });
                alert("Added to Debtors Book"); window.closeModals();
            }
            cart = []; document.getElementById('payInput').value = ''; window.renderCart();
        }

        window.renderDebtors = () => {
            const q = document.getElementById('debtSearch').value.toLowerCase();
            const tbody = document.getElementById('debtTableBody'); tbody.innerHTML = '';
            debtors.forEach((d) => {
                if(d.name.toLowerCase().includes(q)) {
                    const paid = (d.payments || []).reduce((a,b) => a + b.amount, 0);
                    const rem = d.totalDebt - paid;
                    let status = rem <= 0 ? 'Full' : (paid > 0 ? 'Part' : 'Unpaid');
                    let badge = status === 'Full' ? 'bg-full' : (status === 'Part' ? 'bg-part' : 'bg-over');
                    tbody.innerHTML += `<tr><td class="col-desc"><b style="font-size:15px;">${d.name}</b><small style="color:#666; display:block; margin-top:4px; font-style:italic;">${d.desc}</small><small style="color:#999;">${new Date(d.date).toLocaleDateString()}</small></td><td class="admin-only">‚Ç¶${d.totalDebt.toLocaleString()}</td><td class="text-green">‚Ç¶${paid.toLocaleString()}</td><td class="text-red admin-only" style="font-weight:bold;">‚Ç¶${rem.toLocaleString()}</td><td><span class="badge ${badge}">${status}</span></td><td style="text-align:center;">${rem > 0 ? `<button class="btn-green btn-tbl" onclick="window.openPay('${d.id}')">Pay</button>` : ''}<button class="btn-orange btn-tbl admin-only" onclick="window.editDebt('${d.id}')">Edit</button><button class="btn-blue btn-tbl" onclick="window.viewHist('${d.id}')">üìú History</button><button class="btn-red btn-tbl admin-only" onclick="window.moveToTrash('${d.id}')">X</button></td></tr>`;
                }
            });
        }

        window.editDebt = (id) => {
            const d = debtors.find(x => x.id === id);
            document.getElementById('m-id').value = id;
            document.getElementById('m-name').value = d.name;
            document.getElementById('m-phone').value = d.phone;
            document.getElementById('m-amt').value = d.totalDebt;
            document.getElementById('m-desc').value = d.desc;
            document.getElementById('mod-manual').style.display = 'flex';
        }

        window.saveManualDebt = async () => {
            const id = document.getElementById('m-id').value;
            const name = document.getElementById('m-name').value;
            const phone = document.getElementById('m-phone').value;
            const amt = parseInt(document.getElementById('m-amt').value);
            const desc = document.getElementById('m-desc').value;

            if(name && amt) {
                if(id) {
                    await updateDoc(doc(db, "debtors", id), { name, phone, totalDebt: amt, desc });
                } else {
                    await addDoc(collection(db, "debtors"), { name, phone, desc: desc || "Manual", totalDebt: amt, payments: [], date: new Date().toISOString() });
                }
                window.closeModals();
                document.getElementById('m-id').value = '';
            }
        }

        window.openPay = (id) => {
            const d = debtors.find(x => x.id === id); const paid = (d.payments || []).reduce((a,b) => a+b.amount, 0);
            document.getElementById('pay-info').innerText = `${d.name} owes ‚Ç¶${(d.totalDebt - paid).toLocaleString()}`;
            document.getElementById('pay-id').value = id; document.getElementById('mod-pay').style.display = 'flex';
        }

        window.processPayment = async () => {
            const id = document.getElementById('pay-id').value; const amt = parseInt(document.getElementById('pay-amt').value); const method = document.getElementById('pay-method').value;
            if(!amt) return;
            const d = debtors.find(x => x.id === id);
            await updateDoc(doc(db, "debtors", id), { payments: [...d.payments, { date: new Date().toISOString(), amount: amt, method: method }] });
            await addDoc(collection(db, "sales"), { date: new Date().toISOString(), desc: `Debt Pay: ${d.name} (${method})`, total: amt, type: 'Debt Payment' });
            document.getElementById('pay-amt').value = ''; window.closeModals(); alert(`Payment of ‚Ç¶${amt} via ${method} Synced!`);
        }

        window.viewHist = (id) => {
            const d = debtors.find(x => x.id === id);
            document.getElementById('h-name').innerText = d.name;
            const tbody = document.getElementById('h-list'); tbody.innerHTML = '';
            const paid = (d.payments || []).reduce((a,b) => a + b.amount, 0);
            document.getElementById('h-total').innerText = "‚Ç¶" + d.totalDebt.toLocaleString();
            document.getElementById('h-paid').innerText = "‚Ç¶" + paid.toLocaleString();
            document.getElementById('h-bal').innerText = "‚Ç¶" + (d.totalDebt - paid).toLocaleString();
            if(!d.payments || d.payments.length === 0) tbody.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:10px;'>No payments yet.</td></tr>";
            else { [...d.payments].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => { tbody.innerHTML += `<tr><td>${new Date(p.date).toLocaleDateString()}</td><td>${p.method === 'Transfer' ? 'üè¶' : 'üíµ'} ${p.method||'Cash'}</td><td style="text-align:right; font-weight:bold; color:#2e7d32;">‚Ç¶${p.amount.toLocaleString()}</td></tr>`; }); }
            document.getElementById('mod-hist').style.display = 'flex';
        }

        window.moveToTrash = async (id) => { if(!confirm("Delete?")) return; const d = debtors.find(x => x.id === id); await setDoc(doc(db, "trash", id), { ...d, deletedAt: new Date().toISOString() }); await deleteDoc(doc(db, "debtors", id)); }
        window.renderTrash = () => { const div = document.getElementById('trashList'); div.innerHTML = ''; trash.forEach(t => { div.innerHTML += `<div class="list-item"><div><b>${t.name}</b><br><small>Del: ${new Date(t.deletedAt).toLocaleDateString()}</small></div><div><button class="btn-blue btn-tbl" onclick="window.restore('${t.id}')">Restore</button> <button class="btn-red btn-tbl" onclick="window.permDel('${t.id}')">X</button></div></div>`; }); }
        window.restore = async (id) => { const t = trash.find(x => x.id === id); const { deletedAt, ...rest } = t; await setDoc(doc(db, "debtors", id), rest); await deleteDoc(doc(db, "trash", id)); }
        window.permDel = async (id) => { if(confirm("Permanently delete?")) await deleteDoc(doc(db, "trash", id)); }
        
        window.renderStock = () => { 
            const div = document.getElementById('stockList'); div.innerHTML = ''; 
            let grandExpTotal = 0;
            products.forEach((p, i) => { 
                const init = p.initStock || p.stock; 
                const sold = Math.max(0, init - p.stock);
                const expVal = init * p.price;
                grandExpTotal += expVal;

                div.innerHTML += `
                <div class="list-item">
                    <div>
                        <b>${p.name}</b> <small>(Init: ${init} | Cur: ${p.stock})</small><br>
                        <span class="admin-only" style="font-size:11px; color:#555;">Sold: ${sold} | Exp.Rev: ‚Ç¶${expVal.toLocaleString()}</span>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-blue btn-tbl" onclick="window.addStock('${p.id}')">Refill</button>
                        <button class="btn-orange btn-tbl admin-only" onclick="window.editStock('${p.id}')">Edit</button>
                        <button class="btn-red btn-tbl admin-only" onclick="window.deleteProduct('${p.id}')">Del</button>
                    </div>
                </div>`; 
            });
            document.getElementById('grandStockTotal').innerText = "‚Ç¶" + grandExpTotal.toLocaleString();
        }

        window.deleteProduct = async (id) => { if(confirm("Are you sure you want to delete this product?")) { await deleteDoc(doc(db, "products", id)); } }

        window.addStock = async (id) => { 
            let n = prompt("Add Qty:"); 
            if(n) { 
                const p = products.find(x => x.id === id); 
                const add = parseInt(n);
                await updateDoc(doc(db, "products", id), { 
                    stock: p.stock + add,
                    initStock: (p.initStock || p.stock) + add 
                }); 
            } 
        }
        
        window.editStock = async (id) => { 
            const p = products.find(x => x.id === id);
            document.getElementById('p-id').value = id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-stock').value = p.initStock || p.stock; 
            document.getElementById('p-barcode').value = p.barcode || "";
            document.getElementById('mod-prod').style.display='flex';
        }

        window.saveProduct = async () => { 
            const id = document.getElementById('p-id').value;
            const name = document.getElementById('p-name').value;
            const price = parseInt(document.getElementById('p-price').value);
            const stock = parseInt(document.getElementById('p-stock').value); 
            const barcode = document.getElementById('p-barcode').value;

            if(!name || !price) return alert("Name and Price required!");

            if(id) {
                await updateDoc(doc(db, "products", id), { name, price, stock: stock, initStock: stock, barcode });
            } else {
                const exists = products.find(p => p.name.trim().toLowerCase() === name.trim().toLowerCase());
                if(exists) { alert("Error: Product already exists!"); return; }
                await addDoc(collection(db, "products"), { name, price, stock: stock, initStock: stock, barcode });
            }
            window.closeModals(); 
        }
        
        window.genReport = (type) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            let filterDate = "";
            let title = "";

            if(type === 'day') {
                filterDate = now.toISOString().split('T')[0];
                title = `Daily Sales Report (${filterDate})`;
            } else if (type === 'month') {
                filterDate = now.toISOString().slice(0, 7); 
                title = `Monthly Sales Report (${filterDate})`;
            } else if (type === 'year') {
                filterDate = now.getFullYear().toString();
                title = `Yearly Sales Report (${filterDate})`;
            }

            const filteredSales = allSalesForReports.filter(s => s.date.startsWith(filterDate) && s.type === 'Cash' && s.items);
            const reportMap = {};
            let grandTotal = 0;

            filteredSales.forEach(s => {
                s.items.forEach(item => {
                    if(!reportMap[item.name]) reportMap[item.name] = { qty: 0, total: 0, price: item.price };
                    reportMap[item.name].qty += item.qty;
                    reportMap[item.name].total += item.sub;
                    grandTotal += item.sub;
                });
            });

            const body = Object.keys(reportMap).map(name => [
                name,
                reportMap[name].price,
                reportMap[name].qty,
                "N" + reportMap[name].total.toLocaleString()
            ]);

            doc.text("STARBITE SUPER APP", 14, 15);
            doc.text(title, 14, 25);
            
            doc.autoTable({
                head: [['Product', 'Unit Price', 'Qty Sold', 'Total Sales']],
                body: body,
                startY: 35,
                foot: [['', '', 'GRAND TOTAL', "N" + grandTotal.toLocaleString()]]
            });

            doc.save(`Starbite_Report_${type}.pdf`);
        }

        window.renderHistory = () => { 
            const div = document.getElementById('mainHistList'); div.innerHTML = ''; 
            sales.forEach(s => { 
                div.innerHTML += `
                <div class="list-item">
                    <div><b>‚Ç¶${s.total.toLocaleString()}</b><br><small>${s.desc} (${s.type})</small><br><span style="font-size:10px; color:#999">${new Date(s.date).toLocaleString()}</span></div>
                    <button class="btn-red btn-tbl admin-only" onclick="window.deleteSale('${s.id}')">Del</button>
                </div>`; 
            }); 
        }

        window.deleteSale = async (id) => {
            if(confirm("Delete this sale?")) {
                await deleteDoc(doc(db, "sales", id));
            }
        }
    } catch(e) { console.error("Firebase Error", e); }
</script>
</body>
</html>
</textarea>

<textarea id="code2" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starbite Production Recorder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* SECURITY */
    body.is-staff .admin-only { display: none !important; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
    #toast.show { opacity: 1; visibility: visible; }
    .s { background:#28a745; } .e { background:#dc3545; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 500; display: flex; justify-content: center; align-items: center; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4">
  <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">STARBITE RECORDER</h1>
        <button onclick="openProdSet()" class="bg-gray-700 text-white px-3 py-1 rounded text-sm admin-only">‚öôÔ∏è Products</button>
    </div>
    
    <div class="bg-indigo-100 rounded-xl p-3 mb-4 border-2 border-indigo-500 admin-only">
        <h3 class="font-bold text-indigo-800">1. Capital & Recovery (Synced)</h3>
        <div class="grid grid-cols-2 gap-3 text-xs mb-2">
            <div class="bg-white p-2 rounded"><label>Production Capital (‚Ç¶)</label><input id="pCap" type="number" class="w-full border p-1 rounded" oninput="saveCap()"></div>
            <div class="bg-white p-2 rounded"><label>Misc/Drinks Capital (‚Ç¶)</label><input id="mCap" type="number" class="w-full border p-1 rounded" oninput="saveCap()"></div>
        </div>
        <div class="text-sm border-t border-indigo-300 pt-2 font-semibold">
            Profit: ‚Ç¶<span id="cumProfit" class="text-green-600">0</span> | Total Cap: ‚Ç¶<span id="totCap">0</span> | <span class="text-red-600">Rem: ‚Ç¶<span id="remCap">0</span></span>
        </div>
    </div>

    <div id="inputCard" class="bg-gray-100 rounded-xl p-3 mb-3 border-2 border-transparent" oninput="calc()">
      <div class="flex gap-2 mb-2 text-sm"><input id="date" type="date" class="p-1 rounded"><input id="time" type="time" class="p-1 rounded"></div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs" id="prodGrid">Loading products...</div>
      <div class="font-semibold mt-2 text-sm">Prod. Sales: ‚Ç¶<span id="prodTot">0</span></div>
    </div>

    <div class="bg-yellow-100 rounded-xl p-3 mb-3" oninput="calc()">
      <h3 class="font-semibold mb-2">2. Cash & Deduction</h3>
      <div class="grid grid-cols-2 gap-2 text-xs mb-2">
        <div><label>Start Float (‚Ç¶)</label><input id="float" type="number" class="w-full p-1 rounded border"></div>
        <div><label>Cash in Hand (‚Ç¶)</label><input id="cash" type="number" class="w-full p-1 rounded border"></div>
      </div>
      <div class="flex justify-between text-sm font-bold bg-white p-2 rounded border">
        <span>Misc Sales: ‚Ç¶<span id="miscSale">0</span></span>
        <span>Total Sales: ‚Ç¶<span id="dayTot">0</span></span>
        <span>Var: ‚Ç¶<span id="var">0</span></span>
      </div>
    </div>

    <div class="bg-gray-100 rounded-xl p-3 mb-3">
      <h3 class="font-semibold">3. Expenses</h3>
      <div class="flex gap-2 text-sm my-2">
        <input id="expDesc" placeholder="Item" class="p-1 rounded border w-full">
        <input id="expAmt" type="number" placeholder="Amt" class="p-1 rounded border w-full">
        <button onclick="addExp()" id="expBtn" class="bg-red-600 text-white px-3 rounded">Add</button>
      </div>
      <div class="text-sm font-semibold">Total Exp: ‚Ç¶<span id="expTot">0</span></div>
      <ul id="expList" class="mt-1"></ul>
    </div>

    <div class="flex flex-wrap gap-2 text-xs items-center">
      <button onclick="save()" id="saveBtn" type="button" class="bg-blue-600 text-white px-4 py-2 rounded shadow text-base font-bold">SAVE RECORD</button>
      <button onclick="editMode(false)" id="cancelBtn" class="hidden bg-gray-500 text-white px-3 py-1 rounded">Cancel</button>
      <button onclick="$('hist').classList.toggle('hidden')" class="bg-green-600 text-white px-3 py-1 rounded admin-only">History</button>
      <button onclick="expCSV()" class="bg-yellow-500 text-white px-3 py-1 rounded admin-only">CSV</button>
      <button onclick="wipe()" class="bg-red-500 text-white px-3 py-1 rounded admin-only">Clear All</button>
      <div class="ml-auto flex gap-1 admin-only">
        <select id="repType" class="p-1 border rounded" onchange="uiDate()">
          <option value="monthly">Monthly</option><option value="yearly">Yearly</option><option value="range">Range</option>
        </select>
        <div id="dtPick" class="flex gap-1"></div>
        <button onclick="genPDF()" class="bg-indigo-600 text-white px-2 rounded">PDF</button>
      </div>
    </div>

    <div id="hist" class="hidden bg-white rounded-xl p-3 border mt-4 overflow-auto">
      <div class="flex justify-around bg-gray-100 p-2 text-sm font-bold mb-2">
          <span>Sales: ‚Ç¶<span id="allSales">0</span></span><span>Profit: ‚Ç¶<span id="allProf">0</span></span>
      </div>
      <table class="w-full text-left text-xs table-auto"><thead class="bg-gray-100"><tr id="hHead"></tr></thead><tbody id="hBody"></tbody><tfoot id="hFoot" class="bg-gray-100 font-bold"></tfoot></table>
    </div>
  </div>

  <div id="prodModal" class="modal-overlay hidden">
    <div class="bg-white p-5 rounded-lg w-11/12 max-w-md max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-3">Manage Products</h2>
      <div class="flex gap-2 mb-4">
        <input id="newPName" placeholder="Name (e.g. Meat Pie)" class="border p-2 rounded w-full">
        <input id="newPPrice" type="number" placeholder="Price" class="border p-2 rounded w-24">
        <button onclick="addProd()" class="bg-green-600 text-white px-3 rounded">Add</button>
      </div>
      <div id="prodSetList" class="space-y-2"></div>
      <button onclick="$('prodModal').classList.add('hidden')" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded w-full">Close</button>
    </div>
  </div>

  <div id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // [[INJECT_CONFIG]]

  // APPLY SECURITY
  if(typeof USER_ROLE !== 'undefined' && USER_ROLE === 'staff') {
      document.body.classList.add('is-staff');
  }

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let P = [
    {id:'egg_roll',n:'Egg roll',p:500},{id:'meat_pie',n:'Meat pie',p:600},{id:'buns',n:'Buns',p:100},{id:'fish_roll',n:'Fish roll',p:500},
    {id:'cake',n:'Cake',p:800},{id:'small_cake',n:'Small cake',p:200},{id:'chin_sachet',n:'Chin chin (sachet)',p:300},{id:'chin_bag',n:'Chin chin (bag)',p:7500}
  ];

  const $ = id => document.getElementById(id), val = id => Number($(id).value) || 0, setT = (id, t) => $(id).innerText = t, fmt = n => n.toLocaleString();
  let exp = [], editId = null, editExpIdx = null, h = [];

  function init() {
    setNow(); uiDate();

    onSnapshot(doc(db, "settings", "products"), (d) => {
        if(d.exists() && d.data().list) { P = d.data().list; } 
        else { setDoc(doc(db, "settings", "products"), { list: P }); }
        renderProdGrid(); renderProdSettings();
        $('hHead').innerHTML = `<th>Date</th>${P.map(p => `<th>${p.n}</th>`).join('')}<th>Rem</th><th>Prod</th><th>Misc</th><th>Tot</th><th>Exp</th><th>Prof</th><th>Var</th><th>Act</th>`;
        render(); 
    });

    onSnapshot(collection(db, "records"), (snap) => {
      h = snap.docs.map(doc => ({ ...doc.data(), fid: doc.id }));
      render();
    });

    onSnapshot(doc(db, "settings", "capital"), (doc) => {
      if(doc.exists()) { $('pCap').value = doc.data().p || 0; $('mCap').value = doc.data().m || 0; }
      calcCapStatus();
    });
  }

  window.renderProdGrid = function() {
    $('prodGrid').innerHTML = P.map(p => `
      <div class="bg-white rounded p-2 border">
        <label>${p.n} <small class="text-gray-400">(${p.p})</small></label>
        <input type="number" placeholder="Qty" data-id="${p.id}" class="qIn w-full p-1 border rounded mt-1">
        <div class="flex justify-between mt-1"><span class="text-xs">‚Ç¶<span class="lTot">0</span></span>
        <input type="number" placeholder="Rem" class="rIn w-12 p-1 border rounded text-xs" value="0"></div>
      </div>`).join('');
  }

  window.openProdSet = function() { $('prodModal').classList.remove('hidden'); }
  window.renderProdSettings = function() {
      $('prodSetList').innerHTML = P.map((p, i) => `
        <div class="flex justify-between items-center bg-gray-100 p-2 rounded"><span><b>${p.n}</b> (‚Ç¶${p.p})</span><button onclick="delProd(${i})" class="bg-red-500 text-white px-2 rounded text-xs">Del</button></div>
      `).join('');
  }

  window.addProd = async function() {
      const n = $('newPName').value.trim(), p = Number($('newPPrice').value);
      if(!n || !p) return alert("Enter name and price");
      const id = n.toLowerCase().replace(/\s+/g, '_') + '_' + Math.floor(Math.random()*1000);
      await setDoc(doc(db, "settings", "products"), { list: [...P, { id, n, p }] });
      $('newPName').value = ''; $('newPPrice').value = '';
  }

  window.delProd = async function(idx) { if(!confirm("Delete this product?")) return; await setDoc(doc(db, "settings", "products"), { list: P.filter((_, i) => i !== idx) }); }

  window.setNow = function() { const d = new Date(); $('date').value = d.toISOString().split('T')[0]; $('time').value = d.toTimeString().slice(0, 5); }
  
  window.uiDate = function() {
    const t = $('repType').value, d = new Date(), y = d.getFullYear(), m = (d.getMonth() + 1).toString().padStart(2, '0');
    $('dtPick').innerHTML = t === 'monthly' ? `<input id="mPick" type="month" value="${y}-${m}" class="p-1 border rounded text-xs">` :
      t === 'yearly' ? `<input id="yPick" type="number" value="${y}" class="p-1 border rounded text-xs w-16">` : `<input id="sDate" type="date" class="p-1 text-xs"><input id="eDate" type="date" class="p-1 text-xs">`;
    if (t === 'range') { $('sDate').value = `${y}-${m}-01`; $('eDate').value = `${y}-${m}-${d.getDate()}`; }
  }

  window.calc = function() {
    let pTot = 0;
    document.querySelectorAll('.qIn').forEach(i => {
      const p = P.find(x => x.id === i.dataset.id);
      if(p) {
          const rem = Number(i.parentElement.querySelector('.rIn').value) || 0;
          const sQty = Math.max(0, (Number(i.value) || 0) - rem), amt = sQty * p.p;
          i.parentElement.querySelector('.lTot').innerText = fmt(amt); pTot += amt;
      }
    });
    setT('prodTot', fmt(pTot));
    const fl = val('float'), ch = val('cash'), mSale = Math.max(0, ch - fl - pTot), day = pTot + mSale, vari = ch - (fl + day);
    setT('miscSale', fmt(mSale)); setT('dayTot', fmt(day));
    const vEl = $('var'); vEl.innerText = fmt(vari); vEl.style.color = vari === 0 ? 'green' : vari > 0 ? 'blue' : 'red';
    return { pTot, mSale, day, vari, fl, ch };
  }

  window.addExp = function() {
    const d = $('expDesc').value, a = val('expAmt'); if (!d || a <= 0) return alert('Invalid Expense');
    if (editExpIdx !== null) exp[editExpIdx] = { d, a }; else exp.push({ d, a });
    $('expDesc').value = ''; $('expAmt').value = ''; editExpIdx = null; $('expBtn').innerText = 'Add'; renExp();
  }
  
  function renExp() { setT('expTot', fmt(exp.reduce((s, x) => s + x.a, 0))); $('expList').innerHTML = exp.map((x, i) => `<li class="flex justify-between text-xs mt-1"><span>${x.d}: ‚Ç¶${fmt(x.a)}</span><div><button onclick="edExp(${i})" class="bg-gray-400 text-white px-1 mr-1 admin-only">E</button><button onclick="delExp(${i})" class="bg-red-500 text-white px-1 admin-only">X</button></div></li>`).join(''); }
  window.edExp = function(i) { $('expDesc').value = exp[i].d; $('expAmt').value = exp[i].a; editExpIdx = i; $('expBtn').innerText = 'Upd'; }
  window.delExp = function(i) { exp.splice(i, 1); renExp(); }

  window.save = async function() {
    const btn = $('saveBtn');
    btn.disabled = true; 
    btn.innerText = "Saving...";

    try {
        const c = calc();
        if (c.day === 0 && !confirm('Zero sales detected. Are you sure you want to save?')) {
            throw new Error("Cancelled by user");
        }
        
        const dtVal = $('date').value;
        const tmVal = $('time').value || "00:00";
        if(!dtVal) throw new Error("Date is required");

        const isoDate = new Date(`${dtVal}T${tmVal}`).toISOString();
        const exT = exp.reduce((s, x) => s + x.a, 0);
        
        const rec = {
          id: editId || Date.now(), 
          dt: `${dtVal} ${tmVal}`, 
          iso: isoDate,
          items: Array.from(document.querySelectorAll('.qIn')).map(i => ({ id: i.dataset.id, q: Number(i.value) || 0, r: Number(i.parentElement.querySelector('.rIn').value) || 0 })),
          exp, prod: c.pTot, misc: c.mSale, tot: c.day, prof: c.day - exT, var: c.vari, fl: c.fl, ch: c.ch, ed: !!editId
        };

        if (editId) {
          const target = h.find(r => r.id === editId);
          if(target) await setDoc(doc(db, "records", target.fid), rec);
          toast('Updated Cloud');
        } else {
          await addDoc(collection(db, "records"), rec);
          toast('Saved to Cloud');
        }
        editMode(false);
    } catch(e) { 
        if(e.message !== "Cancelled by user") alert("Error: " + e.message); 
    } finally {
        btn.disabled = false;
        btn.innerText = "SAVE RECORD";
    }
  }

  function render() {
    const sorted = h.sort((a, b) => new Date(b.iso) - new Date(a.iso));
    let gS = 0, gP = 0, gM = 0, gPr = 0, gE = 0, pT = P.map(() => 0), rT = 0;

    $('hBody').innerHTML = sorted.length ? sorted.map(r => {
      gS += r.tot; gP += r.prof; gM += r.misc; gPr += r.prod; gE += (r.exp || []).reduce((s, x) => s + x.a, 0);
      return `<tr class="border-b"><td class="p-1 border">${r.dt}${r.ed ? '*' : ''}</td>
        ${P.map((p, i) => { const it = r.items.find(x => x.id === p.id) || { q: 0, r: 0 }; pT[i] += it.q; rT += it.r; return `<td class="border">${it.q || '-'}</td>`; }).join('')}
        <td class="border">${r.items.reduce((s, x) => s + x.r, 0)}</td><td class="border">‚Ç¶${fmt(r.prod)}</td><td class="border">‚Ç¶${fmt(r.misc)}</td>
        <td class="border font-bold">‚Ç¶${fmt(r.tot)}</td><td class="border">‚Ç¶${fmt((r.exp || []).reduce((s, x) => s + x.a, 0))}</td><td class="border">‚Ç¶${fmt(r.prof)}</td>
        <td class="border ${r.var < 0 ? 'text-red-500' : 'text-blue-500'}">‚Ç¶${fmt(r.var)}</td>
        <td class="border flex admin-only"><button onclick="load(${r.id})" class="bg-blue-500 text-white px-1">E</button><button onclick="delRec(${r.id})" class="bg-red-500 text-white px-1 ml-1">X</button></td></tr>`;
    }).join('') : '<tr><td colspan="15" class="text-center p-2">No Cloud Data</td></tr>';

    setT('allSales', fmt(gS)); setT('allProf', fmt(gP));
    $('hFoot').innerHTML = `<tr><td>Totals</td>${pT.map(t => `<td>${fmt(t)}</td>`).join('')}<td>${fmt(rT)}</td><td>‚Ç¶${fmt(gPr)}</td><td>‚Ç¶${fmt(gM)}</td><td>‚Ç¶${fmt(gS)}</td><td>‚Ç¶${fmt(gE)}</td><td>‚Ç¶${fmt(gP)}</td><td></td><td></td></tr>`;
    calcCapStatus();
  }

  window.load = function(id) {
    const r = h.find(x => x.id === id); if (!r) return;
    $('date').value = r.dt.split(' ')[0]; $('time').value = r.dt.split(' ')[1] || '00:00';
    $('float').value = r.fl; $('cash').value = r.ch; exp = r.exp || [];
    P.forEach(p => {
      const it = r.items.find(x => x.id === p.id) || { q: 0, r: 0 }, inp = document.querySelector(`input[data-id="${p.id}"]`);
      if (inp) { inp.value = it.q + it.r; inp.parentElement.querySelector('.rIn').value = it.r; }
    });
    editId = r.id; $('saveBtn').innerText = 'Update Cloud'; $('cancelBtn').classList.remove('hidden'); $('inputCard').classList.add('border-blue-500');
    renExp(); calc(); window.scrollTo(0, 0);
  }

  window.delRec = async function(id) { if(confirm("Delete this record?")) { const r = h.find(x => x.id === id); if(r) { await deleteDoc(doc(db, "records", r.fid)); toast('Deleted', 'e'); } } }
  window.editMode = function(on) { editId = null; $('saveBtn').innerText = 'SAVE RECORD'; $('cancelBtn').classList.add('hidden'); $('inputCard').classList.remove('border-blue-500'); document.querySelectorAll('input').forEach(i => { if (!['pCap', 'mCap'].includes(i.id)) i.value = '' }); exp = []; renExp(); setNow(); calc(); }
  window.saveCap = async function() { await setDoc(doc(db, "settings", "capital"), { p: val('pCap'), m: val('mCap') }); }
  function calcCapStatus() { const p = val('pCap'), m = val('mCap'), tot = p + m, prof = h.reduce((s, r) => s + (r.prof || 0), 0), rem = Math.max(0, tot - prof); setT('cumProfit', fmt(prof)); setT('totCap', fmt(tot)); setT('remCap', fmt(rem) + (rem === 0 && tot > 0 ? ' (Done!)' : '')); }
  
  window.genPDF = function() {
    const t = $('repType').value, sorted = h.sort((a, b) => new Date(a.iso) - new Date(b.iso));
    let sub = sorted, name = "Report";
    if (t === 'monthly') { const [y, m] = $('mPick').value.split('-'); sub = sorted.filter(r => r.iso.startsWith(`${y}-${m}`)); name += `_${y}-${m}`; }
    else if (t === 'yearly') { sub = sorted.filter(r => r.iso.startsWith($('yPick').value)); name += `_${$('yPick').value}`; }
    else { const s = new Date($('sDate').value), e = new Date($('eDate').value); e.setHours(23, 59, 59); sub = sorted.filter(r => { const d = new Date(r.iso); return d >= s && d <= e }); }

    if (!sub.length) return alert('No records');
    const { jsPDF } = window.jspdf, doc = new jsPDF('l'), N = '‚Ç¶', head = [['Date', ...P.map(p => p.n), 'Rem', `Prod(${N})`, `Misc(${N})`, `Tot(${N})`, `Exp(${N})`, `Prof(${N})`, `Var(${N})`]];
    let gS = 0, gE = 0, gP = 0;
    const body = sub.map(r => {
      gS += r.tot; gE += (r.exp || []).reduce((s, x) => s + x.a, 0); gP += r.prof;
      return [r.dt.split(' ')[0], ...P.map(p => (r.items.find(x => x.id === p.id) || { q: 0 }).q || '-'), r.items.reduce((s, x) => s + x.r, 0), fmt(r.prod), fmt(r.misc), fmt(r.tot), fmt((r.exp || []).reduce((s, x) => s + x.a, 0)), fmt(r.prof), fmt(r.var)];
    });
    doc.autoTable({ head, body, foot: [['TOTALS', ...P.map(() => ''), '', '', '', fmt(gS), fmt(gE), fmt(gP), '']], startY: 20, theme: 'striped', styles: { fontSize: 8 } });
    doc.text(`Starbite ${t.toUpperCase()} Report`, 14, 15); doc.save(`Starbite_${name}.pdf`);
  }

  window.expCSV = function() {
    if (!h.length) return alert('No Data');
    const csv = [['Date', ...P.map(p => p.n), 'Remains', 'Prod', 'Misc', 'Total', 'Exp', 'Profit', 'Var', 'InHand', 'Float']].concat(h.map(r => [r.dt, ...P.map(p => (r.items.find(x => x.id === p.id) || { q: 0 }).q), r.items.reduce((s, x) => s + x.r, 0), r.prod, r.misc, r.tot, (r.exp || []).reduce((s, x) => s + x.a, 0), r.prof, r.var, r.ch, r.fl])).map(r => r.join(',')).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = 'starbite_cloud_data.csv'; a.click();
  }

  window.wipe = async function() { if (confirm('Delete ALL history?')) { const snap = await getDocs(collection(db, "records")); snap.forEach(d => deleteDoc(doc(db, "records", d.id))); toast('Cloud Cleared', 'e'); } }
  function toast(m, t = 's') { const el = $('toast'); el.className = t + ' show'; el.innerText = m; setTimeout(() => el.classList.remove('show'), 3000); }
  
  window.$ = $;
  init();
</script>
</body>
</html>
</textarea>

<textarea id="code3" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STARBITE Pro: Charging</title>
  <style>
    /* SECURITY */
    body.is-staff .admin-only { display: none !important; }

    :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --bg: #f4f7f6; --dark: #343a40; }
    body { font-family: 'Segoe UI', sans-serif; margin: 15px; background-color: var(--bg); padding-bottom: 70px; }
    
    /* CARDS */
    .dash-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .dash-card { flex: 1; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid transparent; }
    .dash-val { font-size: 20px; font-weight: 900; color: #333; margin-top: 5px; }
    .d-green { border-bottom-color: var(--success); } .d-green .dash-val { color: var(--success); }
    .d-blue { border-bottom-color: var(--primary); } .d-blue .dash-val { color: var(--primary); }
    .d-purp { border-bottom-color: #6f42c1; } .d-purp .dash-val { color: #6f42c1; }
    
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .settings-card { background: #fff3cd; border: 1px solid #ffeeba; }
    
    h2, h3 { color: var(--primary); margin: 0 0 10px 0; }
    input, button, select { padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
    
    button { cursor: pointer; background-color: var(--primary); color: white; border: none; font-weight: bold; transition: 0.2s; }
    button:active { transform: scale(0.98); }
    .btn-print { background-color: var(--dark); color: #fff; }
    .btn-edit { background-color: var(--warning); color: #000; }
    .btn-shelf { background-color: #6c757d; color: #fff; }
    .btn-wa { background-color: #25D366; color: white; font-weight: 900; }
    
    .row { display: flex; gap: 8px; align-items: center; }
    .device-box { flex: 1; text-align: center; background: #f8f9fa; padding: 5px; border-radius: 8px; border: 1px solid #eee; }
    .device-box label { font-size: 11px; display: block; color: #666; }
    
    /* TICKET STYLES */
    .ticket { border-left: 6px solid var(--primary); padding: 12px; margin-bottom: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
    .timer-area { background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .time-val { font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; color: #333; }
    .time-val.danger { color: #d32f2f; font-weight: 900; font-size: 20px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .code-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 14px; font-weight: bold; }
    
    .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px; color: white; font-size: 12px; z-index: 100; }
    .on { background: var(--success); } .off { background: var(--danger); }
    
    /* MODALS */
    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    
    /* COLLECTION MODAL SPECIFIC */
    .collect-row { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px 0; }
    .collect-label { font-weight:bold; }
    .collect-info { font-size:12px; color:#666; }
    .collect-input { width:60px !important; text-align:center; padding:5px !important; margin:0 !important; }

    /* RECEIPT STYLES */
    #receiptPreview { 
        font-family: 'Courier New', monospace; text-align: center; border: 4px double #333; padding: 15px; margin-bottom: 15px; 
        background: #fff; color: black; position: relative; overflow: hidden;
    }
    #receiptPreview::before {
        content: "VOID IF ALTERED"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 24px; color: rgba(0,0,0,0.05); white-space: nowrap; pointer-events: none;
    }
    .r-code-box { border: 3px solid #000; padding: 5px; margin: 10px auto; display: inline-block; }
    .r-code-text { font-size: 28px; font-weight: 900; letter-spacing: 2px; }
    .r-cut-line { border-top: 2px dashed #000; margin: 20px 0 10px 0; position: relative; }
    .r-cut-line::after { content: '‚úÇÔ∏è DEVICE LABELS ‚úÇÔ∏è'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 0 5px; font-size: 10px; }
    .sticker-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    .sticker { background: #000; color: #fff; padding: 4px 8px; font-weight: bold; font-size: 18px; }
    .secure-hash { font-size: 9px; color: #555; border-top: 1px solid #ccc; margin-top: 5px; padding-top: 2px; letter-spacing: 1px; }

    .pill-paid { background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .pill-owe { background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .pill-part { background: #e2e3e5; color: #383d41; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }

    @media print { 
        body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } 
        #printArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; } 
        .modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; display: block !important; } 
        .modal-content { width: 100%; margin: 0; padding: 0; box-shadow: none; } button, h3 { display: none !important; } 
    }
  </style>
</head>
<body>

  <h2>‚ö°Ô∏è STARBITE CHARGING</h2>

  <details class="card settings-card admin-only">
    <summary style="font-weight:bold; cursor:pointer;">‚öôÔ∏è Update Standard Prices</summary>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <div class="device-box"><label>1 PHONE ‚Ç¶</label><input type="number" id="setPh" value="200"></div>
      <div class="device-box"><label>1 P-BANK ‚Ç¶</label><input type="number" id="setPb" value="300"></div>
    </div>
    <p style="font-size:11px; color:#666; margin-top:5px;">Note: "Others" price is entered manually.</p>
    <button onclick="saveSettings()" class="btn-edit" style="width:100%; margin-top:5px;">üíæ SAVE PRICES GLOBALLY</button>
  </details>

  <div class="dash-row">
    <div class="dash-card d-green admin-only"><h4>Cash Today</h4><div class="dash-val" id="valCash">‚Ç¶0</div></div>
    <div class="dash-card d-blue admin-only"><h4>Pending</h4><div class="dash-val" id="valPending">‚Ç¶0</div></div>
    <div class="dash-card d-purp"><h4>Active Devices</h4><div class="dash-val" id="valCount">0</div></div>
  </div>

  <div class="card">
    <h3 id="formAction">New Customer</h3>
    <div style="display:flex; gap:5px;">
        <input type="text" id="custName" placeholder="Customer Name *" style="flex:2">
        <input type="tel" id="custPhone" placeholder="Phone (Optional)" style="flex:1">
    </div>
    
    <div class="row">
        <select id="payStatus" style="flex:1">
            <option value="Later">Pay Later ‚è≥</option>
            <option value="Now">Paid Now üí∞</option>
        </select>
    </div>

    <div class="row">
      <div class="device-box"><label>PHONES</label><input type="number" id="phCount" value="0" min="0"></div>
      <div class="device-box"><label>P-BANKS</label><input type="number" id="pbCount" value="0" min="0"></div>
    </div>

    <div class="row" style="margin-top:5px; background:#fff3cd; padding:5px; border-radius:5px;">
      <div class="device-box" style="background:transparent; border:none;">
          <label style="color:#856404; font-weight:bold;">OTHERS QTY</label>
          <input type="number" id="otCount" value="0" min="0" placeholder="0">
      </div>
      <div class="device-box" style="background:transparent; border:none; flex:2;">
          <label style="color:#856404; font-weight:bold;">OTHERS PRICE (‚Ç¶)</label>
          <input type="number" id="otPrice" value="0" min="0" placeholder="Enter Price">
      </div>
    </div>
    
    <input type="number" id="price" value="0" placeholder="Total Price (Auto)" style="font-weight:bold; color:#007bff;">
    
    <button onclick="saveTicket()" id="saveBtn">‚úÖ START CHARGING</button>
    <button id="cancelEditBtn" style="display:none; background:#666;" onclick="cancelEdit()">Cancel Edit</button>
  </div>

  <h3>Charging Now (<span id="countActive">0</span>)</h3>
  <div id="listActive">Loading...</div>

  <details class="card">
    <summary>üì¶ Customer History & Search</summary>
    <div style="padding-top:10px;">
        <input type="text" id="histSearch" placeholder="Search Name or #Code..." oninput="render()">
        <div id="listHistory" style="margin-top:10px;"></div>
    </div>
  </details>

  <div id="status" class="off">Offline</div>

  <div id="modalPrint" class="modal">
    <div class="modal-content" id="printArea">
      <div id="receiptPreview"></div>
      <div style="display:flex; gap:10px; margin-top:5px;">
          <button class="btn-print" style="flex:1;" onclick="window.print()">üñ®Ô∏è PRINT</button>
          <button class="btn-wa" style="flex:2;" onclick="sendWAText()">üì± WHATSAPP</button>
      </div>
      <button style="background:#666; margin-top:5px; width:100%" onclick="document.getElementById('modalPrint').style.display='none'">Close</button>
    </div>
  </div>

  <div id="mod-collect" class="modal">
    <div class="modal-content">
        <h3>üì¶ Device Collection</h3>
        <p style="font-size:12px; color:#666;">Enter quantity being collected <b>NOW</b>:</p>
        
        <input type="hidden" id="col-id">
        
        <div class="collect-row" id="row-ph">
            <div>
                <div class="collect-label">Phones</div>
                <div class="collect-info">Total: <span id="col-tot-ph">0</span> | Left: <span id="col-rem-ph">0</span></div>
            </div>
            <input type="number" id="in-col-ph" class="collect-input" value="0" min="0">
        </div>

        <div class="collect-row" id="row-pb">
            <div>
                <div class="collect-label">P-Banks</div>
                <div class="collect-info">Total: <span id="col-tot-pb">0</span> | Left: <span id="col-rem-pb">0</span></div>
            </div>
            <input type="number" id="in-col-pb" class="collect-input" value="0" min="0">
        </div>

        <div class="collect-row" id="row-ot">
            <div>
                <div class="collect-label">Others</div>
                <div class="collect-info">Total: <span id="col-tot-ot">0</span> | Left: <span id="col-rem-ot">0</span></div>
            </div>
            <input type="number" id="in-col-ot" class="collect-input" value="0" min="0">
        </div>

        <button class="btn-green" onclick="confirmCollect()">‚úÖ Confirm Collection</button>
        <button class="btn-blue" style="margin-top:5px;" onclick="quickCollectAll()">üöÄ Collect ALL Remaining</button>
        <button class="btn-red" style="margin-top:5px;" onclick="document.getElementById('mod-collect').style.display='none'">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // [[INJECT_CONFIG]]
    
    // APPLY SECURITY
    if(typeof USER_ROLE !== 'undefined' && USER_ROLE === 'staff') {
        document.body.classList.add('is-staff');
    }

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const col = collection(db, "tickets");

    let priceConfig = { ph: 200, pb: 300 };

    async function initPrices() {
        try {
            const docRef = doc(db, "config", "prices");
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                priceConfig = snap.data();
                document.getElementById('setPh').value = priceConfig.ph;
                document.getElementById('setPb').value = priceConfig.pb;
            } else {
                await setDoc(docRef, priceConfig);
            }
            autoCalc();
        } catch(e) { console.error("Price load error", e); }
    }
    initPrices();

    window.saveSettings = async () => {
        const newPrices = {
            ph: Number(document.getElementById('setPh').value),
            pb: Number(document.getElementById('setPb').value)
        };
        try {
            await setDoc(doc(db, "config", "prices"), newPrices);
            priceConfig = newPrices;
            autoCalc();
            alert("‚úÖ Prices Saved Globally!");
        } catch(e) { alert("Error: " + e.message); }
    };

    window.autoCalc = () => {
        const ph = Number(document.getElementById('phCount').value) || 0;
        const pb = Number(document.getElementById('pbCount').value) || 0;
        const otPrice = Number(document.getElementById('otPrice').value) || 0;
        const total = (ph * priceConfig.ph) + (pb * priceConfig.pb) + otPrice;
        document.getElementById('price').value = total;
    };

    ['phCount', 'pbCount', 'otPrice'].forEach(id => {
        document.getElementById(id).addEventListener('input', window.autoCalc);
    });

    let ticketsData = [], editId = null;
    let currentReceiptData = null;

    onSnapshot(query(col, orderBy("ts", "desc")), (snap) => { 
        ticketsData = snap.docs.map(d => ({ ...d.data(), id: d.id, jsDate: d.data().ts ? d.data().ts.toDate() : new Date() })); 
        render(); 
    });
    
    function getNextSockets(neededCount) {
        const active = ticketsData.filter(t => !t.collected);
        const used = active.flatMap(t => t.sockets || []); 
        const assigned = [];
        let candidate = 1;
        while(assigned.length < neededCount) {
            if(!used.includes(candidate)) { assigned.push(candidate); }
            candidate++;
        }
        return assigned;
    }

    function genSecCode(id, price) {
        return `SEC-${id.substring(0,4).toUpperCase()}-${price}-${Math.floor(Math.random()*99)}`;
    }

    window.saveTicket = async () => { 
        const name = document.getElementById('custName').value.trim(); 
        const phone = document.getElementById('custPhone').value.trim();
        if(!name) return alert("Name required"); 
        
        const payStatus = document.getElementById('payStatus').value;
        const ticketCode = Math.floor(1000 + Math.random() * 9000); 
        
        const ph = +document.getElementById('phCount').value;
        const pb = +document.getElementById('pbCount').value;
        const ot = +document.getElementById('otCount').value; 
        const otPrice = +document.getElementById('otPrice').value;
        
        const socketsNeeded = ph + pb + ot; 
        let assignedSockets = [];
        if(!editId) {
             assignedSockets = getNextSockets(socketsNeeded); 
        }

        const data = { 
            name, phone, sockets: assignedSockets, payStatus, code: ticketCode, 
            ph, pb, ot, otPrice,
            // Track Collection Progress
            colPh: 0, colPb: 0, colOt: 0,
            price: +document.getElementById('price').value, collected: false 
        }; 

        try { 
            if(editId) { 
                const { code, sockets, ...uData } = data;
                // Don't overwrite existing collection progress on edit unless necessary
                // For simplicity in edit, we keep existing counts if they exist
                const existing = ticketsData.find(x => x.id === editId);
                if(existing) {
                    uData.colPh = existing.colPh || 0;
                    uData.colPb = existing.colPb || 0;
                    uData.colOt = existing.colOt || 0;
                }
                await updateDoc(doc(db, "tickets", editId), uData); 
                cancelEdit(); 
            } else { 
                const docRef = await addDoc(col, { ...data, charged: false, ts: serverTimestamp() }); 
                const secCode = genSecCode(docRef.id, data.price);
                await updateDoc(doc(db, "tickets", docRef.id), { secCode });
                resetForm(); 
                openPrintModal(docRef.id, { ...data, secCode }, ticketCode); 
            } 
        } catch(e) { alert(e.message); } 
    };

    window.startEdit = (id) => { 
        const t = ticketsData.find(x => x.id === id); 
        editId = id; 
        document.getElementById('custName').value = t.name; 
        document.getElementById('custPhone').value = t.phone || "";
        document.getElementById('payStatus').value = t.payStatus || "Later"; 
        document.getElementById('phCount').value = t.ph || 0; 
        document.getElementById('pbCount').value = t.pb || 0; 
        document.getElementById('otCount').value = t.ot || 0; 
        document.getElementById('otPrice').value = t.otPrice || 0; 
        document.getElementById('price').value = t.price; 
        document.getElementById('formAction').innerText = "Editing Ticket"; 
        document.getElementById('saveBtn').innerText = "üíæ UPDATE"; 
        document.getElementById('cancelEditBtn').style.display = "block"; 
    };

    window.cancelEdit = () => { editId = null; resetForm(); document.getElementById('formAction').innerText = "New Customer"; document.getElementById('saveBtn').innerText = "‚úÖ START CHARGING"; document.getElementById('cancelEditBtn').style.display = "none"; };
    
    window.moveToShelf = async (id) => {
        if(confirm("Device full? Move to Shelf and free socket?")) {
            await updateDoc(doc(db, "tickets", id), { sockets: [] });
        }
    };

    window.deleteTicket = async (id) => {
        if(confirm("Permanently delete this ticket record?")) {
            await deleteDoc(doc(db, "tickets", id));
        }
    };

    // === PARTIAL COLLECTION LOGIC ===

    window.openCollect = (id) => {
        const t = ticketsData.find(x => x.id === id);
        if(!t) return;
        
        document.getElementById('col-id').value = id;
        
        // Setup Phones
        const remPh = (t.ph || 0) - (t.colPh || 0);
        document.getElementById('col-tot-ph').innerText = t.ph || 0;
        document.getElementById('col-rem-ph').innerText = remPh;
        document.getElementById('in-col-ph').max = remPh;
        document.getElementById('in-col-ph').value = 0;
        document.getElementById('row-ph').style.display = (t.ph > 0 && remPh > 0) ? 'flex' : 'none';

        // Setup PB
        const remPb = (t.pb || 0) - (t.colPb || 0);
        document.getElementById('col-tot-pb').innerText = t.pb || 0;
        document.getElementById('col-rem-pb').innerText = remPb;
        document.getElementById('in-col-pb').max = remPb;
        document.getElementById('in-col-pb').value = 0;
        document.getElementById('row-pb').style.display = (t.pb > 0 && remPb > 0) ? 'flex' : 'none';

        // Setup Others
        const remOt = (t.ot || 0) - (t.colOt || 0);
        document.getElementById('col-tot-ot').innerText = t.ot || 0;
        document.getElementById('col-rem-ot').innerText = remOt;
        document.getElementById('in-col-ot').max = remOt;
        document.getElementById('in-col-ot').value = 0;
        document.getElementById('row-ot').style.display = (t.ot > 0 && remOt > 0) ? 'flex' : 'none';

        document.getElementById('mod-collect').style.display = 'flex';
    };

    window.quickCollectAll = async () => {
        const id = document.getElementById('col-id').value;
        const t = ticketsData.find(x => x.id === id);
        if(confirm("Confirm user collected EVERYTHING?")) {
            await updateDoc(doc(db, "tickets", id), { 
                colPh: t.ph || 0, colPb: t.pb || 0, colOt: t.ot || 0,
                collected: true, collDate: new Date().toLocaleDateString() 
            });
            document.getElementById('mod-collect').style.display = 'none';
        }
    };

    window.confirmCollect = async () => {
        const id = document.getElementById('col-id').value;
        const t = ticketsData.find(x => x.id === id);
        
        const takePh = Number(document.getElementById('in-col-ph').value) || 0;
        const takePb = Number(document.getElementById('in-col-pb').value) || 0;
        const takeOt = Number(document.getElementById('in-col-ot').value) || 0;

        if(takePh === 0 && takePb === 0 && takeOt === 0) return alert("Please select items to collect.");

        const newColPh = (t.colPh || 0) + takePh;
        const newColPb = (t.colPb || 0) + takePb;
        const newColOt = (t.colOt || 0) + takeOt;

        // Check if fully collected
        const isFullyCollected = (newColPh >= (t.ph||0)) && (newColPb >= (t.pb||0)) && (newColOt >= (t.ot||0));
        
        const updateData = {
            colPh: newColPh, colPb: newColPb, colOt: newColOt
        };

        if(isFullyCollected) {
            updateData.collected = true;
            updateData.collDate = new Date().toLocaleDateString();
        }

        await updateDoc(doc(db, "tickets", id), updateData);
        document.getElementById('mod-collect').style.display = 'none';
    };

    window.revertCollection = async (id) => { 
        if(confirm("Re-Activate Ticket?")) {
            // Reset collection counts to 0 when reverting
            await updateDoc(doc(db, "tickets", id), { collected: false, colPh:0, colPb:0, colOt:0 }); 
        }
    };

    function render() { 
        const term = document.getElementById('histSearch').value.toLowerCase(); 
        const active = ticketsData.filter(t => !t.collected); 
        const history = ticketsData.filter(t => t.collected && (t.name.toLowerCase().includes(term) || (t.code+"").includes(term))); 
        document.getElementById('countActive').innerText = active.length; 
        document.getElementById('listActive').innerHTML = active.map(t => ticketHtml(t, false)).join(''); 
        document.getElementById('listHistory').innerHTML = (term==="" ? history.slice(0,5) : history).map(t => ticketHtml(t, true)).join(''); 
        
        const todayStr = new Date().toLocaleDateString(); 
        const todaysCash = ticketsData.filter(t => { const isToday = (t.collDate === todayStr) || (t.jsDate.toLocaleDateString() === todayStr); const isPaid = t.collected || t.payStatus === 'Now'; return isToday && isPaid; }).reduce((sum, t) => sum + (t.price || 0), 0);
        const pendingCash = active.filter(t => t.payStatus !== 'Now').reduce((sum, t) => sum + (t.price || 0), 0); 
        const todaysCount = ticketsData.filter(t => (t.collDate === todayStr || t.jsDate.toLocaleDateString() === todayStr)).reduce((sum, t) => sum + (t.ph||0) + (t.pb||0) + (t.ot||0), 0); 
        
        document.getElementById('valCash').innerText = "‚Ç¶" + todaysCash.toLocaleString(); 
        document.getElementById('valPending').innerText = "‚Ç¶" + pendingCash.toLocaleString(); 
        document.getElementById('valCount').innerText = active.reduce((s, t) => {
            // Active count = Total items - Collected items
            const left = (t.ph||0 + t.pb||0 + t.ot||0) - (t.colPh||0 + t.colPb||0 + t.colOt||0);
            return s + left;
        }, 0);
        updateTimers(); 
    }

    function ticketHtml(t, isHistory) { 
        const code = t.code || '----'; 
        let sockStr = "";
        
        if (!t.collected && (!t.sockets || t.sockets.length === 0)) {
            sockStr = `<span style="color:#666; font-weight:bold; background:#eee; padding:2px 5px; border-radius:4px;">[SHELF üì¶]</span>`;
        } else if(t.sockets && Array.isArray(t.sockets) && t.sockets.length > 0) { 
            sockStr = `[Sockets: ${t.sockets.join(', ')}]`; 
        } else if (t.socket) { 
            sockStr = `[Socket: ${t.socket}]`; 
        }

        const badge = t.payStatus === 'Now' ? '<span class="pill-paid">PAID</span>' : '<span class="pill-owe">OWE</span>';
        
        // Calculate Remainders
        const rPh = (t.ph||0) - (t.colPh||0);
        const rPb = (t.pb||0) - (t.colPb||0);
        const rOt = (t.ot||0) - (t.colOt||0);
        
        // If some items collected, show a "Partial" badge
        const partial = ((t.colPh||0)+(t.colPb||0)+(t.colOt||0) > 0 && !t.collected) ? '<span class="pill-part">PARTIAL</span>' : '';

        // Display string logic
        let devStr = "";
        if(rPh > 0) devStr += `üì±${rPh}/${t.ph} `;
        if(rPb > 0) devStr += `üîã${rPb}/${t.pb} `;
        if(rOt > 0) devStr += `üî¶${rOt}/${t.ot} `;

        if(isHistory) return `<div class="ticket history-style">
            <b>${t.name}</b> <span class="code-badge">#${code}</span> ${badge}<br>
            <small>Out: ${t.collDate||'?'}</small> 
            <div style="float:right;">
                <button style="padding:5px; margin-right:5px;" onclick="revertCollection('${t.id}')">‚Ü©Ô∏è</button>
                <button class="btn-red btn-tbl admin-only" onclick="deleteTicket('${t.id}')">üóëÔ∏è</button>
            </div>
        </div>`; 
        
        const plugTime = t.jsDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
        
        return `<div class="ticket">
            <div style="display:flex; justify-content:space-between"><div><b>${t.name}</b> ${sockStr}</div><div>${badge} ${partial} <span class="code-badge">#${code}</span></div></div>
            <div class="timer-area"><span>In: ${plugTime}</span><span class="time-val" id="timer-${t.id}">0h 0m</span></div>
            <small>${devStr} | ‚Ç¶${t.price}</small>
            <div class="row" style="margin-top:5px">
                <button class="btn-print" onclick="openPrintModal('${t.id}')">üñ®Ô∏è</button>
                <button class="btn-edit" onclick="startEdit('${t.id}')">‚úèÔ∏è</button>
                <button class="btn-shelf" onclick="moveToShelf('${t.id}')">üîå</button>
                <button style="background:var(--success)" onclick="openCollect('${t.id}')">Collect</button>
            </div>
        </div>`; 
    }

    function updateTimers() { const now = new Date(); ticketsData.filter(t => !t.collected).forEach(t => { const el = document.getElementById(`timer-${t.id}`); if(!el) return; const diffMins = Math.floor((now - t.jsDate) / 60000); const h = Math.floor(diffMins / 60), m = diffMins % 60; el.innerText = `${h}h ${m}m`; if (h >= 3) el.classList.add('danger'); else el.classList.remove('danger'); }); } setInterval(updateTimers, 1000);
    
    window.openPrintModal = (id, data=null, newCode=null) => { 
        let t = data, dObj = new Date(), code = newCode; 
        if(!t) { 
            const found = ticketsData.find(x => x.id === id); 
            if(found) { t = found; dObj = found.jsDate; code = found.code; } 
        } 
        currentReceiptData = { ...t, code, dObj };
        
        const secCode = t.secCode || genSecCode(id, t.price);
        const stickerCount = (t.ph || 0) + (t.pb || 0) + (t.ot || 0); 
        let stickersHTML = ""; for(let i=0; i<stickerCount; i++) stickersHTML += `<div class="sticker">#${code}</div>`; 
        const payTxt = t.payStatus === 'Now' ? "PAID" : "pay latter";
        const socketDisplay = (t.sockets && Array.isArray(t.sockets)) ? t.sockets.join(', ') : (t.socket || "N/A");

        document.getElementById('receiptPreview').innerHTML = `
            <div class="r-header">STARBITE CHARGING</div><div class="r-date">${dObj.toLocaleString()}</div>
            <div class="r-code-box"><div class="r-code-text">#${code}</div></div>
            <div style="text-align:left; font-size:14px; margin:10px 0;"><div><b>Customer:</b> ${t.name.toUpperCase()}</div><div style="font-weight:bold; font-size:16px; margin:5px 0;">Sockets: ${socketDisplay}</div>
            <div class="r-row"><span>Items:</span><span>${stickerCount}</span></div>
            <div style="border-top:1px dashed #000; font-weight:bold; margin-top:5px; display:flex; justify-content:space-between;"><span>TOTAL:</span><span>‚Ç¶${t.price} (${payTxt})</span></div>
            <div class="secure-hash">SECURE ID: ${secCode}</div>
            <div style="text-align:center; font-style:italic; font-size:11px; margin-top:10px; border:1px solid #ccc; padding:3px;">NOTE: Check your device before leaving.</div></div>
            <div class="r-cut-line"></div><div class="sticker-container">${stickersHTML}</div>`; 
        document.getElementById('modalPrint').style.display = 'flex'; 
    };

    window.sendWAText = () => {
        if(!currentReceiptData) return;
        const t = currentReceiptData;
        const payTxt = t.payStatus === 'Now' ? "PAID" : "pay later";
        let phone = t.phone ? t.phone.replace(/\D/g, '') : '';
        if(phone.startsWith('0')) phone = '234' + phone.substring(1);
        const secCode = t.secCode || "N/A";
        const text = `üßæ *STARBITE CHARGING RECEIPT*\n` +
                     `üìÖ Date: ${t.dObj.toLocaleDateString()} ${t.dObj.toLocaleTimeString()}\n` +
                     `üë§ Customer: ${t.name}\n` +
                     `üéü Ticket: *#${t.code}*\n` +
                     `----------------\n` +
                     `üì± Phones: ${t.ph}\n` +
                     `üîã P-Banks: ${t.pb}\n` +
                     `üî¶ Others: ${t.ot || 0}\n` +
                     `----------------\n` +
                     `üí∞ *TOTAL: ‚Ç¶${t.price} (${payTxt})*\n` +
                     `üîí Secure ID: ${secCode}\n` +
                     `----------------\n` +
                     `Please collect your device with code #${t.code}.`;
        
        const baseUrl = phone ? `https://wa.me/${phone}` : `https://wa.me/`;
        window.open(`${baseUrl}?text=${encodeURIComponent(text)}`, '_blank');
    }

    window.collectAll = async (id) => { if(confirm("Mark as Collected?")) await updateDoc(doc(db, "tickets", id), { collected: true, collDate: new Date().toLocaleDateString() }); };
    
    function resetForm() { 
        document.getElementById('custName').value = ""; 
        document.getElementById('custPhone').value = ""; 
        document.getElementById('payStatus').value = "Later"; 
        document.getElementById('phCount').value = 0; 
        document.getElementById('pbCount').value = 0; 
        document.getElementById('otCount').value = 0; 
        document.getElementById('otPrice').value = 0; 
        autoCalc();
    }
    
    const upSt = () => { document.getElementById('status').className = navigator.onLine ? "status-bar on" : "status-bar off"; document.getElementById('status').innerText = navigator.onLine ? "CONNECTED" : "OFFLINE"; };
    window.addEventListener('online', upSt); window.addEventListener('offline', upSt); upSt(); window.render = render;
  </script>
</body>
</html>
</textarea>

<textarea id="code4" style="display:none;">
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #222; color: white; padding: 20px; text-align: center; }
        .master-card { background: #333; padding: 20px; margin: 10px 0; border-radius: 15px; border: 1px solid #444; }
        h1 { margin: 0 0 20px 0; color: #ffc107; text-transform: uppercase; letter-spacing: 2px; }
        .big-val { font-size: 32px; font-weight: bold; display: block; margin-top: 5px; }
        .sub-val { font-size: 14px; color: #aaa; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .chart-box { background: #fff; border-radius: 10px; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>üëë Master View (Today)</h1>
    
    <div class="master-card" style="border-color: #28a745;">
        <span class="sub-val">TOTAL NET CASH</span>
        <span class="big-val" style="color: #28a745;" id="m-net">Loading...</span>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr 1fr;">
        <div class="master-card">
            <span class="sub-val">SHOP SALES</span>
            <span class="big-val" id="m-shop">0</span>
        </div>
        <div class="master-card">
            <span class="sub-val">CHARGING</span>
            <span class="big-val" id="m-charge">0</span>
        </div>
        <div class="master-card" style="border-color: #dc3545;">
            <span class="sub-val">EXPENSES</span>
            <span class="big-val" style="color: #dc3545;" id="m-exp">0</span>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="chart-box">
            <canvas id="pieChart"></canvas>
        </div>
        <div class="chart-box">
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // [[INJECT_CONFIG]]

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let shopTotal = 0, chargeTotal = 0, expTotal = 0;
        let pChart, bChart;

        function updateMaster() {
            // Net calculation excludes Recorder Sales, but includes Expenses
            const net = (shopTotal + chargeTotal) - expTotal;
            document.getElementById('m-net').innerText = "‚Ç¶" + net.toLocaleString();
            document.getElementById('m-shop').innerText = "‚Ç¶" + shopTotal.toLocaleString();
            document.getElementById('m-charge').innerText = "‚Ç¶" + chargeTotal.toLocaleString();
            document.getElementById('m-exp').innerText = "‚Ç¶" + expTotal.toLocaleString();
            updateCharts();
        }

        function updateCharts() {
            if(pChart) pChart.destroy();
            if(bChart) bChart.destroy();

            const ctxP = document.getElementById('pieChart').getContext('2d');
            pChart = new Chart(ctxP, {
                type: 'pie',
                data: {
                    labels: ['Shop', 'Charging', 'Expenses'],
                    datasets: [{
                        data: [shopTotal, chargeTotal, expTotal],
                        backgroundColor: ['#007bff', '#28a745', '#dc3545']
                    }]
                },
                options: { plugins: { title: { display: true, text: 'Today Income Source' } } }
            });

            const ctxB = document.getElementById('barChart').getContext('2d');
            bChart = new Chart(ctxB, {
                type: 'bar',
                data: {
                    labels: ['Total Revenue', 'Net Profit'],
                    datasets: [{
                        label: 'Amount (‚Ç¶)',
                        data: [shopTotal + chargeTotal, (shopTotal + chargeTotal) - expTotal],
                        backgroundColor: ['#17a2b8', '#ffc107']
                    }]
                },
                options: { plugins: { title: { display: true, text: 'Financial Overview' } } }
            });
        }

        const today = new Date().toISOString().split('T')[0];

        // 1. Listen to Shop Sales (Cash only + Debt Payments)
        onSnapshot(collection(db, "sales"), (snap) => {
            shopTotal = snap.docs
                .map(d => d.data())
                .filter(s => s.date.startsWith(today))
                .reduce((a, b) => a + (b.total || 0), 0);
            updateMaster();
        });

        // 2. Listen to Charging Tickets
        onSnapshot(collection(db, "tickets"), (snap) => {
            const todayStr = new Date().toLocaleDateString();
            chargeTotal = snap.docs
                .map(d => { const dt = d.data(); return { ...dt, jsDate: dt.ts ? dt.ts.toDate() : new Date() }; })
                .filter(t => {
                    const isToday = (t.collDate === todayStr) || (t.jsDate.toLocaleDateString() === todayStr);
                    const isPaid = t.collected || t.payStatus === 'Now';
                    return isToday && isPaid;
                })
                .reduce((a, b) => a + (b.price || 0), 0);
            updateMaster();
        });

        // 3. Listen to Recorder (ONLY FOR EXPENSES)
        onSnapshot(collection(db, "records"), (snap) => {
            const recs = snap.docs.map(d => d.data()).filter(r => r.dt.startsWith(today));
            // Calculate expenses only
            const recExp = recs.reduce((sum, r) => sum + (r.exp || []).reduce((eSum, e) => eSum + e.a, 0), 0);
            expTotal = recExp; 
            updateMaster();
        });

    </script>
</body>
</html>
</textarea>

</body>
</html>
