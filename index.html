<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STARBITE All-in-One Cloud System</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- SECURITY LOCK SCREEN --- */
    #securityOverlay { position: fixed; inset: 0; background: #1e3a8a; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    .pin-dot { width: 15px; height: 15px; background: rgba(255,255,255,0.3); border-radius: 50%; margin: 0 5px; transition: 0.2s; }
    .pin-dot.filled { background: #fff; transform: scale(1.2); }
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 30px; }
    .key { width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; transition: 0.2s; border: 2px solid rgba(255,255,255,0.2); }
    .key:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
    .key-del { background: transparent; border-color: transparent; color: #fca5a5; font-size: 18px; }

    /* Global Tab Styles */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .nav-btn { transition: 0.3s; }
    .nav-btn.active { background-color: white; color: #1e40af; border-bottom: 4px solid #1e40af; }

    /* File 1 Styles (Debtor) */
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    .s-full { background-color: #d1fae5; } .s-part { background-color: #fef3c7; } .s-over { background-color: #fee2e2; }

    /* File 2 Styles (Production) */
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; color: white; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.3s; }
    #toast.show { opacity: 1; visibility: visible; }
    .s { background:#28a745; } .e { background:#dc3545; }

    /* File 3 Styles (Charging) */
    :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --bg: #f4f7f6; --dark: #343a40; --purple: #6f42c1; }
    .dash-row { display: flex; gap: 10px; margin-bottom: 15px; }
    .dash-card { flex: 1; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid transparent; }
    .dash-card h4 { margin: 0; font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
    .dash-val { font-size: 20px; font-weight: 900; color: #333; margin-top: 5px; }
    .d-green { border-bottom-color: var(--success); } .d-green .dash-val { color: var(--success); }
    .d-blue { border-bottom-color: var(--primary); } .d-blue .dash-val { color: var(--primary); }
    .d-purp { border-bottom-color: var(--purple); } .d-purp .dash-val { color: var(--purple); }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .device-box { flex: 1; text-align: center; background: #f8f9fa; padding: 5px; border-radius: 8px; border: 1px solid #eee; }
    .device-box label { font-size: 11px; display: block; color: #666; }
    .ticket { border-left: 6px solid var(--primary); padding: 12px; margin-bottom: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
    .ticket.shelf-mode { border-left-color: #10b981; background: #ecfdf5; }
    .timer-area { background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .time-val { font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; color: #333; }
    .time-val.danger { color: #d32f2f; font-weight: 900; font-size: 20px; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .code-badge { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 14px; font-weight: bold; }
    .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 5px; color: white; font-size: 12px; z-index: 100; }
    .on { background: var(--success); } .off { background: var(--danger); }
    .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    #receiptPreview { font-family: 'Courier New', monospace; text-align: center; border: 1px dashed #333; padding: 10px; margin-bottom: 15px; background: #fff; color: black; }
    .r-code-box { border: 3px solid #000; padding: 5px; margin: 10px auto; display: inline-block; }
    .r-code-text { font-size: 28px; font-weight: 900; letter-spacing: 2px; }
    .r-cut-line { border-top: 2px dashed #000; margin: 20px 0 10px 0; position: relative; }
    .r-cut-line::after { content: '‚úÇÔ∏è DEVICE LABELS ‚úÇÔ∏è'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 0 5px; font-size: 10px; }
    .sticker-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    .sticker { background: #000; color: #fff; padding: 4px 8px; font-weight: bold; font-size: 18px; }
    
    /* Report Styles */
    .rep-btn { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; }
    .rep-btn.active { background: #007bff; color: white; border-color: #007bff; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 58mm; margin: 0; padding: 0; font-size: 12px; }
      .modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; display: block !important; }
      .modal-content { width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
      button { display: none !important; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <div id="securityOverlay">
    <div class="text-3xl font-bold mb-2">üîí STARBITE</div>
    <div class="text-sm text-blue-200 mb-8">System Locked</div>
    <div class="flex gap-2 mb-4" id="pinDots">
        <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="text-red-400 font-bold h-6 mb-2" id="pinError"></div>
    <div class="keypad">
        <div class="key" onclick="pressPin(1)">1</div><div class="key" onclick="pressPin(2)">2</div><div class="key" onclick="pressPin(3)">3</div>
        <div class="key" onclick="pressPin(4)">4</div><div class="key" onclick="pressPin(5)">5</div><div class="key" onclick="pressPin(6)">6</div>
        <div class="key" onclick="pressPin(7)">7</div><div class="key" onclick="pressPin(8)">8</div><div class="key" onclick="pressPin(9)">9</div>
        <div class="key key-del"></div><div class="key" onclick="pressPin(0)">0</div><div class="key key-del" onclick="clearPin()">‚å´</div>
    </div>
  </div>

  <nav class="bg-blue-600 p-2 text-white sticky top-0 z-[1000] shadow-md flex justify-around">
    <button onclick="openTab('debtorTab')" class="nav-btn px-4 py-2 rounded-lg font-bold active" id="btn-debtorTab">üí∞ Debtors</button>
    <button onclick="openTab('prodTab')" class="nav-btn px-4 py-2 rounded-lg font-bold" id="btn-prodTab">üçû Production</button>
    <button onclick="openTab('chargeTab')" class="nav-btn px-4 py-2 rounded-lg font-bold" id="btn-chargeTab">‚ö° Charging</button>
  </nav>

  <div id="debtorTab" class="tab-content active p-4">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold mb-6 text-center text-blue-700">üí∞ Cloud Credit Tracker</h1>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-red-100 border border-red-400 text-red-800 px-4 py-2 rounded text-center font-semibold">Remaining: ‚Ç¶<span id="totalRemainingOwed">0.00</span></div>
          <div class="bg-green-100 border border-green-400 text-green-800 px-4 py-2 rounded text-center font-semibold">Collected: ‚Ç¶<span id="totalPaid">0.00</span></div>
          <div class="bg-blue-100 border border-blue-400 text-blue-800 px-4 py-2 rounded text-center flex justify-center items-center">
            Reminder Days: <input id="reminderDays" type="number" min="1" class="w-16 text-center border rounded ml-2" onchange="cfg()">
          </div>
          <div id="reminderBox" class="bg-red-500 text-white px-4 py-2 rounded text-center cursor-pointer font-bold hidden" onclick="document.getElementById('filterStatus').value='overdue';render1()">
            ‚ö†Ô∏è <span id="reminderCount">0</span> Overdue!
          </div>
        </div>
    
        <div class="bg-white shadow-lg rounded-xl p-6 mb-6">
          <h2 class="text-xl font-semibold mb-3">Log New Credit Sale</h2>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <input id="cName" placeholder="Customer Name" class="border rounded p-2 col-span-2">
            <input id="cPhone" type="tel" placeholder="Phone" class="border rounded p-2">
            <input id="cProd" placeholder="Product" class="border rounded p-2">
            <input id="cAmt" type="number" step="0.01" placeholder="Amount (‚Ç¶)" class="border rounded p-2">
            <input id="cDate" type="date" class="border rounded p-2">
            <button id="addBtn1" class="bg-blue-600 hover:bg-blue-700 text-white rounded p-2">Add Record</button>
          </div>
        </div>
    
        <div class="bg-white shadow rounded-lg p-4 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <input id="search1" placeholder="Search..." class="border rounded p-2" oninput="render1()">
          <select id="filterStatus" class="border rounded p-2" onchange="render1()">
            <option value="all">All Statuses</option><option value="full">Paid in Full</option>
            <option value="partial">Partial Payment</option><option value="unpaid">Unpaid</option><option value="overdue">Overdue ONLY</option>
          </select>
          <select id="sortOrder1" class="border rounded p-2" onchange="render1()">
            <option value="date_desc">Date (Newest)</option><option value="date_asc">Date (Oldest)</option>
            <option value="amount_desc">Amount (High)</option><option value="amount_asc">Amount (Low)</option>
          </select>
        </div>
    
        <div class="bg-white shadow-lg rounded-xl p-4 overflow-x-auto">
          <table class="w-full border-collapse text-left">
            <thead><tr class="bg-gray-200"><th class="p-2 border">Name</th><th class="p-2 border">Phone</th><th class="p-2 border">Orig (‚Ç¶)</th><th class="p-2 border">Paid (‚Ç¶)</th><th class="p-2 border text-red-700">Owed (‚Ç¶)</th><th class="p-2 border">Date</th><th class="p-2 border">Status</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="recordsTable1"></tbody>
          </table>
          <p id="noResults1" class="text-center text-gray-500 hidden mt-4">Loading data or no records found...</p>
        </div>
    
        <h2 class="text-xl font-semibold mt-8 mb-3">Trash</h2>
        <div class="bg-white shadow rounded-lg p-4 overflow-x-auto">
          <table class="w-full border-collapse text-left">
            <thead><tr class="bg-gray-200"><th class="p-2 border">Name</th><th class="p-2 border">Product</th><th class="p-2 border">Amount</th><th class="p-2 border">Deleted</th><th class="p-2 border">Actions</th></tr></thead>
            <tbody id="deletedTable1"></tbody>
          </table>
          <p id="noDeleted1" class="text-center text-gray-500 hidden mt-2">Empty Trash</p>
        </div>
      </div>
    
      <div id="payModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-96 shadow-2xl">
          <h3 class="text-xl font-bold mb-4">Log Payment</h3>
          <input type="hidden" id="payId"><label id="payOwed" class="block text-gray-600 font-bold mb-2"></label>
          <input id="payAmt" type="number" step="0.01" class="border rounded p-2 w-full mb-2" placeholder="Amount">
          <input id="payDate" type="date" class="border rounded p-2 w-full mb-4">
          <div class="flex justify-end gap-2"><button id="savePayBtn" class="bg-green-500 text-white px-4 py-2 rounded">Save</button><button onclick="toggle('payModal',0)" class="bg-gray-300 px-4 py-2 rounded">Cancel</button></div>
        </div>
      </div>
      
      <div id="histModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-[500px] shadow-2xl">
          <div class="flex justify-between items-center mb-4">
             <h3 class="text-xl font-bold">History: <span id="histName" class="text-blue-600"></span></h3>
             <button onclick="genStatementPDF()" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">üìÑ Stmt</button>
          </div>
          <input type="hidden" id="histCurId">
          <div class="max-h-64 overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-100"><tr><th class="p-2">Date</th><th class="p-2 text-right">Amount</th><th class="p-2 text-center">Action</th></tr></thead><tbody id="histBody"></tbody></table></div>
          <p class="text-right font-bold mt-2">Total: ‚Ç¶<span id="histTotal">0.00</span></p>
          <div class="flex justify-end mt-4"><button onclick="toggle('histModal',0)" class="bg-gray-300 px-4 py-2 rounded">Close</button></div>
        </div>
      </div>
    
      <div id="editModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-96 shadow-2xl">
          <h3 class="text-xl font-bold mb-4">Edit Record</h3>
          <input type="hidden" id="eId"><div class="space-y-3">
            <input id="eName" class="border rounded p-2 w-full" placeholder="Name"><input id="ePhone" class="border rounded p-2 w-full" placeholder="Phone">
            <input id="eProd" class="border rounded p-2 w-full" placeholder="Product"><input id="eAmt" type="number" class="border rounded p-2 w-full" placeholder="Amount">
            <input id="eDate" type="date" class="border rounded p-2 w-full">
          </div>
          <div class="flex justify-end gap-2 mt-6"><button id="saveEditBtn" class="bg-green-500 text-white px-4 py-2 rounded">Save</button><button onclick="toggle('editModal',0)" class="bg-gray-300 px-4 py-2 rounded">Cancel</button></div>
        </div>
      </div>
  </div>

  <div id="prodTab" class="tab-content p-4">
    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl p-6">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">STARBITE CLOUD RECORDER</h1>
            <button onclick="openPriceMgr()" class="bg-gray-800 text-white px-3 py-1 rounded shadow hover:bg-gray-700 text-sm">‚öôÔ∏è Prices</button>
        </div>
        
        <div class="bg-indigo-100 rounded-xl p-3 mb-4 border-2 border-indigo-500">
            <div class="flex justify-between items-center mb-1">
                <h3 class="font-bold text-indigo-800">1. Capital & Recovery (Synced)</h3>
                <button onclick="unlockCap()" id="btnCapLock" class="text-xs bg-indigo-200 text-indigo-800 px-2 py-1 rounded border border-indigo-300 font-bold hover:bg-indigo-300">üîí Locked</button>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-xs mb-2">
                <div class="bg-white p-2 rounded">
                    <label>Production Capital (‚Ç¶)</label>
                    <input id="pCap" type="number" class="w-full border p-1 rounded bg-gray-200 text-gray-500 cursor-not-allowed" disabled oninput="saveCap()">
                </div>
                <div class="bg-white p-2 rounded">
                    <label>Misc/Drinks Capital (‚Ç¶)</label>
                    <input id="mCap" type="number" class="w-full border p-1 rounded bg-gray-200 text-gray-500 cursor-not-allowed" disabled oninput="saveCap()">
                </div>
            </div>
            <div class="text-sm border-t border-indigo-300 pt-2 font-semibold">
                Profit: ‚Ç¶<span id="cumProfit" class="text-green-600">0</span> | Total Cap: ‚Ç¶<span id="totCap">0</span> | <span class="text-red-600">Rem: ‚Ç¶<span id="remCap">0</span></span>
            </div>
        </div>
    
        <div id="inputCard" class="bg-gray-100 rounded-xl p-3 mb-3 border-2 border-transparent" oninput="calc2()">
          <div class="flex gap-2 mb-2 text-sm"><input id="date2" type="date" class="p-1 rounded"><input id="time2" type="time" class="p-1 rounded"></div>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs" id="prodGrid"></div>
          <div class="font-semibold mt-2 text-sm">Prod. Sales: ‚Ç¶<span id="prodTot">0</span></div>
        </div>
    
        <div class="bg-yellow-100 rounded-xl p-3 mb-3" oninput="calc2()">
          <h3 class="font-semibold mb-2">2. Cash & Deduction</h3>
          <div class="grid grid-cols-2 gap-2 text-xs mb-2">
            <div><label>Start Float (‚Ç¶)</label><input id="float2" type="number" class="w-full p-1 rounded border"></div>
            <div><label> Total money counted (‚Ç¶)</label><input id="cash2" type="number" class="w-full p-1 rounded border"></div>
          </div>
          
          <div class="grid grid-cols-3 gap-2 text-sm font-bold bg-white p-2 rounded border text-center">
            <div>
                <label class="block text-xs text-gray-500 mb-1">Misc Sales (‚Ç¶)</label>
                <input id="miscSale" type="number" class="w-full border rounded p-1 text-center" value="0" placeholder="0">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Total Sales</label>
                <div class="mt-1">‚Ç¶<span id="dayTot">0</span></div>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Variance</label>
                <div class="mt-1">‚Ç¶<span id="var2">0</span></div>
            </div>
          </div>
        </div>
    
        <div class="bg-gray-100 rounded-xl p-3 mb-3">
          <h3 class="font-semibold">3. Expenses</h3>
          <div class="flex gap-2 text-sm my-2 items-center">
            <select id="expCat" class="p-1 rounded border text-xs w-1/3 h-8">
                <option value="General">General</option>
                <option value="Ingredients">Ingredients</option>
                <option value="Fuel">Fuel/Trans</option>
                <option value="Staff">Staff</option>
                <option value="Repairs">Repairs</option>
            </select>
            <input id="expDesc" placeholder="Item" class="p-1 rounded border w-full h-8">
            <input id="expAmt" type="number" placeholder="Amt" class="p-1 rounded border w-1/4 h-8">
            <button onclick="addExp()" id="expBtn" class="bg-red-600 text-white px-3 rounded h-8">Add</button>
          </div>
          <div class="text-sm font-semibold">Total Exp: ‚Ç¶<span id="expTot">0</span></div>
          <ul id="expList" class="mt-1"></ul>
        </div>
    
        <div class="flex flex-wrap gap-2 text-xs items-center">
          <button onclick="save2()" id="saveBtn2" class="bg-blue-600 text-white px-3 py-1 rounded shadow">Save</button>
          <button onclick="editMode2(false)" id="cancelBtn2" class="hidden bg-gray-500 text-white px-3 py-1 rounded">Cancel</button>
          <button onclick="document.getElementById('hist2').classList.toggle('hidden')" class="bg-green-600 text-white px-3 py-1 rounded">History</button>
          <button onclick="expCSV()" class="bg-yellow-500 text-white px-3 py-1 rounded">CSV</button>
          <button onclick="wipe2()" class="bg-red-500 text-white px-3 py-1 rounded">Clear All</button>
          <div class="ml-auto flex gap-1">
            <select id="repType" class="p-1 border rounded" onchange="uiDate2()">
              <option value="monthly">Monthly</option><option value="yearly">Yearly</option><option value="range">Range</option>
            </select>
            <div id="dtPick" class="flex gap-1"></div>
            <button onclick="genPDF()" class="bg-indigo-600 text-white px-2 rounded">PDF</button>
          </div>
        </div>
    
        <div id="hist2" class="hidden bg-white rounded-xl p-3 border mt-4 overflow-auto">
          <div class="flex justify-around bg-gray-100 p-2 text-sm font-bold mb-2">
              <span>Sales: ‚Ç¶<span id="allSales2">0</span></span><span>Profit: ‚Ç¶<span id="allProf2">0</span></span>
          </div>
          <table class="w-full text-left text-xs table-auto"><thead class="bg-gray-100"><tr id="hHead2"></tr></thead><tbody id="hBody2"></tbody><tfoot id="hFoot2" class="bg-gray-100 font-bold"></tfoot></table>
        </div>
      </div>
      <div id="toast"></div>

      <div id="priceModal" class="modal">
          <div class="modal-content">
              <div class="flex justify-between mb-4">
                  <h3 class="font-bold text-lg">‚öôÔ∏è Manage Product Prices</h3>
                  <button onclick="toggle('priceModal', 0)" class="text-red-500 font-bold">X</button>
              </div>
              <div class="mb-4 p-2 bg-gray-100 rounded">
                  <h4 class="text-xs font-bold text-gray-500 mb-1">Add / Update Product</h4>
                  <input type="hidden" id="prodEditId">
                  <input id="pMgrName" placeholder="Product Name (e.g. Meat Pie)" class="w-full mb-1 border p-1 rounded text-sm">
                  <input id="pMgrPrice" type="number" placeholder="Price (N)" class="w-full mb-2 border p-1 rounded text-sm">
                  <div class="flex gap-2">
                      <button onclick="saveProduct()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm w-full">Save Product</button>
                      <button onclick="resetProdForm()" class="bg-gray-400 text-white px-2 py-1 rounded text-sm">Cancel</button>
                  </div>
              </div>
              <h4 class="font-bold text-sm mb-2">Current Menu</h4>
              <ul id="priceList" class="text-sm space-y-1 max-h-48 overflow-y-auto mb-4"></ul>
              
              <button onclick="loadDefaultMenu()" id="btnLoadDef" class="w-full bg-indigo-100 text-indigo-800 text-xs py-2 rounded mt-2 hidden">‚ö†Ô∏è Load Default Menu</button>
          </div>
      </div>

  </div>

  <div id="chargeTab" class="tab-content p-4">
    <div class="max-w-4xl mx-auto">
        <h2>‚ö°Ô∏è STARBITE Cloud Pro</h2>
      
        <div class="dash-row">
          <div class="dash-card d-green">
            <h4>Cash Today</h4>
            <div class="dash-val" id="valCash">‚Ç¶0</div>
          </div>
          <div class="dash-card d-blue">
            <h4>Pending</h4>
            <div class="dash-val" id="valPending">‚Ç¶0</div>
          </div>
          <div class="dash-card d-purp">
            <h4>Devices</h4>
            <div class="dash-val" id="valCount">0</div>
          </div>
        </div>

        <div class="flex justify-end mb-2">
           <button onclick="openReportModal()" class="bg-indigo-600 text-white font-bold py-1 px-3 rounded shadow hover:bg-indigo-700 text-sm flex items-center gap-1">
             üìä View Reports
           </button>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow mb-4">
            <h3 class="text-sm font-bold text-gray-500 mb-2">Weekly Revenue Chart</h3>
            <canvas id="revChart" style="max-height: 200px; width: 100%;"></canvas>
        </div>
      
        <div class="card" style="background: #e0f2fe; border: 2px solid #0284c7;">
          <h3 class="text-blue-900 font-bold mb-2">üöÄ Quick Collect by Code</h3>
          <div class="flex gap-2">
            <input type="number" id="quickCode" placeholder="Enter Ticket Code (e.g. 1234)" class="w-full border p-2 rounded font-bold text-lg" onkeydown="if(event.key==='Enter') runQuickCollect()">
            <button onclick="runQuickCollect()" class="bg-blue-700 text-white px-6 py-2 rounded font-bold hover:bg-blue-800">COLLECT</button>
          </div>
        </div>

        <div class="card">
          <h3 id="formAction">New Customer</h3>
          <input type="text" id="custName" placeholder="Customer Name *">
          
          <div class="row flex gap-2">
            <div class="device-box"><label>PHONES</label><input type="number" id="phCount" value="1" min="0" class="w-full text-center border p-1 rounded"></div>
            <div class="device-box"><label>P-BANKS</label><input type="number" id="pbCount" value="0" min="0" class="w-full text-center border p-1 rounded"></div>
            <div class="device-box"><label>CHARGERS</label><input type="number" id="chCount" value="0" min="0" class="w-full text-center border p-1 rounded"></div>
          </div>

          <div class="flex gap-2 my-2">
             <div class="w-full">
                <label class="text-xs font-bold text-gray-500">Price (‚Ç¶)</label>
                <input type="number" id="price3" value="200" class="w-full border p-2 rounded">
             </div>
             <input type="hidden" id="socketNum">
          </div>
          
          <div class="flex gap-4 mb-3 border p-2 rounded bg-gray-50">
             <span class="text-sm font-bold text-gray-600">Payment Status:</span>
             <label class="flex items-center cursor-pointer">
                <input type="radio" name="payStatus" value="paid" checked class="mr-1"> 
                <span class="text-sm text-green-700 font-bold">Paid Now</span>
             </label>
             <label class="flex items-center cursor-pointer">
                <input type="radio" name="payStatus" value="later" class="mr-1"> 
                <span class="text-sm text-red-600 font-bold">Pay Later</span>
             </label>
          </div>

          <button onclick="saveTicket()" id="saveBtn3" class="w-full bg-blue-600 text-white font-bold p-3 rounded">‚úÖ START CHARGING</button>
          <button id="cancelEditBtn3" style="display:none; background:#666;" onclick="cancelEdit3()" class="w-full text-white p-3 rounded mt-2">Cancel Edit</button>
        </div>
      
        <h3>Active Devices (<span id="countActive">0</span>)</h3>
        <div id="listActive">Loading...</div>
      
        <details class="card mt-4">
          <summary class="font-bold cursor-pointer">üì¶ Customer History & Search</summary>
          <div style="padding-top:10px;">
              <input type="text" id="histSearch" placeholder="Search Name or #Code..." oninput="render3()" class="w-full border p-2 rounded">
              <div id="listHistory" style="margin-top:10px;"></div>
          </div>
        </details>
      
        <div id="status" class="off">Offline</div>
      
        <div id="modalPrint" class="modal">
          <div class="modal-content" id="printArea">
            <div id="receiptPreview"></div>
            <button class="bg-black text-white p-2 rounded w-full mb-2" onclick="window.print()">üñ®Ô∏è PRINT NOW</button>
            <button style="background:#666;" class="text-white p-2 rounded w-full" onclick="document.getElementById('modalPrint').style.display='none'">Close</button>
          </div>
        </div>

        <div id="modalReport" class="modal">
            <div class="modal-content" style="max-width:350px;">
              <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold">üìä Business Reports</h3>
                  <button onclick="document.getElementById('modalReport').style.display='none'" class="text-gray-500 font-bold">X</button>
              </div>
              
              <div class="flex justify-center gap-2 mb-4 bg-gray-100 p-2 rounded-full">
                  <button onclick="calcReport('daily')" class="rep-btn active" id="btnRepD">Daily</button>
                  <button onclick="calcReport('weekly')" class="rep-btn" id="btnRepW">Weekly</button>
                  <button onclick="calcReport('monthly')" class="rep-btn" id="btnRepM">Monthly</button>
              </div>

              <div class="text-center bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4">
                  <div class="text-xs text-blue-600 font-bold uppercase mb-1">Total Revenue (Collected)</div>
                  <div class="text-3xl font-black text-blue-800" id="repRevenue">‚Ç¶0</div>
              </div>

              <div class="grid grid-cols-2 gap-2 mb-4">
                 <div class="bg-purple-50 p-3 rounded-lg border border-purple-200 text-center">
                    <div class="text-xs text-purple-600 font-bold">Total Devices</div>
                    <div class="text-xl font-black text-purple-800" id="repTotalDev">0</div>
                 </div>
                 <div class="bg-green-50 p-3 rounded-lg border border-green-200 text-center">
                     <div class="text-xs text-green-600 font-bold">Customers</div>
                     <div class="text-xl font-black text-green-800" id="repCustCount">0</div>
                 </div>
              </div>

              <div class="text-xs text-gray-500 bg-gray-100 p-2 rounded text-center">
                  Breakdown: <span id="repBreakdown">Loading...</span>
              </div>
            </div>
        </div>
    </div>
  </div>

  <script type="module">
    // --- PIN LOGIC ---
    const APP_PIN = "1988"; // STAFF PIN (To Unlock Screen)
    const OWNER_PASS = "boss"; // OWNER PASSWORD (To Change Prices & Capital)
    let currentPin = "";
    
    window.pressPin = (n) => {
        if(currentPin.length < 4) {
            currentPin += n;
            updateDots();
            if(currentPin.length === 4) checkPin();
        }
    };
    
    window.clearPin = () => { currentPin = ""; updateDots(); document.getElementById('pinError').innerText = ""; };
    
    function updateDots() {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((d, i) => {
            if(i < currentPin.length) d.classList.add('filled');
            else d.classList.remove('filled');
        });
    }
    
    function checkPin() {
        if(currentPin === APP_PIN) {
            document.getElementById('securityOverlay').style.display = 'none';
        } else {
            document.getElementById('pinError').innerText = "WRONG PIN";
            setTimeout(clearPin, 500);
        }
    }

    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // GLOBAL UTILS
    const $ = id => document.getElementById(id);
    window.openTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        $(tabId).classList.add('active');
        $('btn-' + tabId).classList.add('active');
    };

    // ==========================================
    // APP 1 JS (DEBTOR)
    // ==========================================
    const config1 = {
        apiKey: "AIzaSyCqmaIDptWNk8v5E5Sz5XKKSAmk6FNX6Yo",
        authDomain: "credit-record-24f1e.firebaseapp.com",
        projectId: "credit-record-24f1e",
        storageBucket: "credit-record-24f1e.firebasestorage.app",
        messagingSenderId: "181078991416",
        appId: "1:181078991416:web:6e562cccc19767561b7ccd"
    };
    const app1 = initializeApp(config1, "debtorApp");
    const db1 = getFirestore(app1);
    const recordsRef1 = collection(db1, "records");
    const trashRef1 = collection(db1, "trash");

    const cur = (n) => `‚Ç¶${parseFloat(n).toFixed(2)}`;
    const sum = (arr) => (arr || []).reduce((a, b) => a + b.amount, 0);

    // --- TOGGLE FUNCTION ---
    window.toggle = (id, show) => {
        const el = document.getElementById(id);
        if(!el) return;
        
        // 1. If it's a "Custom CSS" Modal (like Price Manager or Print)
        if (el.classList.contains('modal')) {
            el.style.display = (show === 1 || show === true) ? 'flex' : 'none';
        } 
        // 2. If it's a "Tailwind" Modal (like Debtors Edit/Pay)
        else {
            if (show === 1 || show === true) el.classList.remove('hidden');
            else if (show === 0 || show === false) el.classList.add('hidden');
            else el.classList.toggle('hidden');
        }
    };
    
    // --- NEW: OWNER AUTH FUNCTIONS ---
    window.openPriceMgr = () => {
        const p = prompt("üîê OWNER PASSWORD:");
        if(p === OWNER_PASS) {
            toggle('priceModal', 1);
        } else {
            alert("‚õî ACCESS DENIED: Incorrect Password.");
        }
    };

    window.unlockCap = () => {
        const p = prompt("üîê OWNER PASSWORD (To Edit Capital):");
        if(p === OWNER_PASS) {
            const pCap = $('pCap');
            const mCap = $('mCap');
            const btn = $('btnCapLock');
            
            pCap.disabled = false;
            mCap.disabled = false;
            
            // Remove gray look
            pCap.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
            mCap.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
            
            btn.innerText = "üîì Unlocked";
            btn.classList.remove('bg-indigo-200', 'text-indigo-800');
            btn.classList.add('bg-green-200', 'text-green-800');
        } else {
            alert("‚õî Wrong Password");
        }
    };
    
    let recs = [], delRecs = [], rDays = parseInt(localStorage.getItem('rDays')) || 3;
    $('reminderDays').value = rDays;

    onSnapshot(recordsRef1, (snapshot) => {
      recs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render1();
    });
    onSnapshot(trashRef1, (snapshot) => {
      delRecs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      render1();
    });

    window.cfg = () => { rDays = $('reminderDays').value; localStorage.setItem('rDays', rDays); render1(); };
    window.addRec = async () => {
      const [name, phone, product, amtStr, date] = ['cName','cPhone','cProd','cAmt','cDate'].map(id => $(id).value.trim());
      if(!name || !phone || !product || !amtStr || !date) return alert("Fill all fields");
      await addDoc(recordsRef1, { name, phone, product, amount: parseFloat(amtStr), dateTime: new Date(date).toISOString(), payments: [] });
      ['cName','cPhone','cProd','cAmt','cDate'].forEach(id=>$(id).value='');
    };
    $('addBtn1').onclick = window.addRec;

    window.render1 = () => {
      const term = $('search1').value.toLowerCase(), filter = $('filterStatus').value, sort = $('sortOrder1').value;
      let totalOwed = 0, totalCol = 0, dueCount = 0;
      const sorted = recs.filter(r => {
        const pd = sum(r.payments), rem = r.amount - pd;
        const stat = rem <= 0.01 ? 'full' : (pd > 0 ? 'partial' : 'unpaid');
        const isDue = rem > 0.01 && (new Date() - new Date(r.dateTime))/(864e5) >= rDays;
        if(isDue) dueCount++;
        return (r.name.toLowerCase().includes(term) || r.phone.includes(term) || r.product.toLowerCase().includes(term)) &&
               (filter === 'all' || filter === stat || (filter === 'overdue' && isDue));
      }).sort((a,b) => {
        const [k, o] = sort.split('_');
        const vA = k==='date'? new Date(a.dateTime) : a.amount, vB = k==='date'? new Date(b.dateTime) : b.amount;
        return o === 'asc' ? (vA>vB?1:-1) : (vA<vB?1:-1);
      });
      $('recordsTable1').innerHTML = sorted.map(r => {
        const pd = sum(r.payments), rem = r.amount - pd;
        const stat = rem <= 0.01 ? 'full' : (pd > 0 ? 'partial' : 'unpaid');
        const isDue = rem > 0.01 && (new Date() - new Date(r.dateTime))/(864e5) >= rDays;
        totalOwed += rem > 0 ? rem : 0; totalCol += pd;
        const rowCls = stat==='full'?'s-full':(isDue?'s-over':(stat==='partial'?'s-part':'hover:bg-gray-50'));
        
        // WA Link
        const waNum = r.phone.replace(/^0/, '234').replace(/\D/g,'');
        const waMsg = encodeURIComponent(`Hello ${r.name}, this is a reminder regarding your balance of ${cur(rem)} at Starbite.`);
        const waBtn = `<a href="https://wa.me/${waNum}?text=${waMsg}" target="_blank" class="bg-green-500 text-white px-2 py-1 rounded text-xs no-underline">üì≤</a>`;

        const btns = stat === 'full' ? '<span class="text-gray-400 text-xs">Paid</span>' : 
          `<div class="flex items-center gap-1 mb-1"><input id="qp-${r.id}" type="number" class="border p-1 w-16 text-xs" placeholder="Amt"><button onclick="quickPay('${r.id}')" class="bg-green-600 text-white px-2 rounded text-xs">Pay</button> ${waBtn}</div>
           <button onclick="openPay('${r.id}')" class="text-xs text-blue-500 hover:underline">Log Past Date</button>`;
        return `<tr class="${rowCls} border-b"><td class="p-2 border">${r.name}</td><td class="p-2 border">${r.phone}</td><td class="p-2 border">${cur(r.amount)}</td><td class="p-2 border text-green-700">${cur(pd)}</td><td class="p-2 border font-bold ${rem>0.01?'text-red-700':''}">${cur(rem)}</td><td class="p-2 border">${new Date(r.dateTime).toLocaleDateString('en-CA')}</td><td class="p-2 border capitalize">${stat}${isDue && stat!=='full'?' ‚ö†Ô∏è':''}</td><td class="p-2 border space-y-1">${btns}<div class="flex gap-1 pt-1 border-t mt-1"><button onclick="hist1('${r.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Hist</button><button onclick="edit1('${r.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs">Edit</button><button onclick="del1('${r.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Del</button></div></td></tr>`;
      }).join('');
      $('noResults1').classList[sorted.length ? 'add' : 'remove']('hidden');
      $('totalRemainingOwed').innerText = totalOwed.toFixed(2); $('totalPaid').innerText = totalCol.toFixed(2);
      $('reminderBox').classList[dueCount ? 'remove' : 'add']('hidden'); $('reminderCount').innerText = dueCount;
      $('deletedTable1').innerHTML = delRecs.map(r => `<tr><td class="p-2 border">${r.name}</td><td class="p-2 border">${r.product}</td><td class="p-2 border">${cur(r.amount)}</td><td class="p-2 border">${new Date(r.delAt).toLocaleDateString()}</td><td class="p-2 border gap-1 flex"><button onclick="restore1('${r.id}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Restore</button><button onclick="permDel1('${r.id}')" class="bg-red-700 text-white px-2 py-1 rounded text-xs">üóëÔ∏è</button></td></tr>`).join('');
      $('noDeleted1').classList[delRecs.length ? 'add' : 'remove']('hidden');
    }

    window.quickPay = async (id) => {
      const v = parseFloat($(`qp-${id}`).value);
      if(!v || v<=0) return alert("Invalid amount");
      const r = recs.find(x => x.id === id);
      await updateDoc(doc(db1, "records", id), { payments: [...r.payments, { id: String(Date.now()), amount: v, dateTime: new Date().toISOString() }] });
    };
    window.openPay = (id) => {
      const r = recs.find(x => x.id === id);
      const rem = r.amount - sum(r.payments);
      $('payId').value = id; $('payAmt').value = rem.toFixed(2); $('payOwed').innerText = `Owed: ${cur(rem)}`;
      $('payDate').valueAsDate = new Date(); toggle('payModal',1);
    }
    $('savePayBtn').onclick = async () => {
      const id = $('payId').value, v = parseFloat($('payAmt').value), d = $('payDate').value;
      const r = recs.find(x => x.id === id);
      await updateDoc(doc(db1, "records", id), { payments: [...r.payments, { id: String(Date.now()), amount: v, dateTime: new Date(d).toISOString() }] });
      toggle('payModal',0);
    }
    window.edit1 = (id) => {
      const r = recs.find(x=>x.id===id);
      $('eId').value=r.id; $('eName').value=r.name; $('ePhone').value=r.phone; $('eProd').value=r.product; $('eAmt').value=r.amount; $('eDate').value=r.dateTime.split('T')[0];
      toggle('editModal',1);
    }
    $('saveEditBtn').onclick = async () => {
        const id = $('eId').value;
        await updateDoc(doc(db1, "records", id), { name: $('eName').value, phone: $('ePhone').value, product: $('eProd').value, amount: parseFloat($('eAmt').value), dateTime: new Date($('eDate').value).toISOString() });
        toggle('editModal',0);
    }
    window.del1 = async (id) => {
        if(!confirm("Delete?")) return;
        const r = recs.find(x => x.id === id);
        await setDoc(doc(db1, "trash", id), { ...r, delAt: new Date().toISOString() });
        await deleteDoc(doc(db1, "records", id));
    }
    window.restore1 = async (id) => {
        const r = delRecs.find(x => x.id === id);
        const { delAt, ...rest } = r;
        await setDoc(doc(db1, "records", id), rest);
        await deleteDoc(doc(db1, "trash", id));
    }
    window.permDel1 = async (id) => { if(confirm("Permanent Delete?")) await deleteDoc(doc(db1, "trash", id)); }
    window.hist1 = (id) => {
        const r = recs.find(x=>x.id===id);
        $('histCurId').value = id;
        $('histName').innerText = r.name; $('histTotal').innerText = sum(r.payments).toFixed(2);
        $('histBody').innerHTML = (r.payments || []).sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime)).map(p => `<tr class="border-b"><td class="p-2">${new Date(p.dateTime).toLocaleDateString()}</td><td class="p-2 text-right">${cur(p.amount)}</td><td class="p-2 text-center text-gray-400 text-xs">(ReadOnly)</td></tr>`).join('');
        toggle('histModal',1);
    }
    
    // NEW: Generate Customer Statement PDF
    window.genStatementPDF = () => {
        const id = $('histCurId').value;
        const r = recs.find(x => x.id === id);
        if(!r) return;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(16);
        doc.text("STARBITE - ACCOUNT STATEMENT", 14, 20);
        doc.setFontSize(12);
        doc.text(`Customer: ${r.name}`, 14, 30);
        doc.text(`Phone: ${r.phone}`, 14, 36);
        doc.text(`Original Debt: ${cur(r.amount)} for ${r.product}`, 14, 42);
        
        const rows = (r.payments || []).map(p => [new Date(p.dateTime).toLocaleDateString(), cur(p.amount)]);
        doc.autoTable({
            head: [['Date Paid', 'Amount']],
            body: rows,
            startY: 50
        });
        
        const paid = sum(r.payments);
        const owed = r.amount - paid;
        
        doc.text(`Total Paid: ${cur(paid)}`, 14, doc.lastAutoTable.finalY + 10);
        doc.setTextColor(200, 0, 0);
        doc.text(`Balance Owed: ${cur(owed)}`, 14, doc.lastAutoTable.finalY + 16);
        
        doc.save(`Statement_${r.name}.pdf`);
    };

    // ==========================================
    // APP 2 JS (PRODUCTION)
    // ==========================================
    const config2 = {
      apiKey: "AIzaSyCX5EZzNLeztpIroUt4CZs6sgmQwj7I0VM",
      authDomain: "starbite-685e7.firebaseapp.com",
      projectId: "starbite-685e7",
      storageBucket: "starbite-685e7.firebasestorage.app",
      messagingSenderId: "636945152656",
      appId: "1:636945152656:web:c6e74b34ced5c1579bf615"
    };
    const app2 = initializeApp(config2, "prodApp");
    const db2 = getFirestore(app2);

    // CHANGED: P is now dynamic 'products'
    let products = [];
    const val = id => Number($(id).value) || 0, setT = (id, t) => $(id).innerText = t, fmt = n => n.toLocaleString();
    let exp = [], editId2 = null, editExpIdx = null, h2 = [];

    // --- NEW: PRODUCT MANAGEMENT LOGIC ---
    function initProd() {
      // Listen for products
      onSnapshot(collection(db2, "products"), (snap) => {
          products = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>a.n.localeCompare(b.n));
          
          if(products.length === 0) $('btnLoadDef').classList.remove('hidden');
          else $('btnLoadDef').classList.add('hidden');

          renderProdGrid();
          renderPriceList();
          render2(); // Re-render history headers
      });

      setNow2(); uiDate2();
      onSnapshot(collection(db2, "records"), (snap) => { h2 = snap.docs.map(doc => ({ ...doc.data(), fid: doc.id })); render2(); });
      onSnapshot(doc(db2, "settings", "capital"), (doc) => { if(doc.exists()) { $('pCap').value = doc.data().p || 0; $('mCap').value = doc.data().m || 0; } calcCapStatus(); });
    }

    // Render the Inputs based on database products
    function renderProdGrid() {
        if(products.length === 0) {
            $('prodGrid').innerHTML = '<div class="col-span-full text-center text-gray-500 p-4">No products found.<br>Click "‚öôÔ∏è Prices" to add items.</div>';
            return;
        }
        // Preserve values if re-rendering while typing? Difficult. 
        // Better: Only re-render if ID list changes? For now, simple re-render.
        // We try to save current values to restore them
        const curVals = {};
        document.querySelectorAll('.qIn').forEach(i => curVals[i.dataset.id] = i.value);
        const curRems = {};
        document.querySelectorAll('.rIn').forEach(i => curRems[i.dataset.pid] = i.value);

        $('prodGrid').innerHTML = products.map(p => `
            <div class="bg-white rounded p-2 border">
                <label>${p.n}</label>
                <input type="number" placeholder="Qty" data-id="${p.id}" value="${curVals[p.id]||''}" class="qIn w-full p-1 border rounded mt-1">
                <div class="flex justify-between mt-1">
                    <span class="text-xs">‚Ç¶<span class="lTot">0</span></span>
                    <input type="number" placeholder="Rem" data-pid="${p.id}" class="rIn w-12 p-1 border rounded text-xs" oninput="checkLow(this)" value="${curRems[p.id]||0}">
                </div>
            </div>`).join('');
    }

    // NEW: Check Low Stock
    window.checkLow = (el) => {
        if(Number(el.value) < 5) el.classList.add('text-red-600', 'font-bold');
        else el.classList.remove('text-red-600', 'font-bold');
    }

    // Render the Manager List
    function renderPriceList() {
        $('priceList').innerHTML = products.map(p => `
            <li class="flex justify-between items-center border-b p-1">
                <span><b>${p.n}</b> - ‚Ç¶${p.p}</span>
                <div>
                    <button onclick="editProd('${p.id}')" class="bg-blue-100 text-blue-800 px-2 rounded text-xs">Edit</button>
                    <button onclick="delProd('${p.id}')" class="bg-red-100 text-red-800 px-2 rounded text-xs">X</button>
                </div>
            </li>
        `).join('');
    }

    window.saveProduct = async () => {
        const id = $('prodEditId').value;
        const n = $('pMgrName').value.trim();
        const p = parseFloat($('pMgrPrice').value);
        if(!n || !p) return alert("Enter name and price");

        if(id) {
            await updateDoc(doc(db2, "products", id), {n, p});
        } else {
            // Create a simple slug ID or random
            const newId = n.toLowerCase().replace(/[^a-z0-9]/g, '_');
            // Check if ID exists to avoid overwrite? Firestore addDoc makes unique ID, setDoc uses ours.
            // Let's use addDoc for safety or setDoc if we want readable IDs.
            // Using setDoc with generated ID ensures cleaner data if we want fixed IDs
            await setDoc(doc(db2, "products", newId), {n, p});
        }
        resetProdForm();
    };

    window.editProd = (id) => {
        const p = products.find(x => x.id === id);
        $('prodEditId').value = p.id;
        $('pMgrName').value = p.n;
        $('pMgrPrice').value = p.p;
        $('pMgrName').focus();
    };

    window.delProd = async (id) => {
        if(confirm("Delete this product?")) await deleteDoc(doc(db2, "products", id));
    };

    window.resetProdForm = () => {
        $('prodEditId').value = ''; $('pMgrName').value = ''; $('pMgrPrice').value = '';
    };

    window.loadDefaultMenu = async () => {
        if(!confirm("Load default menu items?")) return;
        const defs = [
          {id:'egg_roll',n:'Egg roll',p:500},{id:'meat_pie',n:'Meat pie',p:600},{id:'buns',n:'Buns',p:100},{id:'fish_roll',n:'Fish roll',p:500},
          {id:'cake',n:'Cake',p:800},{id:'small_cake',n:'Small cake',p:200},{id:'chin_sachet',n:'Chin chin (sachet)',p:300},{id:'chin_bag',n:'Chin chin (bag)',p:7500}
        ];
        for(const d of defs) {
            await setDoc(doc(db2, "products", d.id), {n: d.n, p: d.p});
        }
    };
    // -----------------------------

    window.setNow2 = () => { const d = new Date(); $('date2').value = d.toISOString().split('T')[0]; $('time2').value = d.toTimeString().slice(0, 5); }
    window.uiDate2 = () => {
      const t = $('repType').value, d = new Date(), y = d.getFullYear(), m = (d.getMonth() + 1).toString().padStart(2, '0');
      $('dtPick').innerHTML = t === 'monthly' ? `<input id="mPick" type="month" value="${y}-${m}" class="p-1 border rounded text-xs">` : t === 'yearly' ? `<input id="yPick" type="number" value="${y}" class="p-1 border rounded text-xs w-16">` : `<input id="sDate" type="date" class="p-1 text-xs"><input id="eDate" type="date" class="p-1 text-xs">`;
      if (t === 'range') { $('sDate').value = `${y}-${m}-01`; $('eDate').value = `${y}-${m}-${d.getDate()}`; }
    }
    
    // --- UPDATED CALC FUNCTION ---
    window.calc2 = () => {
      let pTot = 0;
      document.querySelectorAll('.qIn').forEach(i => {
        const p = products.find(x => x.id === i.dataset.id);
        if(p) {
            const remInp = i.parentElement.querySelector('.rIn');
            const rem = Number(remInp.value) || 0;
            checkLow(remInp); // trigger color check
            const sQty = Math.max(0, (Number(i.value) || 0) - rem), amt = sQty * p.p;
            i.parentElement.querySelector('.lTot').innerText = fmt(amt); pTot += amt;
        }
      });
      setT('prodTot', fmt(pTot));
      
      const fl = val('float2');
      const ch = val('cash2');
      const mSale = val('miscSale');

      const day = pTot + mSale;
      const vari = ch - (fl + day);

      setT('dayTot', fmt(day));
      
      const vEl = $('var2'); 
      vEl.innerText = fmt(vari); 
      vEl.style.color = vari === 0 ? 'green' : vari > 0 ? 'blue' : 'red';
      
      return { pTot, mSale, day, vari, fl, ch };
    }
    
    // UPDATED: Expense Categories
    window.addExp = () => {
      const d = $('expDesc').value, a = val('expAmt'), c = $('expCat').value;
      if (!d || a <= 0) return alert('Invalid Expense');
      if (editExpIdx !== null) exp[editExpIdx] = { d, a, c }; else exp.push({ d, a, c });
      $('expDesc').value = ''; $('expAmt').value = ''; editExpIdx = null; $('expBtn').innerText = 'Add'; renExp();
    }
    function renExp() { 
        setT('expTot', fmt(exp.reduce((s, x) => s + x.a, 0))); 
        $('expList').innerHTML = exp.map((x, i) => `<li class="flex justify-between text-xs mt-1"><span>[${x.c||'Gen'}] ${x.d}: ‚Ç¶${fmt(x.a)}</span><div><button onclick="edExp(${i})" class="bg-gray-400 text-white px-1 mr-1">E</button><button onclick="delExp(${i})" class="bg-red-500 text-white px-1">X</button></div></li>`).join(''); 
    }
    window.edExp = (i) => { $('expDesc').value = exp[i].d; $('expAmt').value = exp[i].a; $('expCat').value = exp[i].c || 'General'; editExpIdx = i; $('expBtn').innerText = 'Upd'; }
    window.delExp = (i) => { exp.splice(i, 1); renExp(); }
    
    window.save2 = async () => {
      const c = calc2();
      const rec = { id: editId2 || Date.now(), iso: new Date($('date2').value + 'T' + $('time2').value).toISOString(), dt: $('date2').value + ' ' + $('time2').value, items: Array.from(document.querySelectorAll('.qIn')).map(i => ({ id: i.dataset.id, q: Number(i.value) || 0, r: Number(i.parentElement.querySelector('.rIn').value) || 0 })), exp, prod: c.pTot, misc: c.mSale, tot: c.day, prof: c.day - exp.reduce((s, x) => s + x.a, 0), var: c.vari, fl: c.fl, ch: c.ch, ed: !!editId2 };
      if (editId2) { const target = h2.find(r => r.id === editId2); if(target) await setDoc(doc(db2, "records", target.fid), rec); } 
      else await addDoc(collection(db2, "records"), rec);
      editMode2(false); toast('Cloud Synced');
    }

    function render2() {
      const sorted = h2.sort((a, b) => new Date(b.iso) - new Date(a.iso));
      let gS = 0, gP = 0;
      
      // Dynamic Headers based on PRODUCTS
      $('hHead2').innerHTML = `<th>Date</th>${products.map(p => `<th>${p.n}</th>`).join('')}<th>Rem</th><th>Prod</th><th>Misc</th><th>Tot</th><th>Exp</th><th>Prof</th><th>Var</th><th>Act</th>`;
      
      $('hBody2').innerHTML = sorted.map(r => {
        gS += r.tot; gP += r.prof;
        // Dynamic Columns
        const prodCols = products.map(p => { 
            const it = r.items.find(x => x.id === p.id) || { q: 0 }; 
            return `<td>${it.q || '-'}</td>`; 
        }).join('');
        // ADDED DELETE BUTTON (X) HERE
        return `<tr class="border-b"><td>${r.dt}</td>${prodCols}<td>${r.items.reduce((s, x) => s + x.r, 0)}</td><td>‚Ç¶${fmt(r.prod)}</td><td>‚Ç¶${fmt(r.misc)}</td><td>‚Ç¶${fmt(r.tot)}</td><td>‚Ç¶${fmt((r.exp || []).reduce((s, x) => s + x.a, 0))}</td><td>‚Ç¶${fmt(r.prof)}</td><td>‚Ç¶${fmt(r.var)}</td><td><button onclick="load2(${r.id})" class="bg-blue-500 text-white px-1">E</button> <button onclick="del2('${r.id}')" class="bg-red-500 text-white px-1">X</button></td></tr>`;
      }).join('');
      setT('allSales2', fmt(gS)); setT('allProf2', fmt(gP));
      calcCapStatus();
    }
    
    // NEW: Delete Function for Production
    window.del2 = async (id) => {
        if(!confirm("Delete this record permanently?")) return;
        const r = h2.find(x => x.id === id);
        if(r) await deleteDoc(doc(db2, "records", r.fid));
    }

    window.load2 = (id) => {
      const r = h2.find(x => x.id === id); if (!r) return;
      $('date2').value = r.dt.split(' ')[0]; $('time2').value = r.dt.split(' ')[1]; $('float2').value = r.fl; $('cash2').value = r.ch; exp = r.exp || [];
      $('miscSale').value = r.misc || 0;

      // Populate Inputs (Handle cases where old products were deleted)
      products.forEach(p => { 
          const it = r.items.find(x => x.id === p.id); 
          const inp = document.querySelector(`input[data-id="${p.id}"]`); 
          if(inp && it) { 
              inp.value = it.q + it.r; 
              inp.parentElement.querySelector('.rIn').value = it.r; 
          } 
      });
      editId2 = r.id; $('saveBtn2').innerText = 'Update Cloud'; $('cancelBtn2').classList.remove('hidden'); renExp(); calc2(); window.scrollTo(0,0);
    }
    window.editMode2 = (on) => { editId2 = null; $('saveBtn2').innerText = 'Save'; $('cancelBtn2').classList.add('hidden'); exp = []; $('miscSale').value = 0; renExp(); setNow2(); calc2(); }
    window.saveCap = async () => { await setDoc(doc(db2, "settings", "capital"), { p: val('pCap'), m: val('mCap') }); }
    function calcCapStatus() {
      const tot = val('pCap') + val('mCap'), prof = h2.reduce((s, r) => s + (r.prof || 0), 0);
      setT('cumProfit', fmt(prof)); setT('totCap', fmt(tot)); setT('remCap', fmt(Math.max(0, tot - prof)));
    }
    function toast(m) { const el = $('toast'); el.className = 's show'; el.innerText = m; setTimeout(() => el.classList.remove('show'), 3000); }
    
    // --- PDF GENERATION ---
    window.genPDF = () => {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4'); 

        const reportType = $('repType').value;
        const dateLabel = reportType === 'monthly' ? $('mPick').value : 
                          (reportType === 'yearly' ? $('yPick').value : 'Custom Range');

        doc.setFontSize(18);
        doc.text(`STARBITE PRODUCTION REPORT - ${dateLabel.toUpperCase()}`, 14, 15);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 22);

        // Prep Data DYNAMICALLY
        const prodNames = products.map(p => p.n);
        const tableHeaders = [["Date", ...prodNames, "Sales (N)", "Exp (N)", "Profit (N)"]];
        
        const tableRows = h2.sort((a, b) => new Date(b.iso) - new Date(a.iso)).map(r => {
          const row = [r.dt];
          // Fill dynamic product columns
          products.forEach(p => {
              const it = r.items.find(x => x.id === p.id);
              row.push(it ? it.q : '-');
          });
          row.push(r.tot.toLocaleString());
          row.push((r.exp || []).reduce((s, x) => s + x.a, 0).toLocaleString());
          row.push(r.prof.toLocaleString());
          return row;
        });

        doc.autoTable({
          head: tableHeaders,
          body: tableRows,
          startY: 30,
          theme: 'grid',
          headStyles: { fillColor: [30, 64, 175] }, 
          styles: { fontSize: 8 },
          margin: { top: 30 }
        });

        const finalY = doc.lastAutoTable.finalY + 10;
        const totalSales = h2.reduce((s, r) => s + (r.tot || 0), 0);
        const totalProf = h2.reduce((s, r) => s + (r.prof || 0), 0);

        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text(`Total Period Sales: N${totalSales.toLocaleString()}`, 14, finalY);
        doc.text(`Total Period Profit: N${totalProf.toLocaleString()}`, 14, finalY + 7);

        doc.save(`Starbite_Report_${dateLabel}.pdf`);
        toast('PDF Downloaded');

      } catch (error) {
        console.error("PDF Error:", error);
        alert("PDF Error: Check console or ensure data exists.");
      }
    };

    // --- CSV EXPORT ---
    window.expCSV = () => {
      try {
        let csv = "Date,Sales,Profit,Expenses\n";
        h2.forEach(r => {
           const e = (r.exp || []).reduce((s, x) => s + x.a, 0);
           csv += `${r.dt},${r.tot},${r.prof},${e}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'starbite_data.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        alert("CSV Error");
      }
    }
    
    window.wipe2 = async () => { if (confirm('Clear Cloud?')) { const snap = await getDocs(collection(db2, "records")); snap.forEach(d => deleteDoc(doc(db2, "records", d.id))); } }
    initProd();

    // ==========================================
    // APP 3 JS (CHARGING)
    // ==========================================
    const config3 = {
      apiKey: "AIzaSyD-VJwcuv1FghZLMwaYIhfegRtwEwySPik",
      authDomain: "starbite-8fbeb.firebaseapp.com",
      projectId: "starbite-8fbeb",
      storageBucket: "starbite-8fbeb.firebasestorage.app",
      messagingSenderId: "258782985692",
      appId: "1:258782985692:web:d6667b25878b91cbd6a319"
    };
    const app3 = initializeApp(config3, "chargeApp");
    const db3 = getFirestore(app3);
    const col3 = collection(db3, "tickets");

    let tData3 = [], editId3 = null, chartInstance = null;

    onSnapshot(query(col3, orderBy("ts", "desc")), (snap) => {
      tData3 = snap.docs.map(d => ({ ...d.data(), id: d.id, jsDate: d.data().ts ? d.data().ts.toDate() : new Date() }));
      render3();
      renderChart();
    });

    // NEW: Logic to find next available sockets (Multiple for one ticket)
    function getNextSockets(neededCount) {
        // Collect all used socket numbers
        const usedSockets = new Set();
        tData3.filter(t => !t.collected && t.status === 'charging' && t.sockets).forEach(t => {
            // t.sockets stores a string like "1, 2"
            const s = t.sockets.toString().split(',').map(n => Number(n.trim()));
            s.forEach(num => usedSockets.add(num));
        });

        const assigned = [];
        let current = 1;
        while(assigned.length < neededCount) {
            if(!usedSockets.has(current)) {
                assigned.push(current);
            }
            current++;
        }
        return assigned.join(', ');
    }

    window.saveTicket = async () => {
      const name = $('custName').value.trim(); if(!name) return alert("Name required");
      const payStatus = document.querySelector('input[name="payStatus"]:checked').value;
      
      const ph = +$('phCount').value;
      const pb = +$('pbCount').value;
      const ch = +$('chCount').value;
      const slotsNeeded = ph + pb; // ONLY PHONES AND POWERBANKS NEED SOCKETS

      let sockets = $('socketNum').value; // In case editing
      
      // If new ticket, calculate next sockets based on item count
      if(!editId3) sockets = getNextSockets(slotsNeeded);

      const data = { name, code: Math.floor(1000 + Math.random() * 9000), ph, pb, ch, price: +$('price3').value, collected: false, payStatus, sockets, status: 'charging' };
      
      if(editId3) { await updateDoc(doc(db3, "tickets", editId3), data); cancelEdit3(); }
      else { const dRef = await addDoc(col3, { ...data, charged: false, ts: serverTimestamp() }); resetForm3(); openPrintModal(dRef.id, data, data.code); }
    };

    window.startEdit3 = (id) => {
      const t = tData3.find(x => x.id === id); editId3 = id;
      $('custName').value = t.name; $('phCount').value = t.ph; $('pbCount').value = t.pb; $('chCount').value = t.ch; $('price3').value = t.price;
      $('socketNum').value = t.sockets || '';
      
      // SET RADIO BUTTON
      const radios = document.getElementsByName('payStatus');
      if(t.payStatus === 'later') radios[1].checked = true; else radios[0].checked = true;

      $('formAction').innerText = "Editing Ticket"; $('saveBtn3').innerText = "üíæ UPDATE"; $('cancelEditBtn3').style.display = "block";
    };
    window.cancelEdit3 = () => { 
        editId3 = null; resetForm3(); 
        $('formAction').innerText = "New Customer"; $('saveBtn3').innerText = "‚úÖ START CHARGING"; $('cancelEditBtn3').style.display = "none";
        // Reset radio
        document.getElementsByName('payStatus')[0].checked = true;
    };
    
    // ---- UPDATED: RUN QUICK COLLECT (SMART SEARCH) ----
    window.runQuickCollect = async () => {
      const codeVal = $('quickCode').value.trim();
      if(!codeVal) return alert("Please enter a code");

      // Find active ticket (Either charging OR on shelf)
      const target = tData3.find(t => t.code == codeVal && !t.collected);

      if(!target) {
        alert("‚ùå Ticket not found active!");
        return;
      }
      
      // Determine Message based on status
      let locMsg = "";
      if(target.status === 'shelf') {
          locMsg = `üì¶ It is FULLY CHARGED.\nGet from SHELF.`;
      } else {
          locMsg = `‚ö° It is still CHARGING.\nGet from SOCKETS: ${target.sockets}`;
      }

      if(confirm(`FOUND: ${target.name}\n${locMsg}\n\nMark as COLLECTED now?`)) {
          // Automatically mark as collected
          await updateDoc(doc(db3, "tickets", target.id), {
             collected: true,
             collDate: new Date().toLocaleDateString()
          });
          alert("‚úÖ Marked Collected!");
      }
      $('quickCode').value = ''; // Reset input
    };
    
    // ---- NEW: REPORTS FUNCTIONALITY ----
    window.openReportModal = () => {
        $('modalReport').style.display = 'flex';
        calcReport('daily'); // Default to daily
    };
    
    window.calcReport = (type) => {
        // Handle UI
        ['btnRepD', 'btnRepW', 'btnRepM'].forEach(b => $(b).classList.remove('active'));
        if(type==='daily') $('btnRepD').classList.add('active');
        if(type==='weekly') $('btnRepW').classList.add('active');
        if(type==='monthly') $('btnRepM').classList.add('active');
        
        const now = new Date();
        const filtered = tData3.filter(t => {
            // Note: We only sum collected revenue, but we can count total devices even if pending
            if(!t.collected) return false; 
            
            const d = t.jsDate;
            if(type === 'daily') {
                return d.getDate() === now.getDate() && 
                       d.getMonth() === now.getMonth() && 
                       d.getFullYear() === now.getFullYear();
            }
            if(type === 'weekly') {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(now.getDate() - 7);
                return d >= oneWeekAgo;
            }
            if(type === 'monthly') {
                return d.getMonth() === now.getMonth() && 
                       d.getFullYear() === now.getFullYear();
            }
        });
        
        const rev = filtered.reduce((a,b) => a + (b.price||0), 0);
        const ph = filtered.reduce((a,b) => a + (b.ph||0), 0);
        const pb = filtered.reduce((a,b) => a + (b.pb||0), 0);
        const ch = filtered.reduce((a,b) => a + (b.ch||0), 0);
        
        $('repRevenue').innerText = "‚Ç¶" + rev.toLocaleString();
        $('repTotalDev').innerText = (ph + pb + ch);
        $('repCustCount').innerText = filtered.length;
        $('repBreakdown').innerText = `üì±${ph} | üîã${pb} | üîå${ch}`;
    };
    // ----------------------------------------
    
    // NEW: VISUAL CHART LOGIC
    function renderChart() {
        if(!tData3.length) return;
        
        // Aggregate last 7 days revenue
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const today = new Date();
        const labels = [], data = [];
        
        for(let i=6; i>=0; i--) {
            const d = new Date(today);
            d.setDate(today.getDate() - i);
            const dStr = d.toLocaleDateString();
            
            labels.push(days[d.getDay()]);
            
            // Sum collected revenue for this day
            const dailyTotal = tData3
                .filter(t => t.collected && t.collDate === dStr)
                .reduce((sum, t) => sum + (t.price || 0), 0);
            data.push(dailyTotal);
        }

        const ctx = document.getElementById('revChart');
        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Revenue (‚Ç¶)',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    window.render3 = () => {
      const term = $('histSearch').value.toLowerCase();
      const active = tData3.filter(t => !t.collected);
      const history = tData3.filter(t => t.collected && (t.name.toLowerCase().includes(term) || (t.code+"").includes(term)));
      $('countActive').innerText = active.length;
      $('listActive').innerHTML = active.map(t => ticketHtml(t, false)).join('');
      $('listHistory').innerHTML = (term==="" ? history.slice(0,5) : history).map(t => ticketHtml(t, true)).join('');
      
      const today = new Date().toLocaleDateString();
      const cash = tData3.filter(t => t.collected && t.collDate === today).reduce((s, t) => s + (t.price || 0), 0);
      $('valCash').innerText = "‚Ç¶" + cash.toLocaleString();
      $('valPending').innerText = "‚Ç¶" + active.reduce((s, t) => s + (t.price || 0), 0).toLocaleString();
      $('valCount').innerText = tData3.filter(t => t.collected && t.collDate === today).reduce((s, t) => s + (t.ph||0) + (t.pb||0) + (t.ch||0), 0);
      updateTimers();
    }
    
    // UPDATED HTML to include DELETE button & SOCKET info & MOVE TO SHELF logic
    function ticketHtml(t, isH) {
      // Determine badge based on payment status
      const pBadge = t.payStatus === 'later' 
        ? `<span class="bg-red-500 text-white text-xs px-2 py-1 rounded ml-2">LATER</span>` 
        : `<span class="bg-green-500 text-white text-xs px-2 py-1 rounded ml-2">PAID</span>`;
      
      const sBadge = t.sockets ? `<span class="bg-gray-800 text-white text-xs px-2 py-1 rounded ml-1">üîå${t.sockets}</span>` : '';

      // ADDED DELETE BUTTON (Trash Can) HERE
      if(isH) return `<div class="ticket"><b>${t.name}</b> <span class="code-badge">#${t.code}</span><br><small>Out: ${t.collDate}</small> <div style="float:right"><button onclick="revert3('${t.id}')">‚Ü©Ô∏è</button> <button onclick="delTicket3('${t.id}')">üóëÔ∏è</button></div></div>`;
      
      // ACTIVE TICKET LOGIC (Shelf vs Socket)
      let actionBtn = "";
      let locDisplay = "";
      
      if(t.status === 'shelf') {
          // It's on shelf
          locDisplay = `<div class="bg-green-100 text-green-800 p-1 rounded text-xs font-bold text-center mt-1">üì¶ ON SHELF</div>`;
          actionBtn = `<button class="bg-blue-700 text-white px-3 py-1 rounded w-full" onclick="collect3('${t.id}')">Give to Owner</button>`;
      } else {
          // It's charging
           locDisplay = `<div class="bg-blue-50 text-blue-800 p-1 rounded text-xs font-bold text-center mt-1">‚ö° SOCKETS: ${t.sockets}</div>`;
           actionBtn = `<button class="bg-green-600 text-white px-3 py-1 rounded w-full" onclick="markFull('${t.id}')">üîã Done</button>`;
      }

      return `<div class="ticket ${t.status==='shelf'?'shelf-mode':''}"><div class="flex justify-between items-center"><div><b>${t.name}</b> <span class="code-badge">#${t.code}</span></div><div>${sBadge}${pBadge}</div></div>${locDisplay}<div class="timer-area"><span>In: ${t.jsDate.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span><span class="time-val" id="timer-${t.id}">0h 0m</span></div><small>üì±${t.ph}üîã${t.pb}üîå${t.ch} | ‚Ç¶${t.price}</small><div class="flex gap-2 mt-2"><button class="bg-black text-white px-3 py-1 rounded" onclick="openPrintModal('${t.id}')">üñ®Ô∏è</button><button class="bg-yellow-500 px-3 py-1 rounded" onclick="startEdit3('${t.id}')">‚úèÔ∏è</button>${actionBtn}</div></div>`;
    }
    
    // NEW: Mark as Full (Move to Shelf) - NO PROMPT
    window.markFull = async (id) => {
        await updateDoc(doc(db3, "tickets", id), { status: 'shelf' });
    }
    
    // NEW: Delete Function for Charging Tickets
    window.delTicket3 = async (id) => {
        if(!confirm("Delete ticket history?")) return;
        await deleteDoc(doc(db3, "tickets", id));
    }
    
    function updateTimers() {
      const now = new Date();
      tData3.filter(t => !t.collected).forEach(t => {
        const el = $(`timer-${t.id}`); if(!el) return;
        const diff = Math.floor((now - t.jsDate) / 60000);
        const h = Math.floor(diff/60), m = diff%60;
        el.innerText = `${h}h ${m}m`; if(h>=3) el.classList.add('danger');
      });
    }
    setInterval(updateTimers, 60000);
    
    window.openPrintModal = (id, data=null, newCode=null) => {
        let t = data, code = newCode;
        if(!t) { t = tData3.find(x => x.id === id); code = t.code; }
        const totalItems = (t.ph || 0) + (t.pb || 0) + (t.ch || 0);
        
        // --- UPDATED: Item Breakdown ---
        let itemListHtml = "";
        if((t.ph || 0) > 0) itemListHtml += `<div>- Phone: ${t.ph}</div>`;
        if((t.pb || 0) > 0) itemListHtml += `<div>- Powerbank: ${t.pb}</div>`;
        if((t.ch || 0) > 0) itemListHtml += `<div>- Charger: ${t.ch}</div>`;
        
        // Add status to receipt
        const payTxt = t.payStatus === 'later' ? '(PAY LATER)' : '(PAID)';
        const socketTxt = t.sockets ? `<br><b>SOCKETS: ${t.sockets}</b>` : '';

        let stickers = ""; for(let i=0; i<totalItems; i++) stickers += `<div class="sticker">#${code}</div>`;
        
        $('receiptPreview').innerHTML = `
            <div class="font-bold">STARBITE CHARGING</div>
            <div>${new Date().toLocaleString()}</div>
            <div class="r-code-box"><div class="r-code-text">#${code}</div></div>
            <div class="text-left">
                <b>Customer:</b> ${t.name.toUpperCase()}<br>
                <div style="margin: 5px 0; border-bottom:1px dashed #ccc; padding-bottom:5px;">
                   ${itemListHtml}
                </div>
                ${socketTxt}<br>
                <b>TOTAL: ‚Ç¶${t.price}</b><br>
                <span style="font-size:12px; font-weight:bold">${payTxt}</span>
            </div>
            <div style="font-size:10px; font-weight:bold; margin-top:10px; text-align:center;">
                Check device before leaving.
            </div>
            <div class="r-cut-line"></div>
            <div class="sticker-container">${stickers}</div>`;
            
        $('modalPrint').style.display = 'flex';
    };
    
    window.collect3 = async (id) => { if(confirm("Mark Collected?")) await updateDoc(doc(db3, "tickets", id), { collected: true, collDate: new Date().toLocaleDateString() }); };
    window.revert3 = async (id) => { await updateDoc(doc(db3, "tickets", id), { collected: false }); };
    function resetForm3() { $('custName').value = ""; $('phCount').value = 1; $('pbCount').value = 0; $('chCount').value = 0; $('price3').value = 200; $('socketNum').value = ""; }
    const upSt = () => { $('status').className = navigator.onLine ? "status-bar on" : "status-bar off"; $('status').innerText = navigator.onLine ? "CONNECTED" : "OFFLINE"; };
    window.addEventListener('online', upSt); window.addEventListener('offline', upSt); upSt();
  </script>
</body>
                                                          </html>
