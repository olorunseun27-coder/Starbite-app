<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Starbite App V73 (Image Uploader)</title>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        /* --- GLOBAL & THEME VARIABLES --- */
        :root { 
            --bg: #f4f7f6; 
            --text: #333; 
            --box: #fff; 
            --border: #ddd; 
            --primary: #6f42c1; /* Starbite Purple */
            --green: #28a745;
            --red: #dc3545;
            --orange: #fd7e14;
            --blue: #007bff;
        }
        body.dark-mode { 
            --bg: #121212; 
            --text: #e0e0e0; 
            --box: #1e1e1e; 
            --border: #333; 
            --primary: #9b72e6;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            transition: 0.3s; 
            padding-bottom: 80px; 
            overscroll-behavior-y: none;
        }

        /* --- TABS --- */
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- AUTH SCREEN --- */
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .auth-box { background: white; padding: 30px; border-radius: 10px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); color: #333; margin-bottom: 20px; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background: var(--green); color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .auth-link { color: #007bff; text-decoration: underline; cursor: pointer; font-size: 14px; display: block; margin-top: 20px; } 
        .hidden { display: none; }
        
        /* --- CUSTOMER SECTIONS (PROFESSIONAL) --- */
        #customerOrderSection { display: none; width: 100%; max-width: 500px; margin: 0 auto; padding: 15px; box-sizing: border-box; padding-bottom: 100px; }

        /* V71 NEW MENU GRID */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 0; }
        .menu-card { 
            background: white; 
            border: 1px solid #eee; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            position: relative; 
            overflow: hidden; 
            transition: 0.2s; 
            padding-bottom: 10px; /* Space for buttons */
        }
        
        /* V71 IMAGE STYLES */
        .menu-img-box {
            width: 100%;
            height: 110px;
            background: #f8f8f8;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .menu-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.3s;
        }
        .menu-card:active .menu-img { transform: scale(1.05); }

        /* Sold Out Logic */
        .menu-card.sold-out { opacity: 0.6; pointer-events: none; background: #f9f9f9; }
        .menu-card.sold-out::after { content: "SOLD OUT"; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--red); font-weight: bold; border: 2px solid var(--red); padding: 5px 10px; border-radius: 5px; opacity: 1; font-size: 12px; white-space: nowrap; z-index: 10; background: rgba(255,255,255,0.8); }

        .menu-icon { font-size: 40px; display: block; margin-top: 20px; } /* Fallback only */
        
        .menu-details { padding: 10px 8px 0 8px; }
        .menu-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: block; color: #333; height: 36px; display: flex; align-items: flex-start; justify-content: center; overflow: hidden; line-height: 1.2; }
        .menu-price { color: var(--green); font-weight: bold; font-size: 14px; display: block; margin-bottom: 10px; }
        
        .add-btn { width: 90%; margin: 0 auto; padding: 8px; border-radius: 20px; border: 1px solid var(--primary); background: white; color: var(--primary); font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; display:block; }
        .add-btn:active { background: var(--primary); color: white; }
        
        /* FLOATING CART BAR */
        #floatingCart { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #333; color: white; padding: 15px; border-radius: 50px; display: none; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 8000; cursor: pointer; animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes slideUp { from { bottom: -60px; } to { bottom: 20px; } }
        
        /* CHECKOUT SUMMARY */
        .checkout-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 14px; color: #333; }
        .checkout-total { display: flex; justify-content: space-between; padding: 15px 0; font-size: 18px; font-weight: bold; border-top: 2px solid #333; margin-top: 10px; color: #333; }

        .c-qty-btn { width:30px; height:30px; border-radius:50%; border:none; background:#eee; font-weight:bold; font-size:18px; color:#333; display:flex; align-items:center; justify-content:center; cursor: pointer; }
        
        /* QUANTITY INPUT BOX */
        .qty-input { width: 50px; text-align: center; border: 1px solid var(--primary); border-radius: 5px; padding: 5px; font-weight: bold; font-size: 16px; outline: none; background: #fff; color: #333; -moz-appearance: textfield; }
        .qty-input::-webkit-outer-spin-button, .qty-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- DASHBOARD --- */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 15px; background: var(--box); border-bottom: 1px solid var(--border); }
        .card { padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
        .card-green { background: rgba(40, 167, 69, 0.1); border-color: var(--green); }
        .card-red { background: rgba(220, 53, 69, 0.1); border-color: var(--red); }
        .card-purple { background: rgba(111, 66, 193, 0.1); border-color: var(--primary); }
        .card span { font-size: 16px; font-weight: bold; display:block; margin-top:5px; color: var(--text); }
        .card h4 { margin: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; color: var(--text); }

        /* --- FORMS & CONTAINERS --- */
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .box { background: var(--box); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: var(--box); color: var(--text); border: 1px solid var(--border); border-radius: 5px; box-sizing: border-box; outline: none; }
        
        /* --- BUTTONS --- */
        .btn-main { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-contact { background: var(--green); color: white; border: none; padding: 8px 12px; border-radius: 5px; display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px; }
        .btn-contact-manage { background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 5px; display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 13px; }
        
        /* --- TABLE & LISTS --- */
        table { width: 100%; border-collapse: collapse; background: var(--box); margin-top: 10px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text); }
        th { background: rgba(0,0,0,0.03); font-weight: 600; font-size: 12px; text-transform: uppercase; }
        
        .status-paid { color: #155724; background: #d4edda; padding: 4px 8px; border-radius: 4px; font-size: 11px; display:inline-block; font-weight: bold; }
        .status-owed { color: #721c24; background: #f8d7da; padding: 4px 8px; border-radius: 4px; font-size: 11px; display:inline-block; font-weight: bold; }
        
        .cust-link { color: var(--primary); font-weight:bold; cursor: pointer; text-decoration: underline; }
        
        /* --- ACTION ICONS --- */
        .action-btn { border:none; background:none; cursor:pointer; font-size:18px; padding:5px 8px; border-radius:5px; margin:0 2px; }
        .btn-pay { background: var(--green); color: white; border-radius: 50%; width: 30px; height: 30px; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-edit { color: #007bff; }
        .btn-del { color: var(--red); }

        /* --- BASKET --- */
        #basketBox { background: rgba(111, 66, 193, 0.05); padding: 10px; border-radius: 5px; margin-bottom: 15px; display:none; border: 1px solid rgba(111, 66, 193, 0.2); }
        .basket-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 14px; }
        .qty-ctrl { display: flex; align-items: center; gap: 5px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: none; background: #ddd; color: #333; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(2px); }
        .modal-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 400px; background: var(--box); color: var(--text); padding: 25px; border-radius: 12px; z-index: 2001; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 1px solid var(--border); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #777; }
        .modal-list { list-style:none; padding:0; margin:0; }
        .modal-list-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee; }
        
        /* --- REPORT GRID --- */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .report-btn { padding: 15px; border: 1px solid var(--border); background: var(--bg); border-radius: 8px; cursor: pointer; font-weight: bold; }
        .report-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- CHIPS --- */
        .chip-container { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .chip { background: var(--border); color: var(--text); padding: 5px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }

        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: var(--box); display: flex; justify-content: space-around; align-items: center; border-top: 2px solid var(--border); z-index: 1000; padding-bottom: env(safe-area-inset-bottom); display:none; }
        .nav-item { flex: 1; text-align: center; padding: 10px 0; color: #888; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; }

        /* --- MARKET SPECIFIC --- */
        .m-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 5px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; background: var(--box); color: var(--text); }
        .m-add-btn { width: 100%; padding: 14px; background: var(--green); color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .m-total { margin-top: 20px; padding: 10px; border-top: 2px solid var(--text); text-align: right; font-size: 1.4em; font-weight: bold; color: var(--green); }

        /* --- PRINT PDF STYLE --- */
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; }
        }

        /* --- TOAST --- */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 10000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }
    </style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-box" id="loginBox">
        <h2 id="authTitle" style="color:#333; margin-top:0; cursor:pointer;" ondblclick="toggleAdminReg()">Snack Manager</h2>
        
        <div id="regFields" class="hidden">
            <input type="text" id="regName" class="auth-input" placeholder="Full Name">
            <input type="tel" id="regPhone" class="auth-input" placeholder="Phone Number">
            <textarea id="regAddress" class="auth-input" rows="2" placeholder="Delivery Address"></textarea>
        </div>

        <input type="email" id="authEmail" class="auth-input" placeholder="Email Address">
        <input type="password" id="authPass" class="auth-input" placeholder="Password">
        
        <div id="adminRegBadge" style="display:none; color:red; font-size:12px; font-weight:bold;">‚ö†Ô∏è ADMIN REGISTRATION MODE</div>
        
        <button id="authActionBtn" class="auth-btn" onclick="handleAuth()">Login</button>
        
        <span class="auth-link" id="toggleAuth" onclick="toggleAuthMode()">Don't have an account? Sign Up</span>
        <span class="auth-link" style="margin-top:15px; font-size:12px; color:#777;" onclick="forgotPassword()">Forgot Password?</span>
    </div>
</div>

<div id="customerOrderSection">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div>
            <h2 style="margin:0; color:#333;">üëã Hi, <span id="welcomeName">User</span></h2>
            <p style="margin:0; font-size:12px; color:#777;">What are you craving today?</p>
        </div>
        
        <div style="display:flex; gap:5px;">
            <button onclick="window.openOrderHistory()" style="font-size:11px; background:var(--blue); color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer;">üìú History</button>
            <button onclick="logout()" style="font-size:11px; background:#f8d7da; color:#721c24; border:none; padding:5px 10px; border-radius:15px; cursor:pointer;">Logout</button>
        </div>
    </div>

    <input type="text" id="custMenuSearch" placeholder="üîç Search menu..." 
       style="width:100%; padding:12px; border:1px solid #ddd; border-radius:30px; margin-bottom:15px; text-align:center; box-sizing:border-box; outline:none; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"
       onkeyup="window.filterCustMenu()">

    <div id="menuGrid" class="menu-grid">
        <p style="grid-column: span 2; text-align:center; color:#777;">Loading delicious menu...</p>
    </div>
    
    <div style="height:60px;"></div>

    <div id="floatingCart" onclick="openCheckoutModal()">
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="background:white; color:#333; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;" id="cartCount">0</div>
            <span style="font-size:14px; font-weight:bold;">View Order</span>
        </div>
        <div style="font-weight:bold;">‚Ç¶<span id="cartTotalDisplay">0</span></div>
    </div>
</div>

<div id="checkoutModal" class="modal-box" style="display:none; max-height:85vh; overflow-y:auto; width:90%; max-width:450px;">
    <span class="close-btn" onclick="document.getElementById('checkoutModal').style.display='none'">&times;</span>
    <h3 style="margin-top:0;">üõçÔ∏è Review Order</h3>
    
    <div id="checkoutItemsList" style="margin-bottom:15px;"></div>
    
    <div style="margin-top:20px; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee;">
        <label style="font-size:12px; font-weight:bold; color:#555;">üìç Delivery Zone</label>
        <select id="deliveryZone" class="auth-input" onchange="updateCheckoutTotal()" style="margin-bottom:10px;">
            <option value="0">Pickup / Dine-in (No Charge)</option>
            <option value="500">Close Range (‚Ç¶500)</option>
            <option value="1000">Mid Range (‚Ç¶1,000)</option>
            <option value="2000">Far Range (‚Ç¶2,000)</option>
        </select>
        
        <label style="font-size:12px; font-weight:bold; color:#555;">üìù Special Note</label>
        <input type="text" id="checkoutNote" class="auth-input" placeholder="e.g. Extra spicy, don't ring bell">
        
        <div class="checkout-total">
            <span>Total to Pay:</span>
            <span>‚Ç¶<span id="finalCheckoutTotal">0</span></span>
        </div>
    </div>

    <div style="background:#e8f5e9; border:1px solid #c8e6c9; padding:12px; border-radius:8px; margin-top:15px; text-align:center;">
        <h4 style="margin:0 0 5px 0; color:#2e7d32; font-size:14px;">üí∞ Payment Details</h4>
        <p style="margin:0; font-size:13px;">Bank: <b>opay</b></p>
        <p style="margin:0; font-size:13px;">Acct Name: <b>Olorunleke s.samuel</b></p>
        <p style="margin:8px 0; font-size:20px; font-weight:bold; letter-spacing:2px; color:#333; background:white; display:inline-block; padding:5px 10px; border-radius:5px; border:1px dashed #28a745;">8148180535</p>
        <br>
        <small style="color:#555; font-size:11px;">Please transfer the total amount above.</small>
    </div>
    <button onclick="submitCustomerOrder()" id="confirmOrderBtn" class="auth-btn" style="margin-top:15px; background:var(--primary);">‚úÖ Notify Payment & Confirm Order</button>
</div>

<div id="snackManagerTab" class="tab-content">
    <div class="dashboard">
        <div class="card card-green" onclick="document.getElementById('reportModal').style.display='block'; window.calcDailyStats()">
            <h4>Total Cash</h4>
            <span id="totalCash">...</span>
        </div>
        <div class="card card-red">
            <h4>Total Debt</h4>
            <span id="totalDebt">...</span>
        </div>
        <div class="card card-purple" onclick="switchTab('ordersTab', 'nav-orders')">
            <h4>Inbox</h4>
            <span>üì¨ Orders <span id="orderBadge" class="order-badge">0</span></span>
        </div>
    </div>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span id="userEmailDisplay" style="font-size:12px; opacity:0.7; font-weight:bold;"></span>
            <button onclick="logout()" style="background:var(--red); color:white; border:none; padding:6px 12px; border-radius:15px; font-size:11px;">üö™ Logout</button>
        </div>

        <div class="box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0">üõí New Sale</h3>
                <button onclick="window.openModal()" style="background:#6f42c1; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:12px; cursor:pointer;">‚öôÔ∏è Manage Products</button>
            </div>
            
            <label style="font-size:11px; font-weight:bold; opacity:0.7;">Sale Date:</label>
            <input type="datetime-local" id="saleDate" style="margin-bottom:10px;">

            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="display:flex; gap:5px;">
                    <button class="btn-contact" onclick="pickContact()">üìñ Phonebook</button>
                    <button class="btn-contact-manage" onclick="window.openContacts()">üë• Manage</button>
                </div>
                <span style="font-size:11px; opacity:0.6; align-self:center;">Quick Picks:</span>
            </div>
            
            <div id="quickPicks" class="chip-container"></div>

            <div style="display:flex; gap:10px;">
                <input type="text" id="custName" placeholder="Customer Name" list="savedCustomers" style="flex:2" onchange="autoFillPhone()">
                <datalist id="savedCustomers"></datalist>
                <input type="tel" id="custPhone" placeholder="Phone (Optional)" style="flex:2">
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <select id="snackSelector" style="flex:3"><option value="">Select Snack...</option></select>
                <input type="number" id="inputQty" value="1" min="1" placeholder="Qty" style="flex:1; text-align:center; min-width: 60px; font-weight:bold; border: 2px solid var(--primary);">
                <button onclick="addToBasket()" style="flex:1; background:var(--primary); color:white; border:none; height:42px; border-radius:5px; font-size:20px; font-weight:bold; margin-bottom:12px;">+</button>
            </div>

            <div id="basketBox">
                <h4 style="margin:0 0 10px 0; font-size:13px; color:var(--primary);">Order List:</h4>
                <div id="basketList"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                    <button onclick="clearBasket()" style="color:var(--red); background:none; border:none; font-size:12px; cursor:pointer;">üóëÔ∏è Clear All</button>
                    <div style="font-weight:bold; font-size:18px;">Total: ‚Ç¶<span id="basketTotal">0</span></div>
                </div>

                <button onclick="shareReceipt()" style="width:100%; margin-top:10px; background:#25D366; border:none; color:white; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer;">üì≤ Send Bill via WhatsApp</button>
            </div>

            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            
            <div style="display:flex; gap:10px;">
                <select id="paymentStatus" style="margin-bottom:0;">
                    <option value="Paid">‚úÖ Paid Cash/Transfer</option>
                    <option value="Pay Later">‚ùå Pay Later (Debt)</option>
                </select>
                <button class="btn-main" onclick="pushSaleToFirebase()" style="flex:1;">SAVE</button>
            </div>
        </div>

        <h3 style="display:flex; justify-content:space-between; align-items:center;">
            History 
            <div style="display:flex; gap:5px;">
                <button onclick="window.openReportsModal()" style="background:var(--blue); color:white; border:none; border-radius:5px; font-size:11px; padding:5px 10px; margin-right:5px;">üìä Reports</button>
                <button onclick="window.calcDailyStats(); document.getElementById('reportModal').style.display='block'" style="background:var(--primary); color:white; border:none; border-radius:5px; font-size:11px; padding:5px 10px;">üìÖ Today</button>
                <button onclick="document.body.classList.toggle('dark-mode')" style="background:#333; color:white; border:none; border-radius:5px; font-size:11px; padding:5px 10px;">üåó</button>
            </div>
        </h3>
        <input type="search" id="searchBox" placeholder="üîç Search name..." oninput="renderTable()">
        
        <table id="salesTable">
            <thead><tr><th>Details</th><th>Items</th><th>Total</th><th>Actions</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="ordersTab" class="tab-content">
    <div class="container">
        <h2 style="text-align:center;">Incoming Orders</h2>
        <div id="incomingOrdersList" style="padding-bottom:20px;"></div>
    </div>
</div>

<div id="marketTab" class="tab-content">
    <div class="container">
        <div class="box">
            <h2 style="margin-top:0; text-align:center;">Market List</h2>
            <input type="text" id="m_productName" class="m-input" placeholder="Item Name (e.g. Flour)">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="m_productPrice" class="m-input" placeholder="Price">
                <input type="number" id="m_productQty" class="m-input" value="1" style="flex:0.5; min-width:60px;">
            </div>
            <button class="m-add-btn" id="m_addItemBtn">+ Add to List</button>

            <div style="display:flex; gap:10px; margin:15px 0;">
                <button onclick="window.downloadMarketPDF()" style="flex:1; background:var(--blue); color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">üìÑ Download PDF</button>
                <button onclick="window.openMarketHistory()" style="flex:1; background:var(--purple); color:var(--text); border:1px solid var(--border); padding:10px; border-radius:5px; cursor:pointer;">üìú History</button>
            </div>

            <table class="m-table" style="width:100%" id="marketTable">
                <thead><tr style="border-bottom:2px solid var(--border)"><th align="left">Item</th><th>Qty</th><th>Total</th><th></th></tr></thead>
                <tbody id="m_listBody"></tbody>
            </table>

            <div class="m-total">Total: ‚Ç¶<span id="m_grandTotal">0.00</span></div>
            <button id="m_saveBtn" onclick="window.saveMarketList()" style="width:100%; background:var(--green); color:white; border:none; padding:12px; border-radius:5px; margin-top:20px; cursor:pointer; font-weight:bold;">üíæ Save Record & Clear</button>
        </div>
    </div>
</div>

<div id="printableArea" style="display:none; padding:20px;">
    <h2 style="text-align:center;">Market List</h2>
    <p id="printDate" style="text-align:center;"></p>
    <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px;">
        <thead><tr><th style="padding:8px;">Item</th><th style="padding:8px;">Price</th><th style="padding:8px;">Qty</th><th style="padding:8px;">Total</th></tr></thead>
        <tbody id="printBody"></tbody>
        <tfoot><tr><td colspan="3" style="padding:8px; text-align:right; font-weight:bold;">Total:</td><td style="padding:8px; font-weight:bold;">‚Ç¶<span id="printTotal"></span></td></tr></tfoot>
    </table>
</div>

<div id="modalOverlay" class="modal-overlay"></div>

<div id="editMarketModal" class="modal-box" style="display:none;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>‚úèÔ∏è Edit Market Item</h3>
    <input type="hidden" id="editMktId">
    <label style="font-size:12px;">Name</label>
    <input type="text" id="editMktName" class="m-input">
    <div style="display:flex; gap:10px;">
        <div><label style="font-size:12px;">Price</label><input type="number" id="editMktPrice" class="m-input"></div>
        <div><label style="font-size:12px;">Qty</label><input type="number" id="editMktQty" class="m-input"></div>
    </div>
    <button class="btn-main" onclick="saveMarketItemEdit()">Update Item</button>
</div>

<div id="marketHistoryModal" class="modal-box" style="display:none;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>üìú Market History</h3>
    <div id="marketHistoryList" style="max-height:300px; overflow-y:auto;"></div>
</div>

<div id="orderHistoryModal" class="modal-box" style="display:none; width:90%; max-height:80vh; overflow-y:auto;">
    <span class="close-btn" onclick="document.getElementById('orderHistoryModal').style.display='none'; document.getElementById('modalOverlay').style.display='none'">&times;</span>
    <h3 style="margin-top:0;">üìú My Past Orders</h3>
    <p style="font-size:12px; color:#777; margin-bottom:15px;">Track your order status here.</p>
    <div id="historyListContent">Loading...</div>
</div>

<div id="dlReportModal" class="modal-box" style="display:none; text-align:center;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>üìä Record Center</h3>
    <p>Select period to download records:</p>
    <div class="report-grid">
        <div class="report-btn" onclick="setReportPeriod('daily')">Today</div>
        <div class="report-btn" onclick="setReportPeriod('weekly')">This Week</div>
        <div class="report-btn" onclick="setReportPeriod('monthly')">This Month</div>
        <div class="report-btn" onclick="setReportPeriod('yearly')">This Year</div>
    </div>
    <div id="reportSummary" style="font-size:13px; color:#666; margin-bottom:15px;"></div>
    <button id="dlBtn" class="btn-main" onclick="downloadCSV()" disabled style="background:#777;">Download CSV</button>
</div>

<div id="approveModal" class="modal-box" style="display:none; text-align:center;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>‚úÖ Approve Order</h3>
    <p style="font-size:14px; margin-bottom:20px;">Has the customer paid <b>‚Ç¶<span id="approveAmount">0</span></b>?</p>
    
    <div style="display:flex; flex-direction:column; gap:10px;">
        <button onclick="finishApproval('Paid')" style="background:var(--green); color:white; padding:15px; border:none; border-radius:5px; font-weight:bold; font-size:16px; cursor:pointer;">
            üí∞ YES - Paid (Cash/Transfer)
        </button>
        <button onclick="finishApproval('Pay Later')" style="background:var(--red); color:white; padding:15px; border:none; border-radius:5px; font-weight:bold; font-size:16px; cursor:pointer;">
            üìù NO - Pay Later (Debt)
        </button>
    </div>
</div>

<div id="editOrderModal" class="modal-box" style="display:none;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>‚úèÔ∏è Edit Order</h3>
    <input type="hidden" id="editOrderId">
    
    <label style="font-size:12px;font-weight:bold;">Customer Name</label>
    <input type="text" id="editOrderName">
    
    <label style="font-size:12px;font-weight:bold;">Phone</label>
    <input type="text" id="editOrderPhone">
    
    <label style="font-size:12px;font-weight:bold;">Items</label>
    <textarea id="editOrderItems" rows="3"></textarea>
    
    <label style="font-size:12px;font-weight:bold;">Special Note</label>
    <textarea id="editOrderNote" rows="2"></textarea>
    
    <label style="font-size:12px;font-weight:bold;">Total Price (‚Ç¶)</label>
    <input type="number" id="editOrderTotal">
    
    <button class="btn-main" onclick="saveOrderChanges()">üíæ Save Changes</button>
</div>

<div id="menuModal" class="modal-box" style="display:none">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>‚öôÔ∏è Manage Products</h3>
    <p style="font-size:12px; opacity:0.7;">Add new snacks or remove old ones.</p>
    
    <input type="text" id="newItemName" placeholder="Snack Name (e.g. Meat Pie)">
    <input type="number" id="newItemPrice" placeholder="Price (‚Ç¶)">
    
    <label style="font-size:12px; font-weight:bold; display:block; margin-top:10px;">üì∏ Upload Image (Optional)</label>
    <input type="file" id="newItemImg" accept="image/*" style="font-size:12px; background:#f9f9f9;">
    
    <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px; background:#f9f9f9; padding:10px; border-radius:5px; margin-top:10px;">
        <input type="checkbox" id="newItemAvail" checked style="width:auto; margin:0;">
        <label for="newItemAvail" style="font-size:13px; font-weight:bold;">Item is Available (In Stock)</label>
    </div>

    <button id="addProdBtn" class="btn-main" style="background:var(--green);" onclick="addSnackToFirebase()">+ Add Product</button>
    
    <h4 style="margin:15px 0 5px 0; border-bottom:1px solid #eee; padding-bottom:5px;">Current Menu</h4>
    <div style="max-height: 200px; overflow-y: auto;">
        <ul id="menuListUL" class="modal-list"></ul>
    </div>
</div>

<div id="contactsModal" class="modal-box" style="display:none">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>üë• Saved Contacts</h3>
    <p style="font-size:12px; opacity:0.7;">Click to select, or delete to remove.</p>
    <div style="max-height: 300px; overflow-y: auto;">
        <ul id="contactsListUL" class="modal-list"></ul>
    </div>
</div>

<div id="debtModal" class="modal-box" style="display:none">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>üìã Pending Debts</h3>
    <p style="font-size:14px;">Customer: <strong id="debtCustName"></strong></p>
    <div style="background:#fff4f4; border:1px solid #f8d7da; border-radius:5px; padding:10px; max-height:250px; overflow-y:auto; margin-bottom:15px; color:#333;">
        <table style="margin:0;">
            <tbody id="debtListBody"></tbody>
        </table>
    </div>
    <h2 style="text-align:right; margin:10px 0; color:var(--red);">Total: ‚Ç¶<span id="debtTotalVal">0</span></h2>
    <button onclick="shareDebtProfile()" style="width:100%; background:#25D366; color:white; border:none; padding:12px; border-radius:5px; font-weight:bold; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
        üì≤ Share Report via WhatsApp
    </button>
</div>

<div id="editSaleModal" class="modal-box" style="display:none">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>‚úèÔ∏è Edit Sale Record</h3>
    <input type="hidden" id="editId">
    <div style="display:flex; gap:10px;">
        <div style="flex:1;">
            <label style="font-size:12px;font-weight:bold;">Name</label>
            <input type="text" id="editName">
        </div>
        <div style="flex:1;">
            <label style="font-size:12px;font-weight:bold;">Total (‚Ç¶)</label>
            <input type="number" id="editTotal">
        </div>
    </div>
    <label style="font-size:12px;font-weight:bold;">Date & Time</label>
    <input type="datetime-local" id="editDate">
    <label style="font-size:12px;font-weight:bold;">Items Description</label>
    <textarea id="editItems" rows="3" style="font-family:monospace; font-size:13px;"></textarea>
    <label style="font-size:12px;font-weight:bold;">Payment Status</label>
    <select id="editStatus">
        <option value="Paid">Paid</option>
        <option value="Pay Later">Pay Later</option>
    </select>
    <button class="btn-main" onclick="saveEditedSale()">Update Record</button>
</div>

<div id="reportModal" class="modal-box" style="display:none; text-align:center;">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h3>üìÖ Today's Report</h3>
    <p style="font-size:13px; opacity:0.7;">Sales made today <span id="reportDate"></span></p>
    <div style="display:flex; justify-content:space-around; margin: 20px 0;">
        <div><h2 id="todayCash" style="color:var(--green); margin:0;">‚Ç¶0</h2><small>Cash Collected</small></div>
        <div><h2 id="todayDebt" style="color:var(--red); margin:0;">‚Ç¶0</h2><small>Pending Debt</small></div>
    </div>
    <div style="background:rgba(0,0,0,0.05); padding:10px; border-radius:8px; text-align:left;">
        <strong>Top Seller Today:</strong> <span id="todayTopItem">None</span>
    </div>
</div>

<div class="bottom-nav">
    <div id="nav-manager" class="nav-item active" onclick="switchTab('snackManagerTab', 'nav-manager')">
        <i>üìã</i> Manager
    </div>
    <div id="nav-orders" class="nav-item" onclick="switchTab('ordersTab', 'nav-orders')">
        <i>üì¨</i> Orders <span id="navBadge" class="order-badge"></span>
    </div>
    <div id="nav-market" class="nav-item" onclick="switchTab('marketTab', 'nav-market')">
        <i>üõí</i> Market
    </div>
</div>

<div id="toast">Notification</div>

<script type="module">
    // --- IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, getDoc, getDocs, setDoc, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyDj7Rqwjij9y8PLWT1I_1klamMWNWbVV0A",
      authDomain: "starbite-supplier.firebaseapp.com",
      projectId: "starbite-supplier",
      storageBucket: "starbite-supplier.firebasestorage.app",
      messagingSenderId: "939042301342",
      appId: "1:939042301342:web:903f81c713644a7258228f",
      measurementId: "G-JB2DCKZ11G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- EMAILJS INIT ---
    // STEP 1: REPLACE 'YOUR_PUBLIC_KEY' BELOW
    emailjs.init("vzvGJIBXA7tWlRyta"); 

    // --- STATE VARIABLES ---
    let currentBasket = [];
    let salesData = [];
    let menuData = [];
    let customerData = [];
    let marketData = []; 
    let incomingOrders = [];
    let isRegisterMode = false;
    let isAdminReg = false;
    let currentDebtViewName = "";
    
    // Approval Vars
    window.tempOrderData = null;
    
    // Global Customer Order State
    window.custOrder = {};
    window.currentCustomer = null;
    window.ordersMap = {}; 
    window.custMenuRef = {};
    window.cartSubtotal = 0;
    
    // Report Vars
    let filteredReportData = [];
    
    // --- NAVIGATION LOGIC ---
    window.switchTab = (tabId, navId) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById(navId).classList.add('active');
    };

    // --- INITIALIZATION ---
    window.onload = function() { setNowForInput('saleDate'); };
    function setNowForInput(id) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const el = document.getElementById(id);
        if(el) el.value = now.toISOString().slice(0,16);
    }

    window.showToast = (msg) => {
        const x = document.getElementById("toast");
        x.innerText = msg; x.className = "show";
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- AUTHENTICATION & ROUTING ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // Check Role Logic
            try {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const role = userData.role || 'customer';
                    
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('userEmailDisplay').innerText = user.email;

                    if(role === 'admin' || role === 'staff') {
                        // Show Admin Dashboard
                        document.getElementById('snackManagerTab').classList.add('active');
                        document.querySelector('.bottom-nav').style.display = 'flex';
                        loadAdminData(); // Only load admin data if admin
                    } else {
                        // Customer Logic: Added email to local state for notifications
                        window.currentCustomer = { 
                            name: userData.name, 
                            phone: userData.phone, 
                            address: userData.address,
                            email: user.email 
                        };
                        document.getElementById('welcomeName').innerText = userData.name.split(' ')[0];
                        document.getElementById('customerOrderSection').style.display = 'block';
                        loadPublicMenu(); // Only load menu
                    }
                } else {
                    // Fallback if user doc missing (assume customer)
                    alert("Profile incomplete. Please contact support.");
                    signOut(auth);
                }
            } catch(e) {
                console.error("Auth Error", e);
                alert("Login Error: " + e.message);
                signOut(auth);
            }
        } else {
            document.getElementById('authOverlay').style.display = 'flex';
            // Reset Views
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.getElementById('customerOrderSection').style.display = 'none';
            document.querySelector('.bottom-nav').style.display = 'none';
        }
    });

    window.toggleAdminReg = () => {
        isAdminReg = !isAdminReg;
        document.getElementById('adminRegBadge').style.display = isAdminReg ? 'block' : 'none';
        if(isAdminReg && !isRegisterMode) toggleAuthMode(); // Auto switch to signup
    }

    window.handleAuth = function() {
        const email = document.getElementById('authEmail').value;
        const pass = document.getElementById('authPass').value;
        const btn = document.getElementById('authActionBtn');

        if(!email || !pass) { alert("Please enter both email and password."); return; }
        
        btn.innerText = "Processing..."; 
        btn.disabled = true;

        if(isRegisterMode) {
            // REGISTER
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const address = document.getElementById('regAddress').value;

            // Validation for Customers
            if(!isAdminReg && (!name || !phone)) {
                alert("Please enter Name and Phone.");
                btn.disabled = false; btn.innerText = "Sign Up";
                return;
            }

            const role = isAdminReg ? "staff" : "customer"; 

            createUserWithEmailAndPassword(auth, email, pass)
                .then(async (cred) => {
                    try { 
                        // Save User Profile
                        await setDoc(doc(db, "users", cred.user.uid), { 
                            email: email, 
                            role: role,
                            name: name || "Admin",
                            phone: phone || "",
                            address: address || ""
                        }); 
                        // Also save to contacts if customer
                        if(role === 'customer') {
                             const safeId = name.replace(/\s+/g, '_').toLowerCase();
                             await setDoc(doc(db, "contacts", safeId), {name:name, phone:phone}, {merge:true});
                        }
                    } catch(e) { console.error(e); }
                    alert("Account Created!");
                    // Reload to trigger AuthStateChanged
                    location.reload();
                })
                .catch((e) => { 
                    alert("Error: " + e.message); 
                    btn.innerText = "Sign Up"; 
                    btn.disabled = false; 
                });
        } else {
            // LOGIN
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {})
                .catch((e) => { 
                    alert("Login Failed: " + e.message); 
                    btn.innerText = "Login"; 
                    btn.disabled = false; 
                });
        }
    }

    window.toggleAuthMode = function() {
        isRegisterMode = !isRegisterMode;
        document.getElementById('authActionBtn').disabled = false;
        document.getElementById('authActionBtn').innerText = isRegisterMode ? "Sign Up" : "Login";
        document.getElementById('authTitle').innerText = isRegisterMode ? "Create Account" : "Login";
        document.getElementById('toggleAuth').innerText = isRegisterMode ? "Have an account? Login" : "Don't have an account? Sign Up";
        
        // Toggle Registration Fields
        const fields = document.getElementById('regFields');
        if(isRegisterMode) fields.classList.remove('hidden'); else fields.classList.add('hidden');
    }

    window.logout = function() { signOut(auth); location.reload(); }
    window.forgotPassword = function() {
        const email = document.getElementById('authEmail').value;
        if(!email) { alert("Please enter your email address in the box first."); return; }
        sendPasswordResetEmail(auth, email)
            .then(()=>alert("Password reset link sent to your email!"))
            .catch(e=>alert("Error: " + e.message));
    }

    // --- CUSTOMER MENU LOGIC (V71 - REAL IMAGES) ---
    // High-quality public placeholder images for demo.
    const snackImages = {
        "meat pie": "https://images.unsplash.com/photo-1572383672419-ab47799639dd?auto=format&fit=crop&w=500&q=80",
        "chicken pie": "https://images.unsplash.com/photo-1572383672419-ab47799639dd?auto=format&fit=crop&w=500&q=80",
        "egg roll": "https://images.unsplash.com/photo-1541167760496-1628856ab772?auto=format&fit=crop&w=500&q=80",
        "puff": "https://images.unsplash.com/photo-1541167760496-1628856ab772?auto=format&fit=crop&w=500&q=80",
        "donut": "https://images.unsplash.com/photo-1551024709-8f23befc6f87?auto=format&fit=crop&w=500&q=80",
        "doughnut": "https://images.unsplash.com/photo-1551024709-8f23befc6f87?auto=format&fit=crop&w=500&q=80",
        "sausage": "https://images.unsplash.com/photo-1626097725166-d866415cea92?auto=format&fit=crop&w=500&q=80",
        "hot dog": "https://images.unsplash.com/photo-1626097725166-d866415cea92?auto=format&fit=crop&w=500&q=80",
        "rice": "https://images.unsplash.com/photo-1598515214211-3d8c11f07cc1?auto=format&fit=crop&w=500&q=80",
        "chicken": "https://images.unsplash.com/photo-1626082927389-6cd097cdc6ec?auto=format&fit=crop&w=500&q=80",
        "drink": "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=500&q=80",
        "coke": "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?auto=format&fit=crop&w=500&q=80",
        "water": "https://images.unsplash.com/photo-1564419320461-6870880221ad?auto=format&fit=crop&w=500&q=80"
    };

    function getProductImage(name) {
        const lower = name.toLowerCase();
        for (const [key, url] of Object.entries(snackImages)) {
            if (lower.includes(key)) return url;
        }
        return null; // Return null to trigger emoji fallback
    }

    function getFallbackIcon(name) {
        const n = name.toLowerCase();
        if(n.includes('pie')) return 'ü•ß';
        if(n.includes('roll')) return 'üåØ';
        if(n.includes('donut') || n.includes('puff')) return 'üç©';
        if(n.includes('drink') || n.includes('coke') || n.includes('water')) return 'ü•§';
        if(n.includes('chicken')) return 'üçó';
        if(n.includes('rice')) return 'üçõ';
        return 'ü•™';
    };

    function loadPublicMenu() {
        onSnapshot(collection(db, "menu"), (snap) => {
            const grid = document.getElementById('menuGrid');
            if(snap.empty) {
                grid.innerHTML = "<p style='grid-column:span 2; text-align:center;'>Menu is currently empty.</p>";
                return;
            }
            grid.innerHTML = "";
            window.custMenuRef = {};
            
            snap.forEach(d => {
                const i = d.data();
                window.custMenuRef[d.id] = i;
                
                const isAvail = i.isAvailable !== false; 
                const soldOutClass = isAvail ? '' : 'sold-out';
                const btnText = isAvail ? 'Add' : 'Sold Out';
                const btnState = isAvail ? `onclick="addToCustCart('${d.id}')"` : 'disabled';
                
                // Determine Image: PRIORITIZE DB IMAGE (BASE64) OR FALLBACK TO HELPER
                const imgUrl = i.imageUrl || getProductImage(i.name);
                
                let visualContent = '';
                if(imgUrl) {
                    visualContent = `<div class="menu-img-box"><img src="${imgUrl}" class="menu-img" alt="${i.name}"></div>`;
                } else {
                    visualContent = `<span class="menu-icon">${getFallbackIcon(i.name)}</span>`;
                }

                grid.innerHTML += `
                <div class="menu-card ${soldOutClass}">
                    ${visualContent}
                    <div class="menu-details">
                        <span class="menu-title">${i.name}</span>
                        <span class="menu-price">‚Ç¶${i.price}</span>
                        
                        <button class="add-btn" id="btn_${d.id}" ${btnState}>${btnText}</button>
                        
                        <div id="ctrl_${d.id}" style="display:none; align-items:center; justify-content:center; gap:5px;">
                            <button class="c-qty-btn" onclick="adjustCustQty('${d.id}', -1)">-</button>
                            
                            <input type="number" id="inp_${d.id}" class="qty-input" value="0" 
                                onfocus="this.select()" 
                                oninput="window.manualCustQty('${d.id}', this.value)" 
                                onblur="window.blurQty('${d.id}')">
                            
                            <button class="c-qty-btn" onclick="adjustCustQty('${d.id}', 1)">+</button>
                        </div>
                    </div>
                </div>`;
            });
            updateCartUI(); 
        }, (error) => { console.error("Menu Load Error:", error); });
    }

    // --- CART & CHECKOUT LOGIC ---
    window.addToCustCart = (id) => {
        if(!window.custOrder[id]) window.custOrder[id] = 0;
        window.adjustCustQty(id, 1);
    }

    // 1. Handle Buttons
    window.adjustCustQty = (id, delta) => {
        if(!window.custOrder[id]) window.custOrder[id] = 0;
        window.custOrder[id] += delta;
        
        const input = document.getElementById('inp_' + id);
        if(input) input.value = window.custOrder[id]; // Sync Input

        checkItemState(id);
        updateCartUI();
    }
    
    // 2. Handle Typing
    window.manualCustQty = (id, val) => {
        let qty = parseInt(val);
        if(isNaN(qty) || qty < 0) qty = 0;
        window.custOrder[id] = qty;
        updateCartUI();
    }
    
    // 3. Handle Blur (Exit Input)
    window.blurQty = (id) => {
        if(!window.custOrder[id] || window.custOrder[id] <= 0) {
            window.custOrder[id] = 0;
            // Reset UI to 'Add' button
            document.getElementById('btn_'+id).style.display = 'block';
            document.getElementById('ctrl_'+id).style.display = 'none';
        }
    }
    
    // --- NEW SEARCH FILTER LOGIC ---
    window.filterCustMenu = () => {
        const input = document.getElementById('custMenuSearch');
        const filter = input.value.toLowerCase();
        const grid = document.getElementById('menuGrid');
        const cards = grid.getElementsByClassName('menu-card');

        for (let i = 0; i < cards.length; i++) {
            const title = cards[i].getElementsByClassName('menu-title')[0];
            const txtValue = title.textContent || title.innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                cards[i].style.display = "";
            } else {
                cards[i].style.display = "none";
            }
        }
    }

    function checkItemState(id) {
        if(window.custOrder[id] < 0) window.custOrder[id] = 0;
        
        const btn = document.getElementById('btn_'+id);
        const ctrl = document.getElementById('ctrl_'+id);
        const input = document.getElementById('inp_'+id);
        
        if(btn && ctrl && input) {
            if(window.custOrder[id] > 0) {
                btn.style.display = 'none';
                ctrl.style.display = 'flex';
                input.value = window.custOrder[id];
                // Visual feedback for selected item could be added here
            } else {
                btn.style.display = 'block';
                ctrl.style.display = 'none';
            }
        }
    }

    window.updateCartUI = () => {
        let totalQty = 0;
        let totalPrice = 0;
        
        for (const [id, qty] of Object.entries(window.custOrder)) {
            if (qty > 0 && window.custMenuRef[id]) {
                totalQty += qty;
                totalPrice += (window.custMenuRef[id].price * qty);
            }
        }
        
        const cartBar = document.getElementById('floatingCart');
        if(totalQty > 0) {
            cartBar.style.display = 'flex';
            document.getElementById('cartCount').innerText = totalQty;
            document.getElementById('cartTotalDisplay').innerText = totalPrice.toLocaleString();
        } else {
            cartBar.style.display = 'none';
        }
    }

    window.openCheckoutModal = () => {
        const list = document.getElementById('checkoutItemsList');
        list.innerHTML = "";
        let subtotal = 0;
        
        for (const [id, qty] of Object.entries(window.custOrder)) {
            if (qty > 0 && window.custMenuRef[id]) {
                const item = window.custMenuRef[id];
                const lineTotal = item.price * qty;
                subtotal += lineTotal;
                list.innerHTML += `
                <div class="checkout-row">
                    <span>${item.name} <small>x${qty}</small></span>
                    <span>‚Ç¶${lineTotal.toLocaleString()}</span>
                </div>`;
            }
        }
        
        window.cartSubtotal = subtotal;
        updateCheckoutTotal();
        document.getElementById('checkoutModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block'; 
    }

    window.updateCheckoutTotal = () => {
        const deliveryFee = parseInt(document.getElementById('deliveryZone').value) || 0;
        const total = (window.cartSubtotal || 0) + deliveryFee;
        document.getElementById('finalCheckoutTotal').innerText = total.toLocaleString();
    }

    // --- SUBMIT ORDER WITH EMAIL NOTIFICATION ---
    window.submitCustomerOrder = async () => {
        if(!window.currentCustomer) { alert("Session Error. Please reload."); return; }
        
        const btn = document.getElementById('confirmOrderBtn');
        btn.innerText = "Sending...";
        btn.disabled = true;

        const note = document.getElementById('checkoutNote').value;
        const deliveryFee = parseInt(document.getElementById('deliveryZone').value) || 0;
        const deliverySel = document.getElementById('deliveryZone');
        const deliveryText = deliverySel.options[deliverySel.selectedIndex].text;
        
        let items = [];
        let itemsString = "";
        for (const [id, qty] of Object.entries(window.custOrder)) {
            if (qty > 0 && window.custMenuRef[id]) {
                let txt = `${window.custMenuRef[id].name} (${qty})`;
                items.push(txt);
                itemsString += txt + "\n";
            }
        }

        if(items.length === 0) {
            btn.innerText = "Confirm Order";
            btn.disabled = false;
            return;
        }

        const total = (window.cartSubtotal || 0) + deliveryFee;

        try {
            // 1. Write to Firestore
            await addDoc(collection(db, "orders"), {
                custName: window.currentCustomer.name,
                custPhone: window.currentCustomer.phone,
                custAddress: window.currentCustomer.address,
                items: items.join(", "),
                note: note ? note + ` [${deliveryText}]` : `[${deliveryText}]`,
                total: total,
                deliveryFee: deliveryFee,
                status: "Pending",
                timestamp: serverTimestamp()
            });

            // 2. Send Notification via EmailJS
            // STEP 2: REPLACE 'YOUR_SERVICE_ID' and 'YOUR_TEMPLATE_ID'
            const templateParams = {
                customer_name: window.currentCustomer.name,
                customer_email: window.currentCustomer.email || "No Email",
                order_details: itemsString + "\nNote: " + (note || "None") + "\nTotal: ‚Ç¶" + total,
            };
            
            // This sends the email. 
            // If you removed the placeholders above, this will fail.
            try {
                await emailjs.send('service_4ahwty5', 'template_v6cbqrs', templateParams);
                console.log("Email Notification Sent");
            } catch (emailErr) {
                console.error("Email failed:", emailErr);
                // We don't stop the order if email fails, but we log it.
            }

            // 3. Reset UI
            window.custOrder = {};
            window.cartSubtotal = 0;
            updateCartUI();
            
            Object.keys(window.custMenuRef).forEach(id => {
                 const b = document.getElementById('btn_'+id);
                 const c = document.getElementById('ctrl_'+id);
                 if(b && c) { b.style.display='block'; c.style.display='none'; }
            });

            document.getElementById('checkoutModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            
            // 4. In-App Notification
            alert("‚úÖ Order Sent! Owner Notified.\nPlease check your bank app to complete payment.");
            
        } catch(e) { 
            alert("Error sending order: " + e.message); 
        } finally {
            btn.innerText = "‚úÖ Notify Payment & Confirm Order";
            btn.disabled = false;
        }
    }

    // --- NEW FEATURE: CUSTOMER HISTORY ---
    window.openOrderHistory = async () => {
        document.getElementById('orderHistoryModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
        const list = document.getElementById('historyListContent');
        list.innerHTML = "<p style='text-align:center;'>Loading your records...</p>";
        
        if(!window.currentCustomer || !window.currentCustomer.phone) {
            list.innerHTML = "<p style='color:red;'>Error: Could not identify your account. Please re-login.</p>";
            return;
        }

        try {
            const q = query(
                collection(db, "orders"), 
                where("custPhone", "==", window.currentCustomer.phone),
                orderBy("timestamp", "desc")
            );
            const snap = await getDocs(q);
            
            if(snap.empty) {
                list.innerHTML = "<p style='text-align:center; color:#777;'>You haven't placed any orders yet.</p>";
                return;
            }
            
            list.innerHTML = "";
            snap.forEach(d => {
                const o = d.data();
                const date = o.timestamp ? o.timestamp.toDate().toLocaleString() : "Unknown Date";
                
                let statusColor = '#6c757d'; 
                let statusIcon = 'üïí';
                if(o.status === 'Approved') { statusColor = 'var(--green)'; statusIcon = '‚úÖ'; }
                if(o.status === 'Pending') { statusColor = '#fd7e14'; statusIcon = '‚è≥'; }
                if(o.status === 'Archived') { statusColor = '#dc3545'; statusIcon = 'üóëÔ∏è'; }

                list.innerHTML += `
                <div style="border:1px solid #eee; padding:12px; border-radius:10px; margin-bottom:10px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.03);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding-bottom:8px; border-bottom:1px dashed #eee;">
                        <span style="font-size:11px; font-weight:bold; color:#555;">${date}</span>
                        <span style="color:${statusColor}; font-weight:bold; font-size:12px; background:rgba(0,0,0,0.05); padding:3px 8px; border-radius:10px;">
                            ${statusIcon} ${o.status.toUpperCase()}
                        </span>
                    </div>
                    <div style="font-size:13px; color:#333; line-height:1.4; margin-bottom:8px;">${o.items}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        ${o.note ? `<span style="font-size:11px; background:#fff3cd; color:#856404; padding:2px 5px; border-radius:3px;">üìù Note added</span>` : '<span></span>'}
                        <span style="font-weight:bold; font-size:15px; color:var(--primary);">‚Ç¶${o.total.toLocaleString()}</span>
                    </div>
                </div>`;
            });
        } catch(e) {
            console.error(e);
            list.innerHTML = `<p style='color:red;'>Error loading history: ${e.message}</p>`;
        }
    }

    // --- ADMIN DATA LOADERS ---
    function loadAdminData() {
        // MENU LISTENER
        onSnapshot(collection(db, "menu"), (snap) => {
            menuData = [];
            const sel = document.getElementById('snackSelector');
            const ul = document.getElementById('menuListUL');
            const currentSel = sel.value;
            sel.innerHTML = '<option value="">Select Snack...</option>';
            ul.innerHTML = '';
            snap.forEach(d => {
                const i = d.data(); menuData.push({id:d.id, ...i});
                sel.innerHTML += `<option value="${d.id}">${i.name} - ‚Ç¶${i.price}</option>`;
                ul.innerHTML += `<li class="modal-list-item">
                    <div style="display:flex; align-items:center; gap:8px;">
                        ${i.imageUrl ? `<img src="${i.imageUrl}" style="width:30px; height:30px; object-fit:cover; border-radius:4px;">` : '<span>üç≤</span>'}
                        <span>${i.name} (‚Ç¶${i.price}) ${i.isAvailable===false?'<b style="color:red">[SOLD OUT]</b>':''}</span>
                    </div>
                    <span style="color:red;cursor:pointer" onclick="window.delMenu('${d.id}')">üóëÔ∏è</span>
                </li>`;
            });
            if(currentSel) sel.value = currentSel;
        });

        // CONTACTS LISTENER
        onSnapshot(collection(db, "contacts"), (snap) => {
            customerData = [];
            const dl = document.getElementById('savedCustomers');
            dl.innerHTML = '';
            snap.forEach(d => {
                const c = d.data();
                customerData.push({id:d.id, ...c});
                dl.innerHTML += `<option value="${c.name}">`;
            });
            customerData.sort((a,b) => a.name.localeCompare(b.name));
            renderQuickPicks();
        });

        // SALES LISTENER
        onSnapshot(query(collection(db, "sales"), orderBy("timestamp", "desc")), (snap) => {
            salesData = []; let c=0, d=0;
            snap.forEach(doc => {
                const s = doc.data(); 
                let date = s.timestamp ? s.timestamp.toDate() : new Date();
                salesData.push({id:doc.id, ...s, dateObj: date});
                if(s.status === 'Paid') c+=s.total; else d+=s.total;
            });
            document.getElementById('totalCash').innerText = "‚Ç¶"+c.toLocaleString();
            document.getElementById('totalDebt').innerText = "‚Ç¶"+d.toLocaleString();
            renderTable();
        });
        
        // MARKET LISTENER (Shared DB)
        onSnapshot(collection(db, "market"), (snap) => {
            marketData = [];
            snap.forEach(d => { marketData.push({id: d.id, ...d.data()}); });
            renderMarketList();
        });

        // ORDERS LISTENER (NEW)
        onSnapshot(query(collection(db, "orders"), orderBy("timestamp", "desc")), (snap) => {
            incomingOrders = [];
            window.ordersMap = {}; // Reset Map
            let pendingCount = 0;
            const container = document.getElementById('incomingOrdersList');
            container.innerHTML = "";
            
            snap.forEach(doc => {
                const o = doc.data();
                const date = o.timestamp ? o.timestamp.toDate().toLocaleString() : "Just now";
                window.ordersMap[doc.id] = { id: doc.id, ...o };
                if(o.status === "Pending") pendingCount++;
                if(o.status !== "Archived") {
                    const noteHtml = o.note ? `<div style="background:#fff3cd; color:#856404; padding:5px; margin:5px 0; font-size:13px; border-radius:4px; border:1px solid #ffeeba;">üìù ${o.note}</div>` : '';
                    const addressHtml = o.custAddress ? `<div style="font-size:12px; color:#555; margin-bottom:5px;">üìç ${o.custAddress}</div>` : '';

                    container.innerHTML += `
                    <div class="box" style="border-left: 5px solid ${o.status==='Pending'?'var(--orange)':'var(--green)'}">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${o.custName}</b>
                            <small>${date}</small>
                        </div>
                        ${addressHtml}
                        <div style="margin:5px 0; color:#555;">${o.items}</div>
                        ${noteHtml}
                        <div style="font-weight:bold; margin-bottom:10px;">Total: ‚Ç¶${o.total.toLocaleString()}</div>
                        
                        ${o.status === 'Pending' ? `
                        <div style="display:flex; gap:10px;">
                            <a href="tel:${o.custPhone}" class="btn-contact" style="text-decoration:none; justify-content:center;">üìû Call</a>
                            <button class="btn-main" onclick="window.initApprove('${doc.id}', '${o.custName}', '${o.custPhone}', '${o.items}', ${o.total})" style="padding:8px; font-size:14px;">‚úÖ Approve</button>
                            <button class="action-btn" onclick="window.openEditOrder('${doc.id}')" style="background:#eee; padding:8px; border-radius:5px;">‚úèÔ∏è</button>
                            <button class="btn-del" onclick="window.archiveOrder('${doc.id}')" style="background:#eee; padding:8px; border-radius:5px;">üóëÔ∏è</button>
                        </div>` : `<span style="color:green; font-weight:bold;">‚úÖ Approved</span> <button onclick="window.archiveOrder('${doc.id}')" style="font-size:10px;">(Archive)</button>`}
                    </div>`;
                }
            });
            document.querySelectorAll('.order-badge').forEach(b => {
                b.innerText = pendingCount;
                b.style.display = pendingCount > 0 ? 'inline-block' : 'none';
            });
        });
    }

    // --- REPORT LOGIC ---
    window.openReportsModal = () => {
        document.getElementById('dlReportModal').style.display='block';
        document.getElementById('modalOverlay').style.display='block';
    }

    window.setReportPeriod = (type) => {
        const now = new Date();
        let start = new Date();
        document.querySelectorAll('.report-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if(type === 'daily') start.setHours(0,0,0,0);
        if(type === 'weekly') { const day = start.getDay() || 7; if(day !== 1) start.setHours(-24 * (day - 1)); start.setHours(0,0,0,0); }
        if(type === 'monthly') start.setDate(1);
        if(type === 'yearly') { start.setMonth(0); start.setDate(1); }
        filteredReportData = salesData.filter(s => s.dateObj >= start);
        let total = filteredReportData.reduce((sum, s) => sum + s.total, 0);
        document.getElementById('reportSummary').innerText = `Found ${filteredReportData.length} records. Total: ‚Ç¶${total.toLocaleString()}`;
        const btn = document.getElementById('dlBtn');
        if(filteredReportData.length > 0) { btn.disabled = false; btn.style.background = 'var(--primary)'; btn.innerText = `Download ${type.toUpperCase()} Report`; }
        else { btn.disabled = true; btn.style.background = '#777'; btn.innerText = "No Records Found"; }
    }

    window.downloadCSV = () => {
        if(filteredReportData.length === 0) return;
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
        csvContent += "Date,Time,Customer,Items,Total,Status\n";
        filteredReportData.forEach(row => {
            let date = row.dateObj.toLocaleDateString();
            let time = row.dateObj.toLocaleTimeString();
            let items = row.items.replace(/,/g, ";");
            csvContent += `${date},${time},${row.custName},"${items}",${row.total},${row.status}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "starbite_report.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.closeModal();
    }

    // --- TAB 1: MANAGER LOGIC ---
    window.viewCustomerDebt = (name) => {
        currentDebtViewName = name;
        const debts = salesData.filter(s => s.custName === name && s.status === 'Pay Later');
        if(debts.length === 0) { showToast("No pending debts for " + name); return; }
        const listBody = document.getElementById('debtListBody');
        listBody.innerHTML = ''; let total = 0;
        debts.forEach(d => {
            total += d.total;
            listBody.innerHTML += `<tr style="border-bottom:1px solid #eee;">
                <td style="padding:5px; font-size:12px;">${d.dateObj.toLocaleDateString()}</td>
                <td style="padding:5px; font-size:13px;">${d.items}</td>
                <td style="padding:5px; font-weight:bold;">‚Ç¶${d.total}</td>
            </tr>`;
        });
        document.getElementById('debtCustName').innerText = name;
        document.getElementById('debtTotalVal').innerText = total.toLocaleString();
        document.getElementById('debtModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    window.shareDebtProfile = () => {
        if(!currentDebtViewName) return;
        const debts = salesData.filter(s => s.custName === currentDebtViewName && s.status === 'Pay Later');
        if(debts.length === 0) return;
        let total = 0;
        let msg = `*DEBT REMINDER - STARBITE*\nHello ${currentDebtViewName}, here is a breakdown of outstanding items:\n\n`;
        debts.forEach(d => { total += d.total; msg += `üìÖ ${d.dateObj.toLocaleDateString()}\nüõí ${d.items}\nüí∞ ‚Ç¶${d.total}\n----------------\n`; });
        msg += `*TOTAL PENDING: ‚Ç¶${total.toLocaleString()}*`;
        const cust = customerData.find(c => c.name === currentDebtViewName);
        let url = `https://wa.me/` + (cust && cust.phone ? (cust.phone.startsWith('0') ? '234'+cust.phone.substring(1) : cust.phone) : "") + `?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }

    window.openContacts = () => {
        const ul = document.getElementById('contactsListUL'); ul.innerHTML = '';
        customerData.forEach(c => {
            ul.innerHTML += `<li class="modal-list-item"><span onclick="window.fillCust('${c.name}', '${c.phone}'); window.closeModal()" style="cursor:pointer; flex:1;">üë§ ${c.name}</span><span style="color:var(--red); cursor:pointer;" onclick="window.delContact('${c.id}')">üóëÔ∏è</span></li>`;
        });
        document.getElementById('contactsModal').style.display = 'block'; document.getElementById('modalOverlay').style.display = 'block';
    }

    window.delContact = async (id) => { if(confirm("Remove this contact?")) { await deleteDoc(doc(db, "contacts", id)); } }
    window.renderQuickPicks = function() {
        const div = document.getElementById('quickPicks'); div.innerHTML = '';
        customerData.slice(0, 8).forEach(c => { div.innerHTML += `<div class="chip" onclick="window.fillCust('${c.name}', '${c.phone}')">${c.name}</div>`; });
    }
    window.fillCust = (name, phone) => { document.getElementById('custName').value = name; document.getElementById('custPhone').value = phone || ""; }

    window.pushSaleToFirebase = async function() {
        const n=document.getElementById('custName').value, p=document.getElementById('custPhone').value, st=document.getElementById('paymentStatus').value;
        const dateInput = document.getElementById('saleDate').value;
        if(!n || currentBasket.length===0) { showToast("Enter name and add items"); return; }
        let t=0, names=[];
        currentBasket.forEach(i=>{ t+=i.total; names.push(`${i.name} (${i.qty} @ ‚Ç¶${i.price})`); });
        let ts = dateInput ? new Date(dateInput) : serverTimestamp();
        try {
            await addDoc(collection(db, "sales"), { custName:n, custPhone:p, items:names.join(", "), total:t, status:st, timestamp:ts });
            const safeId = n.replace(/\s+/g, '_').toLowerCase();
            if(!customerData.find(c => c.id === safeId)) { await setDoc(doc(db, "contacts", safeId), {name:n, phone:p}, {merge:true}); }
            document.getElementById('custName').value=''; document.getElementById('custPhone').value=''; 
            window.clearBasket(); setNowForInput('saleDate'); showToast("Sale Saved Successfully!");
        } catch(e) { showToast("Error: " + e.message); }
    }
    
    // APPROVE ORDER LOGIC
    window.initApprove = (orderId, name, phone, items, total) => {
        window.tempOrderData = { id: orderId, name, phone, items, total };
        document.getElementById('approveAmount').innerText = total.toLocaleString();
        document.getElementById('approveModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    window.finishApproval = async (status) => {
        const o = window.tempOrderData;
        if(!o) return;
        try {
            await addDoc(collection(db, "sales"), { custName: o.name, custPhone: o.phone, items: o.items, total: o.total, status: status, timestamp: serverTimestamp() });
            const safeId = o.name.replace(/\s+/g, '_').toLowerCase();
            if(!customerData.find(c => c.id === safeId)) { await setDoc(doc(db, "contacts", safeId), {name:o.name, phone:o.phone}, {merge:true}); }
            await updateDoc(doc(db, "orders", o.id), { status: "Approved" });
            showToast(`Order Recorded as ${status}!`);
            window.closeModal(); window.tempOrderData = null;
        } catch(e) { showToast("Error: " + e.message); }
    }
    
    // EDIT ORDER LOGIC
    window.openEditOrder = (id) => {
        const order = window.ordersMap[id];
        if(!order) return;
        document.getElementById('editOrderId').value = id;
        document.getElementById('editOrderName').value = order.custName;
        document.getElementById('editOrderPhone').value = order.custPhone;
        document.getElementById('editOrderItems').value = order.items;
        document.getElementById('editOrderNote').value = order.note || "";
        document.getElementById('editOrderTotal').value = order.total;
        document.getElementById('editOrderModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    window.saveOrderChanges = async () => {
        const id = document.getElementById('editOrderId').value;
        try {
            await updateDoc(doc(db, "orders", id), {
                custName: document.getElementById('editOrderName').value,
                custPhone: document.getElementById('editOrderPhone').value,
                items: document.getElementById('editOrderItems').value,
                note: document.getElementById('editOrderNote').value,
                total: parseFloat(document.getElementById('editOrderTotal').value)
            });
            window.closeModal(); showToast("Order Updated Successfully");
        } catch(e) { showToast("Error updating: " + e.message); }
    }
    
    window.archiveOrder = async (id) => { if(confirm("Remove this order from list?")) { await updateDoc(doc(db, "orders", id), { status: "Archived" }); } }

    window.renderTable = function() {
        const tb = document.getElementById('tableBody');
        const sVal = document.getElementById('searchBox').value.toLowerCase();
        tb.innerHTML = '';
        salesData.forEach(i => {
            if(sVal && !i.custName.toLowerCase().includes(sVal)) return;
            let stCls = i.status==='Paid'?'status-paid':'status-owed';
            let stText = i.status==='Paid'?'‚úÖ Paid':'‚ùå Debt';
            let dateStr = i.dateObj.toLocaleDateString() + ' ' + i.dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            let payBtn = i.status === 'Pay Later' ? `<button class="action-btn btn-pay" onclick="window.markPaid('${i.id}')" title="Mark as Paid">üí∏</button>` : '';
            tb.innerHTML += `<tr>
                <td><b class="cust-link" onclick="window.viewCustomerDebt('${i.custName}')">${i.custName}</b><br><span style="font-size:11px; opacity:0.7;">${dateStr}</span></td>
                <td style="font-size:13px; opacity:0.8;">${i.items}<br><span class="${stCls}">${stText}</span></td>
                <td style="font-weight:bold;">‚Ç¶${i.total.toLocaleString()}</td>
                <td style="white-space:nowrap;">${payBtn} <button class="action-btn btn-edit" onclick="window.openEdit('${i.id}')">‚úèÔ∏è</button> <button class="action-btn btn-del" onclick="window.delSale('${i.id}')">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    window.markPaid = async (id) => { if(confirm("Confirm: Has the customer paid this debt?")) { await updateDoc(doc(db, "sales", id), { status: "Paid" }); showToast("Debt Cleared!"); } }
    
    window.openEdit = (id) => {
        const sale = salesData.find(s => s.id === id); if(!sale) return;
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = sale.custName;
        document.getElementById('editTotal').value = sale.total;
        document.getElementById('editItems').value = sale.items; 
        document.getElementById('editStatus').value = sale.status;
        if(sale.dateObj) { document.getElementById('editDate').value = new Date(sale.dateObj.getTime() - sale.dateObj.getTimezoneOffset() * 60000).toISOString().slice(0, 16); }
        document.getElementById('editSaleModal').style.display = 'block'; document.getElementById('modalOverlay').style.display = 'block';
    }

    window.saveEditedSale = async () => {
        const id = document.getElementById('editId').value, name = document.getElementById('editName').value;
        if(!id || !name) return;
        try {
            await updateDoc(doc(db, "sales", id), { 
                custName: name, 
                total: Number(document.getElementById('editTotal').value), 
                items: document.getElementById('editItems').value, 
                status: document.getElementById('editStatus').value,
                timestamp: new Date(document.getElementById('editDate').value)
            });
            window.closeModal(); showToast("Record Updated!");
        } catch(e) { showToast("Error: " + e.message); }
    }
    
    window.delSale = async (id) => { if(confirm("Delete record?")) await deleteDoc(doc(db,"sales",id)); }
    
    // --- ADD ITEM LOGIC (WITH IMAGE TO TEXT COMPRESSOR) ---
    // 1. Helper: Resize Image & Convert to Base64 Text
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300; // Small thumbnail size
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // Return text string
                }
            }
        });
    }

    // 2. Main Add Function
    window.addSnackToFirebase = async () => {
        const btn = document.getElementById('addProdBtn');
        btn.innerText = "Saving..."; btn.disabled = true;

        const n = document.getElementById('newItemName').value;
        const p = document.getElementById('newItemPrice').value;
        const avail = document.getElementById('newItemAvail').checked;
        const fileInput = document.getElementById('newItemImg');

        if(n && p) { 
            let imageBase64 = null;
            // Check if user selected an image
            if (fileInput.files && fileInput.files[0]) {
                try {
                    // Convert picture to text code
                    imageBase64 = await compressImage(fileInput.files[0]);
                } catch(e) {
                    console.error("Image error", e);
                }
            }

            await addDoc(collection(db,"menu"), {
                name: n, 
                price: Number(p),
                isAvailable: avail,
                imageUrl: imageBase64 // Save the text string here
            }); 
            
            document.getElementById('newItemName').value=''; 
            document.getElementById('newItemPrice').value=''; 
            document.getElementById('newItemImg').value=''; // Clear file input
            showToast("Item Added"); 
        }
        btn.innerText = "+ Add Product"; btn.disabled = false;
    }

    window.delMenu = async (id) => { if(confirm("Delete item?")) await deleteDoc(doc(db,"menu",id)); }
    
    window.addToBasket = () => {
        const sel = document.getElementById('snackSelector'), qtyInput = document.getElementById('inputQty');
        let qty = Number(qtyInput.value);
        if(!sel.value) { showToast("Select an item first"); return; }
        if(qty < 1) qty = 1; 
        const item = menuData.find(i => i.id === sel.value);
        const existing = currentBasket.find(x => x.id === item.id);
        if(existing) { existing.qty += qty; existing.total = existing.price * existing.qty; } 
        else { currentBasket.push({id: item.id, name:item.name, price:item.price, qty:qty, total:item.price * qty}); }
        updBasket(); sel.value = ""; qtyInput.value = "1"; sel.focus();
    }

    window.changeQty = (idx, delta) => {
        currentBasket[idx].qty += delta;
        if(currentBasket[idx].qty <= 0) currentBasket.splice(idx, 1); 
        else currentBasket[idx].total = currentBasket[idx].price * currentBasket[idx].qty;
        updBasket();
    }

    window.updBasket = () => {
        const box=document.getElementById('basketBox'), lst=document.getElementById('basketList');
        if(currentBasket.length===0){box.style.display='none';return;}
        box.style.display='block'; lst.innerHTML=''; let tot=0;
        currentBasket.forEach((i, idx) => { 
            tot+=i.total; 
            lst.innerHTML+=`<div class="basket-item"><div style="flex:2;"><b>${i.name}</b><br><span style="font-size:11px; opacity:0.7">@‚Ç¶${i.price}</span></div><div class="qty-ctrl"><button class="qty-btn" onclick="window.changeQty(${idx}, -1)">-</button><span style="width:20px; text-align:center;">${i.qty}</span><button class="qty-btn" onclick="window.changeQty(${idx}, 1)">+</button></div><div style="flex:1; text-align:right;">‚Ç¶${i.total.toLocaleString()}</div></div>`; 
        });
        document.getElementById('basketTotal').innerText=tot.toLocaleString();
    }
    window.clearBasket = () => { currentBasket=[]; updBasket(); }
    
    window.shareReceipt = () => {
        const n = document.getElementById('custName').value, p = document.getElementById('custPhone').value;
        if(currentBasket.length === 0) { showToast("Basket is empty!"); return; }
        let msg = `*RECEIPT - STARBITE*\nCustomer: ${n || 'Guest'}\n----------------\n`, total = 0;
        currentBasket.forEach(i => { msg += `${i.name} (x${i.qty} @ ‚Ç¶${i.price}): ‚Ç¶${i.total}\n`; total += i.total; });
        msg += `----------------\n*TOTAL: ‚Ç¶${total.toLocaleString()}*\nDate: ${new Date().toLocaleDateString()}`;
        let url = `https://wa.me/` + (p ? (p.startsWith('0') ? '234'+p.substring(1) : p) : "") + `?text=${encodeURIComponent(msg)}`;
        window.open(url, '_blank');
    }

    window.calcDailyStats = () => {
        const today = new Date().toDateString();
        document.getElementById('reportDate').innerText = today;
        let c=0, d=0, itemsMap={};
        salesData.forEach(s => {
            if(s.dateObj.toDateString() === today) {
                if(s.status === 'Paid') c+=s.total; else d+=s.total;
                s.items.split(', ').forEach(itemStr => { let name = itemStr.split('(')[0]; itemsMap[name] = (itemsMap[name] || 0) + 1; });
            }
        });
        let topItem = "None", max = 0;
        for(let [k,v] of Object.entries(itemsMap)) { if(v > max) { max = v; topItem = k; } }
        document.getElementById('todayCash').innerText = "‚Ç¶"+c.toLocaleString();
        document.getElementById('todayDebt').innerText = "‚Ç¶"+d.toLocaleString();
        document.getElementById('todayTopItem').innerText = topItem + (max>0 ? ` (${max} sales)` : "");
    }

    window.autoFillPhone = () => {
        const val=document.getElementById('custName').value;
        const f=customerData.find(c=>c.name===val);
        if(f) document.getElementById('custPhone').value=f.phone;
    }
    
    window.pickContact = async function() {
        if ('contacts' in navigator && 'ContactsManager' in window) {
            try {
                const contacts = await navigator.contacts.select(['name', 'tel'], { multiple: false });
                if (contacts[0]) {
                    if (contacts[0].name) document.getElementById('custName').value = contacts[0].name[0];
                    if (contacts[0].tel) document.getElementById('custPhone').value = contacts[0].tel[0].replace(/[\s-]/g, '');
                }
            } catch (ex) { console.log(ex); }
        } else { showToast("Contact picker not supported on this device."); }
    };

    window.openModal = () => { document.getElementById('modalOverlay').style.display='block'; document.getElementById('menuModal').style.display='block'; }
    window.closeModal = () => { document.querySelectorAll('.modal-box, .modal-overlay').forEach(m => m.style.display='none'); }

    // --- TAB 2: MARKET LOGIC ---
    window.renderMarketList = () => {
        const tbody = document.getElementById('m_listBody');
        tbody.innerHTML = "";
        let total = 0;
        marketData.forEach((item) => {
            const sub = item.price * item.qty;
            total += sub;
            tbody.insertAdjacentHTML('beforeend', `
            <tr style="border-bottom:1px solid #eee">
                <td>${item.name}<br><small>@${item.price}</small></td>
                <td align="center">${item.qty}</td>
                <td align="right">‚Ç¶${sub.toFixed(2)}</td>
                <td align="right"><button class="m-del-btn" onclick="window.openEditMarket('${item.id}')" style="color:var(--blue); background:none; border:none; cursor:pointer;">‚úèÔ∏è</button> <button class="m-del-btn" onclick="window.delMarketItem('${item.id}')" style="color:var(--red); background:none; border:none; cursor:pointer;">X</button></td>
            </tr>`);
        });
        document.getElementById('m_grandTotal').innerText = total.toFixed(2);
    }

    const mAddBtn = document.getElementById('m_addItemBtn');
    if(mAddBtn) {
        mAddBtn.addEventListener('click', async () => {
            const name = document.getElementById('m_productName').value;
            const price = parseFloat(document.getElementById('m_productPrice').value);
            const qty = parseInt(document.getElementById('m_productQty').value);
            if (!name || isNaN(price)) return;
            await addDoc(collection(db, "market"), { name, price, qty });
            document.getElementById('m_productName').value = "";
            document.getElementById('m_productPrice').value = "";
        });
    }

    window.delMarketItem = async (id) => { await deleteDoc(doc(db, "market", id)); }

    window.openEditMarket = (id) => {
        const item = marketData.find(m => m.id === id);
        if(!item) return;
        document.getElementById('editMktId').value = id;
        document.getElementById('editMktName').value = item.name;
        document.getElementById('editMktPrice').value = item.price;
        document.getElementById('editMktQty').value = item.qty;
        document.getElementById('editMarketModal').style.display='block';
        document.getElementById('modalOverlay').style.display='block';
    }

    window.saveMarketItemEdit = async () => {
        const id = document.getElementById('editMktId').value;
        const name = document.getElementById('editMktName').value;
        const price = parseFloat(document.getElementById('editMktPrice').value);
        const qty = parseInt(document.getElementById('editMktQty').value);
        await updateDoc(doc(db, "market", id), { name, price, qty });
        window.closeModal();
    }

    window.saveMarketList = async () => {
        if(marketData.length === 0) { showToast("List is empty!"); return; }
        if(confirm("Save this list to history and clear it?")) {
            const batchId = new Date().toISOString();
            const total = marketData.reduce((sum, i) => sum + (i.price*i.qty), 0);
            await addDoc(collection(db, "market_history"), {
                date: serverTimestamp(),
                total: total,
                items: marketData.map(i => `${i.name} (${i.qty})`).join(", ")
            });
            const snap = await getDocs(collection(db, "market"));
            snap.forEach(d => deleteDoc(doc(db, "market", d.id)));
            showToast("Market List Archived!");
        }
    }

    window.openMarketHistory = () => {
        const listDiv = document.getElementById('marketHistoryList');
        listDiv.innerHTML = "Loading...";
        document.getElementById('marketHistoryModal').style.display='block';
        document.getElementById('modalOverlay').style.display='block';
        import("https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js").then(async mod => {
            const q = mod.query(mod.collection(db, "market_history"), mod.orderBy("date", "desc"), mod.limit(20));
            const snap = await mod.getDocs(q);
            listDiv.innerHTML = "";
            if(snap.empty) { listDiv.innerHTML = "No history found."; return; }
            snap.forEach(d => {
                const h = d.data();
                const date = h.date ? h.date.toDate().toLocaleDateString() : "Unknown";
                listDiv.innerHTML += `
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>üìÖ ${date}</span>
                        <span>‚Ç¶${h.total.toLocaleString()}</span>
                    </div>
                    <div style="font-size:12px; color:#555; margin-top:5px;">${h.items}</div>
                </div>`;
            });
        });
    }

    window.downloadMarketPDF = () => {
        if(marketData.length === 0) { showToast("List is empty!"); return; }
        const tbody = document.getElementById('printBody');
        tbody.innerHTML = "";
        let total = 0;
        marketData.forEach(item => {
            const sub = item.price * item.qty;
            total += sub;
            tbody.innerHTML += `<tr>
                <td style="padding:8px;">${item.name}</td>
                <td style="padding:8px;">‚Ç¶${item.price}</td>
                <td style="padding:8px;">${item.qty}</td>
                <td style="padding:8px;">‚Ç¶${sub}</td>
            </tr>`;
        });
        document.getElementById('printTotal').innerText = total.toLocaleString();
        document.getElementById('printDate').innerText = new Date().toLocaleString();
        window.print();
    }
</script>
</body>
                    </html>
